<!DOCTYPE html>
<html>
<head>
  <title>Market Dashboard</title>
  <%- include('partials/head') %>

  <!-- =========================================================
       Chart.js
       - Used only for visualisation (mini trend sparkline).
       - MAS note: This does NOT execute trades or give advice.
       ========================================================= -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --nav-height: 64px;
      --ticker-height: 44px;
    }

    body{
      margin:0;
      background:#0b0b0b;
      color:#eee;
      font-family:"Inter", Arial, sans-serif;
    }

    .nav{
      height: var(--nav-height);
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 28px;
      background:rgba(15,15,15,0.95);
      border-bottom:1px solid #222;
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter: blur(6px);
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      font-weight:700;
      letter-spacing:0.5px;
      font-size:18px;
      color:#00eaff;
    }

    .nav-links{
      display:flex;
      gap:16px;
      align-items:center;
    }

    .nav-links a{
      color:#ddd;
      text-decoration:none;
      font-size:14px;
      padding:8px 12px;
      border-radius:8px;
      border:1px solid transparent;
      transition:0.2s;
    }

    .nav-links a:hover{
      border:1px solid #2a2a2a;
      background:#121212;
    }

    .cta{
      background:#00eaff;
      color:#000 !important;
      font-weight:700;
    }

    .ticker-wrap{
      position: sticky;
      top: 0;
      z-index:15;

      height: var(--ticker-height);
      display:flex;
      align-items:center;

      background:#0f0f0f;
      border-bottom:1px solid #222;
      overflow:hidden;
      white-space:nowrap;
      box-shadow: 0 10px 18px rgba(0,0,0,0.25);
    }

    .ticker{
      display:inline-flex;
      align-items:center;
      gap:20px;
      padding:10px 28px;
      will-change: transform;
      animation: ticker-scroll 22s linear infinite;
    }

    .ticker-wrap:hover .ticker{
      animation-play-state: paused;
    }

    @keyframes ticker-scroll{
      from{ transform: translateX(0); }
      to{ transform: translateX(-50%); }
    }

    .ticker-item{
      display:inline-flex;
      align-items:baseline;
      gap:10px;
      padding-right:18px;
      border-right:1px solid rgba(255,255,255,0.08);
      min-width: 190px;
    }

    .ticker-sym{ font-weight:800; color:#eaeaea; font-size:14px; }
    .ticker-price{ font-weight:800; color:#fff; font-size:14px; }
    .ticker-chg{ font-weight:700; font-size:12px; }
    .t-up{ color:#4caf50; }
    .t-down{ color:#e53935; }

    .hero{
      padding:32px 28px 16px;
      max-width:1200px;
      margin:auto;
    }

    .hero h1{
      margin:0 0 10px;
      font-size:32px;
      letter-spacing:0.2px;
    }

    .hero p{
      margin:0;
      color:#bdbdbd;
      max-width:820px;
      line-height:1.5;
      font-size:14px;
    }

    .mas-box{
      margin:18px 0 10px;
      background:#101010;
      border:1px solid #222;
      border-radius:14px;
      padding:16px 16px;
      display:grid;
      gap:10px;
    }

    .mas-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }

    .pill{
      font-size:12px;
      color:#bbb;
      border:1px solid #2a2a2a;
      padding:6px 10px;
      border-radius:999px;
      background:#0f0f0f;
    }

    details summary{
      cursor:pointer;
      list-style:none;
    }
    details summary::-webkit-details-marker{ display:none; }

    .mas-small{
      color:#bdbdbd;
      font-size:13px;
      line-height:1.5;
    }

    .grid{
      max-width:1200px;
      margin:14px auto 28px;
      padding:0 28px 28px;
      display:grid;
      grid-template-columns: 1.2fr 2fr;
      gap:18px;
    }

    .panel{
      background:#121212;
      border:1px solid #222;
      border-radius:16px;
      box-shadow:0 0 18px rgba(255,255,255,0.04);
      overflow:hidden;
    }

    .panel-header{
      padding:14px 16px;
      border-bottom:1px solid #222;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .panel-header h2{
      margin:0;
      font-size:14px;
      letter-spacing:0.3px;
      color:#eaeaea;
    }

    .panel-header span{
      font-size:12px;
      color:#999;
    }

    /*  Cards grid stays 2 columns, but 6 cards per page will show as 3 rows nicely */
    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(240px, 1fr));
      gap:14px;
      padding:14px;
    }

    .card{
      background:#161616;
      border:1px solid #222;
      border-radius:14px;
      padding:14px;
      transition:0.2s;
      min-height: 230px;
    }

    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 0 24px rgba(0, 234, 255, 0.08);
      border-color:#2a2a2a;
    }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .sym{
      font-size:16px;
      font-weight:700;
      margin:0;
      color:#00eaff;
      text-decoration:none;
    }

    .meta{
      color:#aaa;
      font-size:12px;
      margin-top:2px;
      margin-bottom: 6px;
    }

    .price{
      font-size:18px;
      font-weight:700;
      margin:0;
    }

    .chg{
      font-size:12px;
      margin-top:4px;
      font-weight:600;
    }

    .pos{ color:#4caf50; }
    .neg{ color:#e53935; }

    .actions{
      display:flex;
      gap:10px;
      margin-top:10px;
    }

    .btn{
      display:inline-block;
      text-decoration:none;
      font-size:12px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #2a2a2a;
      color:#ddd;
      background:#111;
      transition:0.2s;
    }

    .btn:hover{ background:#151515; }
    .purchase-btn{
      border:1px solid #00eaff;
    }
    .purchase-btn:hover{
      background:#0f1a1c;
    }


    .spark-wrap{
      height: 110px;
      margin-top: 6px;
    }
    .spark-wrap canvas{
      width: 100% !important;
      height: 100% !important;
      display:block;
    }

    .block{
      padding:14px;
      display:grid;
      gap:10px;
    }

    .section{
      background:#101010;
      border:1px solid #222;
      border-radius:14px;
      padding:12px;
    }

    .section-title{
      font-size:12px;
      letter-spacing:0.35px;
      color:#cfcfcf;
      margin:0 0 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .muted{
      color:#9a9a9a;
      font-size:12px;
      line-height:1.45;
    }

    .kv{
      display:grid;
      gap:8px;
    }

    .kv-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:#cfcfcf;
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .kv-row:last-child{ border-bottom:none; }

    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #2a2a2a;
      color:#bdbdbd;
      background:#0f0f0f;
      white-space:nowrap;
    }

    .footer{
      border-top:1px solid #222;
      padding:16px 28px;
      color:#999;
      font-size:12px;
      background:#0f0f0f;
    }

    /* News Item Styling */
    .news-item {
      background: #161616;
      padding: 24px;
      margin-bottom: 20px;
      border-radius: 12px;
      border-left: 5px solid #00eaff;
      position: relative;
      transition: 0.2s;
    }

    .news-item:hover {
      border-color: #00eaff;
      box-shadow: 0 0 24px rgba(0, 234, 255, 0.15);
    }

    .news-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 15px;
      margin-bottom: 14px;
    }

    .news-item h4 {
      margin: 0;
      color: #00eaff;
      font-size: 18px;
      flex: 1;
      font-weight: 600;
      line-height: 1.4;
    }

    .news-source {
      color: #aaa;
      font-size: 0.95rem;
      white-space: nowrap;
      padding: 5px 12px;
      background: rgba(0, 234, 255, 0.1);
      border-radius: 6px;
    }

    .news-item p {
      margin: 0 0 14px 0;
      color: #bdbdbd;
      font-size: 1rem;
      line-height: 1.6;
    }

    .news-actions {
      display: flex;
      gap: 12px;
      margin-top: 14px;
    }

    .btn-analyze-news {
      display: inline-block;
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: 0.2s;
    }

    .btn-analyze-news:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-save-news {
      display: inline-block;
      padding: 10px 20px;
      background: #00eaff;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: 0.2s;
    }

    .btn-save-news:hover {
      background: #00d4e8;
      transform: translateY(-2px);
    }

    .analysis-result {
      margin-top: 14px;
      padding: 16px;
      background: rgba(0, 234, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(0, 234, 255, 0.2);
      font-size: 0.95rem;
      color: #aaa;
      line-height: 1.5;
    }

    .trending-news-item {
      border-left: 5px solid #ff6b35;
      box-shadow: 0 0 24px rgba(255, 107, 53, 0.15);
    }
  </style>
</head>

<body>

  <%- include('partials/navbar') %>

  <div class="ticker-wrap" aria-label="Live market ticker">
    <div id="ticker" class="ticker"></div>
  </div>

  <div class="hero">
    <h1>Overview</h1>
    <p>
      A data-visualisation dashboard designed to help users understand market movements.
      It provides charts and summaries for learning and monitoring ‚Äî it does not automate trades or provide financial advice.
    </p>

    <div class="mas-box" id="mas">
      <div class="mas-title">
        <div style="display:flex; gap:10px; align-items:center;">
          <span class="pill">Transparency</span>
          <span class="pill">Explainability</span>
          <span class="pill">Human-in-the-loop</span>
          <span class="pill">No trade execution</span>
        </div>
      </div>

      <details>
        <summary class="mas-small">
          View disclosures: data sources, limitations, and user responsibility (click to expand)
        </summary>

        <div class="mas-small" style="margin-top:10px;">
          <strong>Disclaimer:</strong> StockAI is for informational/educational purposes only and does not provide financial advice.<br><br>

          <strong>Regulatory Note:</strong> This is a student prototype for learning. It is not a licensed trading platform and does not provide regulated financial services.<br><br>

          <strong>Data Sources:</strong> Live quotes via Finnhub; historical daily trend via Finnhub (if available) or Stooq (fallback); full charts via TradingView widgets.<br><br>

          <strong>How it works (Explainability):</strong> The mini chart shows historical closing prices. The ‚Äúlive‚Äù behaviour updates the latest chart point using the latest quote so users can monitor changes in near real-time.<br><br>

          <strong>Limitations:</strong> Data may be delayed, incomplete, or impacted by free-tier API limits / provider restrictions. Some tickers may return limited history or missing data.<br><br>

          <strong>No Automated Actions:</strong> StockAI does not execute trades or automate buying/selling. Users remain responsible for any decisions made using this dashboard.<br><br>

          <strong>Fair Use:</strong> Past performance shown on charts does not guarantee future results. Consult licensed professionals for investment advice.
        </div>
      </details>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <div class="panel-header">
        <h2>Market Tools & Context</h2>
        <span>View-only</span>
      </div>

      <div class="block">
        <div class="section">
          <div class="section-title">
            <span>Navigation</span>
            <span class="tag">No trade execution</span>
          </div>

          <div style="display:grid; gap:10px;">
            <a class="btn" href="/portfolio" style="text-align:center;">üìä Open Portfolio Dashboard</a>
            <a class="btn" href="/chart/AAPL" style="text-align:center;">üìà Open AAPL Full Chart</a>
            <a class="btn" href="/chart/TSLA" style="text-align:center;">üìâ Open TSLA Full Chart</a>

            <div class="muted" style="margin-top:2px;">
              <strong>Tip:</strong> Click any ticker card to open the full TradingView chart page.
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">
            <span>Market Snapshot (Current Page)</span>
            <span class="tag" id="lastUpdated">Updating‚Ä¶</span>
          </div>

          <%
            const items = Array.isArray(results) ? results : [];
            const ups = items.filter(x => Number(x?.quote?.dp) > 0).length;
            const downs = items.filter(x => Number(x?.quote?.dp) < 0).length;

            const sortedByDp = items
              .map(x => ({ symbol: x.symbol, dp: Number(x?.quote?.dp) }))
              .filter(x => Number.isFinite(x.dp))
              .sort((a,b) => b.dp - a.dp);

            const topGainer = sortedByDp.length ? sortedByDp[0] : null;
            const topLoser  = sortedByDp.length ? sortedByDp[sortedByDp.length - 1] : null;
          %>

          <div class="kv">
            <div class="kv-row">
              <span>Advancers / Decliners</span>
              <span><%= ups %> / <%= downs %></span>
            </div>
            <div class="kv-row">
              <span>Top gainer (this page)</span>
              <span><%= topGainer ? `${topGainer.symbol} (${topGainer.dp.toFixed(2)}%)` : "N/A" %></span>
            </div>
            <div class="kv-row">
              <span>Top loser (this page)</span>
              <span><%= topLoser ? `${topLoser.symbol} (${topLoser.dp.toFixed(2)}%)` : "N/A" %></span>
            </div>

            <!--  show both refresh values -->
            <div class="kv-row">
              <span>Card refresh</span>
              <span><span id="refreshMs">‚Äî</span> ms</span>
            </div>
            <div class="kv-row">
              <span>Ticker refresh</span>
              <span><span id="tickerRefreshMs">‚Äî</span> ms</span>
            </div>
          </div>

          <div class="muted" style="margin-top:8px;">
            Snapshot reflects the tickers shown on this page only (not the entire market).
          </div>
        </div>

        <div class="section">
          <div class="section-title">
            <span>How to Interpret</span>
            <span class="tag">Explainability</span>
          </div>

          <div class="muted">
            ‚Ä¢ Prices come from public data providers (may be delayed).<br>
            ‚Ä¢ Mini charts show historical closes (trend only).<br>
            ‚Ä¢ Latest point refreshes using the latest quote (near real-time monitoring).<br>
            ‚Ä¢ Charts are descriptive ‚Äî not recommendations.
          </div>
        </div>

        <div class="section">
          <div class="section-title">
            <span>Data Integrity & Limitations</span>
            <span class="tag">Transparency</span>
          </div>

          <div class="muted">
            ‚Ä¢ Free-tier APIs can rate-limit (missing/slow updates).<br>
            ‚Ä¢ Some tickers may have incomplete historical series.<br>
            ‚Ä¢ Past performance does not guarantee future results.<br><br>
            Users remain responsible for any decisions.
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <h2>Stocks</h2>
        <span>Page <%= page %> of <%= totalPages %></span>
      </div>

      <div class="cards">
        <% results.forEach(item => {  
          const change = item.quote?.d ?? 0;
          const percent = item.quote?.dp ?? 0;
          const price = item.quote?.c ?? 0;
          const cls = change > 0 ? "pos" : (change < 0 ? "neg" : "");
        %>

          <div class="card">
            <div class="row">
              <div>
                <a class="sym" href="/chart/<%= item.symbol %>"><%= item.symbol %></a>
                <div class="meta">Live quote + historical trend (sparkline)</div>
              </div>

              <div style="text-align:right;">
                <p class="price" id="price-<%= item.symbol %>">$<%= Number(price).toFixed(2) %></p>

                <div class="chg <%= cls %>" id="chg-<%= item.symbol %>">
                  <%= change > 0 ? "+" : "" %><%= Number(change).toFixed(2) %>
                  (<%= percent > 0 ? "+" : "" %><%= Number(percent).toFixed(2) %>%)
                </div>
              </div>
            </div>

            <div class="spark-wrap">
              <canvas id="chart-<%= item.symbol %>"></canvas>
            </div>

            <div class="actions">
              <a class="btn" href="/chart/<%= item.symbol %>">Full Chart</a>
              <!--  MAS note: Purchase is a simulated UI action (no real trade execution) -->
              <button class="btn purchase-btn"
                      type="button"
                      data-symbol="<%= item.symbol %>"
                      data-price="<%= Number(price).toFixed(2) %>">
                Purchase
              </button>
            </div>
            <script>
              // =========================================================
              // PURCHASE (SIMULATED) ACTION
              // MAS: No trade execution, human-in-the-loop confirmation
              // =========================================================
              document.addEventListener("click", (e) => {
                const btn = e.target.closest(".purchase-btn");
                if(!btn) return;

                const symbol = btn.dataset.symbol || "‚Äî";
                const price  = btn.dataset.price || "‚Äî";

                alert(
                  `Purchase Request (Simulation)\n\n` +
                  `Stock: ${symbol}\n` +
                  `Shown Price: $${price}\n\n` +
                  `This is a student prototype.\nNo real trade is executed.`
                );
              });
            </script>


            <script>
              (function(){
                const symbol = "<%= item.symbol %>";

                //  CARD refresh interval (slow down here)
                // 5s is pretty aggressive on free tier. Try 15s.
                const REFRESH_MS = 15000;

                const el = document.getElementById("chart-<%= item.symbol %>");
                if(!el) return;

                const ctx = el.getContext("2d");
                const labelsRaw = <%- JSON.stringify(item.graph.labels) %>;
                const pricesRaw = <%- JSON.stringify(item.graph.prices) %>;

                const prices = (pricesRaw || [])
                  .map(v => Number(v))
                  .filter(v => Number.isFinite(v));

                const seed = Number("<%= Number(item.quote?.c ?? 0).toFixed(2) %>") || 0;
                const initialData = prices.length ? prices : [seed, seed, seed];
                const initialLabels = (labelsRaw && labelsRaw.length) ? labelsRaw : ["1","2","3"];

                const gradient = ctx.createLinearGradient(0, 0, 0, 120);
                gradient.addColorStop(0, "rgba(0, 234, 255, 0.85)");
                gradient.addColorStop(1, "rgba(0, 234, 255, 0.06)");

                const chart = new Chart(ctx, {
                  type: "line",
                  data: {
                    labels: initialLabels,
                    datasets: [{
                      data: initialData,
                      borderColor: "#00eaff",
                      backgroundColor: gradient,
                      borderWidth: 2,
                      tension: 0.35,
                      pointRadius: 0,
                      fill: true
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } }
                  }
                });

                async function refreshLive(){
                  try{
                    const r = await fetch(`/api/quote/${encodeURIComponent(symbol)}`);
                    if(!r.ok) return;
                    const q = await r.json();
                    if(!q || q.error) return;

                    const livePrice = Number(q.c);
                    const liveChange = Number(q.d);
                    const livePercent = Number(q.dp);

                    if(!Number.isFinite(livePrice)) return;

                    const ds = chart.data.datasets[0].data;
                    ds[ds.length - 1] = livePrice;
                    chart.update();

                    const priceEl = document.getElementById(`price-${symbol}`);
                    if(priceEl) priceEl.innerText = `$${livePrice.toFixed(2)}`;

                    const chgEl = document.getElementById(`chg-${symbol}`);
                    if(chgEl && Number.isFinite(liveChange) && Number.isFinite(livePercent)){
                      const cls = liveChange > 0 ? "pos" : (liveChange < 0 ? "neg" : "");
                      chgEl.classList.remove("pos","neg");
                      if(cls) chgEl.classList.add(cls);

                      const signChg = liveChange > 0 ? "+" : "";
                      const signPct = livePercent > 0 ? "+" : "";
                      chgEl.innerText = `${signChg}${liveChange.toFixed(2)} (${signPct}${livePercent.toFixed(2)}%)`;
                    }
                  }catch(e){}
                }

                setInterval(refreshLive, REFRESH_MS);

                //  show card refresh interval in left panel (only needs to run once)
                const refreshEl = document.getElementById("refreshMs");
                if(refreshEl && refreshEl.innerText === "‚Äî") refreshEl.innerText = String(REFRESH_MS);
              })();
            </script>
          </div>
        <% }) %>
      </div>

      <div style="
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:12px 14px;
        border-top:1px solid #222;
        background:#121212;
      ">
        <div style="font-size:12px; color:#888;">
          Showing page <%= page %> of <%= totalPages %>
        </div>

        <div style="display:flex; gap:8px;">
          <% if (page > 1) { %>
            <a class="btn" href="/?page=<%= page - 1 %>">‚¨Ö Previous</a>
          <% } %>

          <% if (page < totalPages) { %>
            <a class="btn" href="/?page=<%= page + 1 %>">Next ‚û°</a>
          <% } %>
        </div>
      </div>
    </div>

  </div>

  <!-- News & Sentiment Section - Full Width -->
  <div style="background: #121212; border-top: 1px solid #222; border-bottom: 1px solid #222; margin-top: 40px; width:1200px; margin-left: auto; margin-right: auto;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 40px 28px;">
      <!-- Latest News Section -->
      <div style="margin-bottom: 40px;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px;">
          <h2 style="margin: 0; color: #00eaff; font-size: 28px;">üì∞ Latest News</h2>
          <span style="font-size: 1rem; color: #aaa;">Top stories</span>
        </div>
        <div id="latestNewsList" style="display: flex; flex-direction: column; gap: 20px; width: 100%;">
          <p style="color: #aaa; text-align: center;">Loading latest news...</p>
        </div>
      </div>

      <!-- Divider -->
      <div style="border-top: 1px solid #222; margin: 40px 0;"></div>

      <!-- Trending News Section -->
      <div style="margin-bottom: 40px;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px;">
          <h2 style="margin: 0; color: #00eaff; font-size: 28px;">üî• Trending News</h2>
          <span style="font-size: 1rem; color: #aaa;">Most talked about</span>
        </div>
        <div id="trendingNewsList" style="display: flex; flex-direction: column; gap: 20px; width: 100%;">
          <p style="color: #aaa; text-align: center;">Loading trending news...</p>
        </div>
      </div>

      <!-- Divider -->
      <div style="border-top: 1px solid #222; margin: 40px 0;"></div>

      <!-- Search Section -->
      <div>
        <h2 style="color: #00eaff; margin: 0 0 30px 0; font-size: 28px;">üîç Search News</h2>
        <div style="display: flex; gap: 12px; margin-bottom: 25px;">
          <input 
            type="text" 
            id="newsSearch" 
            placeholder="Search by ticker (AAPL) or company name (Apple)..." 
            style="
              flex: 1;
              padding: 14px 18px;
              background: #0f0f0f;
              border: 1px solid #2a2a2a;
              border-radius: 10px;
              color: #eee;
              font-family: 'Inter', Arial, sans-serif;
              font-size: 16px;
            "
          />
          <button 
            onclick="searchNews()" 
            style="
              padding: 14px 32px;
              background: #00eaff;
              color: #000;
              border: none;
              border-radius: 10px;
              font-weight: 700;
              cursor: pointer;
              font-size: 16px;
              transition: 0.2s;
            "
            onmouseover="this.style.opacity='0.9'"
            onmouseout="this.style.opacity='1'"
          >
            üîç Search
          </button>
        </div>
        <div id="newsHint" style="color: #aaa; margin-bottom: 20px; font-size: 1rem;">
          üí° Search for ANY stock ticker or company name (AAPL, MSFT, XYZ, etc.) - Unlimited search!
        </div>
        <div id="newsList" style="display: flex; flex-direction: column; gap: 20px; width: 100%;">
          <!-- Search results will be added here -->
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    Data sources: Finnhub (live quotes), Finnhub candles (if available) / Stooq (historical fallback), TradingView (full charts).<br>
    StockAI is a student prototype for informational/educational purposes only ‚Äî not financial advice, no trade execution.
  </div>

  <script>
    (function(){
      const el = document.getElementById("lastUpdated");
      if(!el) return;

      const update = () => {
        const now = new Date();
        el.textContent = `Updated ${now.toLocaleTimeString()}`;
      };

      update();
      setInterval(update, 1000);
    })();
  </script>

  <script>
    // =========================================================
    //  TICKER (slow down here)
    // - Uses ONE endpoint: /api/ticker
    // - Change REFRESH_MS to slow ticker refresh
    // =========================================================
    (function(){
      const tickerEl = document.getElementById("ticker");
      if(!tickerEl) return;

      //  TICKER refresh interval (slow down here)
      // Try 20s to reduce "Unavailable"
      const REFRESH_MS = 20000;

      function renderItem(item){
        if(!item || !item.ok){
          return `
            <div class="ticker-item">
              <span class="ticker-sym">${item?.symbol ?? "‚Äî"}</span>
              <span class="ticker-price">‚Äî</span>
              <span class="ticker-chg">Unavailable</span>
            </div>
          `;
        }

        const price = Number(item.c);
        const chg   = Number(item.d);
        const pct   = Number(item.dp);

        const up = Number.isFinite(chg) && chg > 0;
        const down = Number.isFinite(chg) && chg < 0;
        const cls = up ? "t-up" : (down ? "t-down" : "");

        const signChg = up ? "+" : "";
        const signPct = up ? "+" : "";

        return `
          <div class="ticker-item">
            <span class="ticker-sym">${item.symbol}</span>
            <span class="ticker-price">${Number.isFinite(price) ? price.toFixed(2) : "‚Äî"}</span>
            <span class="ticker-chg ${cls}">
              ${Number.isFinite(chg) ? `${signChg}${chg.toFixed(2)}` : "‚Äî"}
              ${Number.isFinite(pct) ? `(${signPct}${pct.toFixed(2)}%)` : ""}
            </span>
          </div>
        `;
      }

      async function loadTicker(){
        try{
          const r = await fetch(`/api/ticker`);
          if(!r.ok) throw new Error("Ticker API failed");

          const payload = await r.json();
          const rows = Array.isArray(payload?.symbols) ? payload.symbols : [];

          if(rows.length === 0){
            tickerEl.innerHTML = `
              <div class="ticker-item">
                <span class="ticker-sym">Ticker</span>
                <span class="ticker-price">‚Äî</span>
                <span class="ticker-chg">No data</span>
              </div>
            `;
            return;
          }

          const html = rows.map(renderItem).join("");
          tickerEl.innerHTML = html + html;

          //  show ticker refresh interval in left panel
          const tEl = document.getElementById("tickerRefreshMs");
          if(tEl) tEl.innerText = String(REFRESH_MS);

        } catch(e){
          tickerEl.innerHTML = `
            <div class="ticker-item">
              <span class="ticker-sym">Ticker</span>
              <span class="ticker-price">‚Äî</span>
              <span class="ticker-chg">Error loading</span>
            </div>
          `;
        }
      }

      loadTicker();
      setInterval(loadTicker, REFRESH_MS);
    })();

    // =========================================================
    // NEWS & SENTIMENT FUNCTIONS
    // =========================================================
    async function loadLatestNews() {
      const list = document.getElementById('latestNewsList');
      try {
        const tickers = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'TSLA', 'META', 'NFLX', 'JPM', 'V'];
        const allArticles = [];

        for (const ticker of tickers) {
          try {
            const response = await fetch(`/api/news/${ticker}`);
            const articles = await response.json();
            if (articles && articles.length > 0) {
              allArticles.push(...articles);
            }
          } catch (e) {
            console.warn(`Error fetching news for ${ticker}`);
          }
        }

        if (allArticles.length === 0) {
          list.innerHTML = '<p style="color: #aaa; text-align: center;">No news available at the moment.</p>';
          return;
        }

        const newsHtml = allArticles
          .slice(0, 5)
          .map((article, index) => `
            <div class="news-item" id="latest-news-${index}">
              <div class="news-header">
                <h4>${article.title}</h4>
                <span class="news-source">${article.source}</span>
              </div>
              <p>${article.description}</p>
              <div class="news-actions">
                <button class="btn-analyze-news" onclick="analyzeNewsArticle(${index}, '${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">
                  Analyse
                </button>
                <button class="btn-save-news" id="save-latest-${index}" style="display: none;" onclick="saveNewsAsAnalysis('${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">
                  Save Analysis
                </button>
              </div>
              <div class="analysis-result" id="analysis-latest-${index}" style="display: none;"></div>
            </div>
          `).join('');

        list.innerHTML = newsHtml;
      } catch (error) {
        console.error('Error loading latest news:', error);
        list.innerHTML = '<p style="color: #e53935; text-align: center;">Error loading latest news.</p>';
      }
    }

    async function loadTrendingNews() {
      const list = document.getElementById('trendingNewsList');
      try {
        const trendingTickers = ['NVDA', 'PLTR', 'DDOG', 'NET', 'COIN', 'MSTR', 'ARM', 'SMCI'];
        const allTrendingArticles = [];

        for (const ticker of trendingTickers) {
          try {
            const response = await fetch(`/api/news/${ticker}`);
            const articles = await response.json();
            if (articles && articles.length > 0) {
              articles.forEach(art => art.ticker = ticker);
              allTrendingArticles.push(...articles);
            }
          } catch (e) {
            console.warn(`Error fetching trending news for ${ticker}`);
          }
        }

        if (allTrendingArticles.length === 0) {
          list.innerHTML = '<p style="color: #aaa; text-align: center;">No trending news available at the moment.</p>';
          return;
        }

        const trendingArticle = allTrendingArticles[0];

        const trendingArticleHtml = `
          <div class="news-item trending-news-item" id="trending-news-0">
            <div style="position: absolute; bottom: 15px; right: 15px; background: linear-gradient(135deg, #ff6b35, #d63031); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
              üî• Trending
            </div>
            <div class="news-header">
              <h4>${trendingArticle.title}</h4>
              <span class="news-source">${trendingArticle.source}</span>
            </div>
            <p>${trendingArticle.description}</p>
            <div class="news-actions">
              <button class="btn-analyze-news" onclick="analyzeNewsArticle(0, '${trendingArticle.title.replace(/'/g, "\\'")}', '${trendingArticle.description.replace(/'/g, "\\'")}')">
                Analyse
              </button>
              <button class="btn-save-news" id="save-trending-0" style="display: none;" onclick="saveNewsAsAnalysis('${trendingArticle.title.replace(/'/g, "\\'")}', '${trendingArticle.description.replace(/'/g, "\\'")}')">
                Save Analysis
              </button>
            </div>
            <div class="analysis-result" id="analysis-trending-0" style="display: none;"></div>
          </div>
        `;

        list.innerHTML = trendingArticleHtml;
      } catch (error) {
        console.error('Error loading trending news:', error);
        list.innerHTML = '<p style="color: #e53935; text-align: center;">Error loading trending news.</p>';
      }
    }

    async function searchNews() {
      const query = document.getElementById('newsSearch').value.trim().toUpperCase();
      if (!query) return alert('Please enter a ticker or company name');

      const newsList = document.getElementById('newsList');
      newsList.innerHTML = '<p style="color: #aaa; text-align: center;">Searching news...</p>';

      try {
        const response = await fetch(`/api/news/${query}`);
        const articles = await response.json();
        
        if (!articles || articles.length === 0) {
          newsList.innerHTML = '<p style="color: #aaa; text-align: center;">No news found.</p>';
          return;
        }

        newsList.innerHTML = articles.slice(0, 5).map((article, index) => `
          <div class="news-item" id="search-news-${index}">
            <div class="news-header">
              <h4>${article.title}</h4>
              <span class="news-source">${article.source}</span>
            </div>
            <p>${article.description}</p>
            <div class="news-actions">
              <button class="btn-analyze-news" onclick="analyzeNewsArticle('search-${index}', '${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">
                Analyse
              </button>
              <button class="btn-save-news" id="save-search-${index}" style="display: none;" onclick="saveNewsAsAnalysis('${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">
                Save Analysis
              </button>
            </div>
            <div class="analysis-result" id="analysis-search-${index}" style="display: none;"></div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error fetching news:', error);
        newsList.innerHTML = '<p style="color: #e53935; text-align: center;">Error loading news. Please try again.</p>';
      }
    }

    window.addEventListener('keypress', function(event) {
      if (event.key === 'Enter' && document.activeElement.id === 'newsSearch') {
        searchNews();
      }
    });

    async function analyzeNewsArticle(index, title, description) {
      const analysisDiv = document.getElementById(`analysis-${index}`) ||
                         document.getElementById(`analysis-trending-${index}`) ||
                         document.getElementById(`analysis-latest-${index}`);
      
      if (!analysisDiv) return;
      
      analysisDiv.innerHTML = '<p style="color: #aaa; text-align: center; margin-top: 10px;">Analyzing sentiment...</p>';
      analysisDiv.style.display = 'block';
      
      try {
        const response = await fetch('/api/analyze-sentiment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ text: title + ' ' + description, title: title })
        });

        if (!response.ok) throw new Error('API error');
        
        const result = await response.json();
        const sentiment = result.sentiment || 'NEUTRAL';
        const scores = result.scores || { positive: 0, negative: 0, neutral: 100 };
        const confidence = result.confidence || (Math.max(scores.positive || 0, scores.neutral || 0, scores.negative || 0));

        let sentimentColor = '#999';
        let sentimentBg = 'rgba(153, 153, 153, 0.1)';
        if (sentiment === 'POSITIVE') {
          sentimentColor = '#4caf50';
          sentimentBg = 'rgba(76, 175, 80, 0.15)';
        } else if (sentiment === 'NEGATIVE') {
          sentimentColor = '#e53935';
          sentimentBg = 'rgba(229, 57, 53, 0.15)';
        }

        const html = `
          <div style="background-color: ${sentimentBg}; padding: 12px; border-radius: 6px; border-left: 4px solid ${sentimentColor};">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <strong style="color: ${sentimentColor}; font-size: 1.1rem;">Sentiment: ${sentiment}</strong>
              <div style="background-color: rgba(0, 0, 0, 0.2); padding: 4px 10px; border-radius: 4px;">
                <span style="color: #fff; font-weight: 600; font-size: 0.9rem;">Confidence: ${Math.round(confidence)}%</span>
              </div>
            </div>
            <div style="margin-top: 8px; display: flex; gap: 15px;">
              <div>
                <span style="color: #4caf50; font-weight: 600;">Positive</span><br>
                <span style="color: #4caf50; font-size: 1.3rem; font-weight: bold;">${Math.round(scores.positive || 0)}%</span>
              </div>
              <div>
                <span style="color: #999; font-weight: 600;">Neutral</span><br>
                <span style="color: #999; font-size: 1.3rem; font-weight: bold;">${Math.round(scores.neutral || 0)}%</span>
              </div>
              <div>
                <span style="color: #e53935; font-weight: 600;">Negative</span><br>
                <span style="color: #e53935; font-size: 1.3rem; font-weight: bold;">${Math.round(scores.negative || 0)}%</span>
              </div>
            </div>
          </div>
        `;

        analysisDiv.innerHTML = html;

        // Highlight the news item based on sentiment
        const newsItem = document.getElementById(`search-news-${index}`) ||
                        document.getElementById(`trending-news-${index}`) ||
                        document.getElementById(`latest-news-${index}`);
        if (newsItem) {
          if (sentiment === 'POSITIVE') {
            newsItem.style.borderLeft = '5px solid #4caf50';
            newsItem.style.backgroundColor = 'rgba(76, 175, 80, 0.05)';
          } else if (sentiment === 'NEGATIVE') {
            newsItem.style.borderLeft = '5px solid #e53935';
            newsItem.style.backgroundColor = 'rgba(229, 57, 53, 0.05)';
          } else {
            newsItem.style.borderLeft = '5px solid #999';
            newsItem.style.backgroundColor = 'rgba(153, 153, 153, 0.05)';
          }
        }

        // Show save button
        const saveBtn = document.getElementById(`save-${index}`) ||
                       document.getElementById(`save-trending-${index}`) ||
                       document.getElementById(`save-latest-${index}`) || 
                       document.getElementById(`save-btn-${index}`);
        if (saveBtn) saveBtn.style.display = 'inline-block';

      } catch (error) {
        console.error('Error analyzing news:', error);
        analysisDiv.innerHTML = '<p style="color: #e53935;">Error analyzing sentiment.</p>';
      }
    }

    function saveNewsAsAnalysis(title, description) {
      // Get existing analyses from localStorage
      const analyses = JSON.parse(localStorage.getItem('analyses') || '[]');
      
      // Create new analysis object
      const newAnalysis = {
        id: Date.now(), // Use timestamp as unique ID
        title: title,
        content: description,
        notes: '',
        date: new Date().toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric'
        }),
        isFavorite: false
      };
      
      // Add to analyses array
      analyses.push(newAnalysis);
      
      // Save back to localStorage
      localStorage.setItem('analyses', JSON.stringify(analyses));
      
      // Show success message
      alert(`‚úÖ Analysis saved! Check your "Saved Analysis" in the Account page to view all saved articles.`);
    }

    // Load news on page load
    window.addEventListener('DOMContentLoaded', function() {
      loadLatestNews();
      loadTrendingNews();
    });
  </script>

</body>
</html>