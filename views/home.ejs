<!DOCTYPE html>
<html lang="en">
<head>
  <title>Market Dashboard</title>
  <%- include('partials/head') %>

  <!-- Chart.js for sparklines -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#070707;
      --panel:rgba(18,18,18,.85);
      --panel2:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.10);
      --soft:rgba(255,255,255,.06);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.60);
      --accent:#00eaff;
      --pos:#34d399;
      --neg:#f87171;
      --radius:16px;
      --ticker-height: 44px;
    }

    body{
      margin:0;
      background:
        radial-gradient(1100px 700px at 10% 0%, rgba(0,234,255,.14), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(0,234,255,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:"Inter", Arial, sans-serif;
    }

    /* ================== TICKER ================== */
    .ticker-wrap{
      position: sticky;
      top: 0;
      z-index: 15;
      height: var(--ticker-height);
      display:flex;
      align-items:center;
      background: rgba(10,10,10,.88);
      border-bottom:1px solid var(--border);
      overflow:hidden;
      white-space:nowrap;
      backdrop-filter: blur(8px);
    }

    .ticker{
      display:inline-flex;
      align-items:center;
      gap:20px;
      padding:10px 28px;
      will-change: transform;
      animation: ticker-scroll 22s linear infinite;
    }

    .ticker-wrap:hover .ticker{ animation-play-state: paused; }

    @keyframes ticker-scroll{
      from{ transform: translateX(0); }
      to{ transform: translateX(-50%); }
    }

    .ticker-item{
      display:inline-flex;
      align-items:baseline;
      gap:10px;
      padding-right:18px;
      border-right:1px solid var(--soft);
      min-width: 210px;
    }
    .ticker-sym{ font-weight:1000; letter-spacing:.2px; }
    .ticker-price{ font-weight:1000; }
    .ticker-chg{ font-weight:900; font-size:12px; }
    .t-up{ color:var(--pos); }
    .t-down{ color:var(--neg); }

    /* ================== PAGE LAYOUT ================== */
    .container{
      max-width:1200px;
      margin:0 auto;
      padding:18px 28px 24px;
    }

    /* ‚úÖ NEW: MARKET STATUS BAR (broker style) */
    .market-bar{
      margin-top:10px;
      margin-bottom:8px;
      padding:12px 14px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .market-left{
      display:flex;
      align-items:center;
      gap:10px;
      color: rgba(255,255,255,.75);
      font-size:13px;
      flex-wrap:wrap;
    }
    .market-right{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .status-dot{
      width:9px;
      height:9px;
      border-radius:50%;
      display:inline-block;
    }
    .status-dot.open{ background: var(--pos); box-shadow: 0 0 10px rgba(52,211,153,.45); }
    .status-dot.closed{ background: var(--neg); box-shadow: 0 0 10px rgba(248,113,113,.35); }
    .market-title{
      font-weight:1000;
      color: rgba(255,255,255,.92);
    }
    .market-pill{
      font-size:11px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25);
      color: rgba(255,255,255,.70);
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .headline h1{
      margin:0 0 6px;
      font-size:28px;
      font-weight:1000;
      letter-spacing:.2px;
    }
    .headline p{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.45;
      max-width:760px;
    }

    .searchbox{
      display:flex;
      gap:10px;
      align-items:center;
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      min-width:360px;
    }

    .searchbox input{
      flex:1;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:14px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      text-decoration:none;
      transition:.15s;
      white-space:nowrap;
    }
    .btn:hover{ transform:translateY(-1px); background:rgba(255,255,255,.06); }
    .btn.primary{
      background:var(--accent);
      color:#000;
      border-color:transparent;
    }
    .btn.ghost{
      background:transparent;
    }
    .btn.small{ padding:8px 10px; font-size:12px; border-radius:10px; }

    /* ================== KPI ROW ================== */
    .kpis{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      margin-top:16px;
    }
    .kpi{
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:12px 14px;
    }
    .kpi .label{ font-size:12px; color:var(--muted); }
    .kpi .value{ font-size:18px; font-weight:1000; margin-top:6px; }
    .kpi .sub{ font-size:12px; color:rgba(255,255,255,.5); margin-top:2px; }

    .pos{ color:var(--pos); }
    .neg{ color:var(--neg); }

    /* ================== GRID ================== */
    .grid{
      display:grid;
      grid-template-columns: 1.05fr 2fr;
      gap:16px;
      margin-top:16px;
      align-items:start;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    .panel-header{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .panel-header h2{
      margin:0;
      font-size:12px;
      font-weight:1000;
      letter-spacing:.45px;
      text-transform:uppercase;
      color:rgba(255,255,255,.85);
    }
    .panel-header span{
      font-size:12px;
      color:var(--muted);
    }

    .left-block{
      padding:14px;
      display:grid;
      gap:10px;
    }

    .section{
      background: rgba(255,255,255,.03);
      border:1px solid var(--soft);
      border-radius: 14px;
      padding:12px;
    }
    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin:0 0 8px;
      font-size:12px;
      letter-spacing:.35px;
      color:rgba(255,255,255,.75);
      font-weight:900;
    }
    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:rgba(255,255,255,.65);
      background: rgba(0,0,0,.25);
      white-space:nowrap;
    }
    .muted{
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
    }

    .kv{
      display:grid;
      gap:8px;
    }
    .kv-row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      font-size:12px;
      color:rgba(255,255,255,.78);
      padding:7px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .kv-row:last-child{ border-bottom:none; }

    /* ================== STOCK TABLE ================== */
    .stocks-table{
      width:100%;
      border-collapse:collapse;
    }
    .stocks-table th{
      text-align:left;
      font-size:11px;
      color:rgba(255,255,255,.58);
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      white-space:nowrap;
    }
    .stocks-table td{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:middle;
    }
    .stocks-table tr:hover{
      background: rgba(0,234,255,.05);
    }

    .sym{
      color:var(--accent);
      font-weight:1000;
      text-decoration:none;
      letter-spacing:.2px;
    }

    .price{
      font-weight:1000;
      letter-spacing:.1px;
      white-space:nowrap;
    }

    .chg{
      font-weight:1000;
      font-size:12px;
      white-space:nowrap;
    }

    .mini{
      width:160px;
      height:48px;
      border-radius:12px;
      background: rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.06);
      overflow:hidden;
    }
    .mini canvas{
      width:100% !important;
      height:100% !important;
      display:block;
    }

    .row-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .purchase-btn{
      border-color: rgba(0,234,255,.55);
    }
    .purchase-btn:hover{
      background: rgba(0,234,255,.10);
    }

    .table-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.02);
      gap:10px;
      flex-wrap:wrap;
    }

    /* ================== MAS BOX ================== */
    details summary{
      cursor:pointer;
      list-style:none;
      user-select:none;
    }
    details summary::-webkit-details-marker{ display:none; }
    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .pill{
      font-size:11px;
      color:rgba(255,255,255,.72);
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.20);
    }

    /* ================== NEWS ================== */
    .news-wrap{
      max-width:1200px;
      margin: 14px auto 0;
      padding: 0 28px 28px;
    }
    .news-panel{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .news-inner{
      padding: 18px 18px 22px;
    }
    .news-title-row{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }
    .news-title-row h2{
      margin:0;
      color:var(--accent);
      font-size:22px;
      font-weight:1000;
    }
    .news-title-row span{
      color: var(--muted);
      font-size:13px;
    }

    .news-item {
      background: rgba(255,255,255,.03);
      padding: 18px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      border-left: 5px solid var(--accent);
      position: relative;
      transition: 0.2s;
    }
    .news-item:hover {
      box-shadow: 0 0 24px rgba(0, 234, 255, 0.12);
      border-color: rgba(0,234,255,.25);
    }
    .news-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }
    .news-item h4 {
      margin: 0;
      color: rgba(255,255,255,.92);
      font-size: 16px;
      font-weight: 900;
      line-height: 1.4;
      flex: 1;
    }
    .news-source {
      color: rgba(255,255,255,.72);
      font-size: 12px;
      white-space: nowrap;
      padding: 6px 10px;
      background: rgba(0, 234, 255, 0.10);
      border: 1px solid rgba(0, 234, 255, 0.20);
      border-radius: 999px;
    }
    .news-item p {
      margin: 0 0 12px 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .news-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap:wrap;
    }

    .btn-analyze-news {
      padding: 10px 14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(255,255,255,.9);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 900;
      font-size: 13px;
      transition: 0.2s;
    }
    .btn-analyze-news:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,.25);
      border-color: rgba(255,255,255,.18);
    }

    .btn-save-news {
      padding: 10px 14px;
      background: var(--accent);
      color:#000;
      border:none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 1000;
      font-size: 13px;
      transition: 0.2s;
    }
    .btn-save-news:hover {
      opacity: .92;
      transform: translateY(-1px);
    }

    .analysis-result {
      margin-top: 12px;
      padding: 12px;
      background: rgba(0, 234, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(0, 234, 255, 0.18);
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.5;
    }

    .trending-news-item {
      border-left: 5px solid #ff6b35;
      box-shadow: 0 0 24px rgba(255, 107, 53, 0.12);
    }

    .footer{
      border-top:1px solid var(--border);
      padding:16px 28px;
      color:var(--muted);
      font-size:12px;
      background: rgba(0,0,0,.35);
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      .kpis{ grid-template-columns:repeat(2,1fr); }
      .searchbox{ min-width: 0; width:100%; }
      .mini{ width:140px; }
    }
  </style>
</head>

<body>
  <%- include('partials/navbar') %>

  <!-- TICKER -->
  <div class="ticker-wrap" aria-label="Live market ticker">
    <div id="ticker" class="ticker"></div>
  </div>

  <div class="container">

    <!-- Market Status Bar -->
    <div class="market-bar">
      <div class="market-left">
        <span id="mktDot" class="status-dot closed"></span>
        <span class="market-title" id="mktStatus">Market: Checking‚Ä¶</span>
        <span class="market-pill">Quotes: Finnhub</span>
        <span class="market-pill">Charts: Finnhub / Stooq</span>
        <span class="market-pill">Mode: View-only</span>
      </div>
      <div class="market-right">
        Last updated: <span id="marketTime">‚Äî</span>
      </div>
    </div>

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="headline">
        <h1>Market Overview</h1>

        <div class="pill-row">
          <span class="pill">Transparency</span>
          <span class="pill">Explainability</span>
          <span class="pill">Human-in-the-loop</span>
          <span class="pill">No trade execution</span>
        </div>
      </div>

      <!-- keep your search button -->
      <div class="searchbox">
        üîé
        <input id="quickSearch" placeholder="Search ticker (AAPL) and press Go" />
        <button class="btn primary" id="quickGo">Go</button>
      </div>
    </div>

    <!-- KPI ROW -->
    <%
      const items = Array.isArray(results) ? results : [];
      const ups = items.filter(x => Number(x?.quote?.dp) > 0).length;
      const downs = items.filter(x => Number(x?.quote?.dp) < 0).length;

      const sortedByDp = items
        .map(x => ({ symbol: x.symbol, dp: Number(x?.quote?.dp) }))
        .filter(x => Number.isFinite(x.dp))
        .sort((a,b) => b.dp - a.dp);

      const topGainer = sortedByDp.length ? sortedByDp[0] : null;
      const topLoser  = sortedByDp.length ? sortedByDp[sortedByDp.length - 1] : null;
    %>

    <div class="kpis">
      <div class="kpi">
        <div class="label">Advancers</div>
        <div class="value pos"><%= ups %></div>
        <div class="sub">Symbols up on this page</div>
      </div>
      <div class="kpi">
        <div class="label">Decliners</div>
        <div class="value neg"><%= downs %></div>
        <div class="sub">Symbols down on this page</div>
      </div>
      <div class="kpi">
        <div class="label">Top Gainer</div>
        <div class="value"><%= topGainer ? topGainer.symbol : "‚Äî" %></div>
        <div class="sub"><%= topGainer ? `${topGainer.dp.toFixed(2)}%` : "" %></div>
      </div>
      <div class="kpi">
        <div class="label">Top Loser</div>
        <div class="value"><%= topLoser ? topLoser.symbol : "‚Äî" %></div>
        <div class="sub"><%= topLoser ? `${topLoser.dp.toFixed(2)}%` : "" %></div>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid">
      <!-- LEFT PANEL -->
      <div class="panel">
        <div class="panel-header">
          <h2>Market Tools & Context</h2>
          <span>View-only</span>
        </div>

        <div class="left-block">
          <div class="section">
            <div class="section-title">
              <span>Navigation</span>
              <span class="tag">No trade execution</span>
            </div>
            <div style="display:grid; gap:10px;">
              <a class="btn" href="/portfolio" style="text-align:center;">üìä Open Portfolio Dashboard</a>
              <% if (topGainer) { %>
                <a class="btn ghost" href="/chart/<%= topGainer.symbol %>" style="text-align:center;">
                  üöÄ Top Gainer: <strong><%= topGainer.symbol %></strong> (<%= topGainer.dp.toFixed(2) %>%)
                </a>
              <% } %>

              <% if (topLoser) { %>
                <a class="btn ghost" href="/chart/<%= topLoser.symbol %>" style="text-align:center;">
                  üìâ Top Loser: <strong><%= topLoser.symbol %></strong> (<%= topLoser.dp.toFixed(2) %>%)
                </a>
              <% } %>
            </div>
          </div>

          <div class="section">
            <div class="section-title">
              <span>Market Snapshot (This Page)</span>
              <span class="tag" id="lastUpdated">Updating‚Ä¶</span>
            </div>

            <div class="kv">
              <div class="kv-row">
                <span>Advancers / Decliners</span>
                <span><%= ups %> / <%= downs %></span>
              </div>
              <div class="kv-row">
                <span>Top gainer (this page)</span>
                <span><%= topGainer ? `${topGainer.symbol} (${topGainer.dp.toFixed(2)}%)` : "N/A" %></span>
              </div>
              <div class="kv-row">
                <span>Top loser (this page)</span>
                <span><%= topLoser ? `${topLoser.symbol} (${topLoser.dp.toFixed(2)}%)` : "N/A" %></span>
              </div>
              <div class="kv-row">
                <span>Card refresh</span>
                <span><span id="refreshMs">‚Äî</span> ms</span>
              </div>
              <div class="kv-row">
                <span>Ticker refresh</span>
                <span><span id="tickerRefreshMs">‚Äî</span> ms</span>
              </div>
            </div>

            <div class="muted" style="margin-top:10px;">
              Snapshot reflects tickers shown on this page only (not the entire market).
            </div>
          </div>

          
        </div>
      </div>

      <!-- RIGHT PANEL: STOCK TABLE WITH GRAPHS -->
      <div class="panel">
        <div class="panel-header">
          <h2>Stocks</h2>
          <span>Page <%= page %> of <%= totalPages %></span>
        </div>

        <table class="stocks-table">
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Trend</th>
              <th>Price</th>
              <th>Change</th>
              <th style="text-align:right;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% results.forEach(item => {
              const change = item.quote?.d ?? 0;
              const percent = item.quote?.dp ?? 0;
              const price = item.quote?.c ?? 0;
              const cls = change > 0 ? "pos" : (change < 0 ? "neg" : "");
            %>
              <tr>
                <td>
                  <a class="sym" href="/chart/<%= item.symbol %>"><%= item.symbol %></a>
                  <div class="muted" style="margin-top:4px;">Live quote + sparkline</div>
                </td>

                <td>
                  <div class="mini">
                    <canvas id="chart-<%= item.symbol %>"></canvas>
                  </div>
                </td>

                <td class="price" id="price-<%= item.symbol %>">$<%= Number(price).toFixed(2) %></td>

                <td class="chg <%= cls %>" id="chg-<%= item.symbol %>">
                  <%= change > 0 ? "+" : "" %><%= Number(change).toFixed(2) %>
                  (<%= percent > 0 ? "+" : "" %><%= Number(percent).toFixed(2) %>%)
                </td>

                <td style="text-align:right;">
                  <div class="row-actions">
                    <a class="btn small" href="/chart/<%= item.symbol %>">Full Chart</a>
                    <button class="btn small purchase-btn" type="button"
                            data-symbol="<%= item.symbol %>"
                            data-price="<%= Number(price).toFixed(2) %>">
                      Purchase
                    </button>
                  </div>
                </td>
              </tr>

              <script>
                (function(){
                  const symbol = "<%= item.symbol %>";
                  const REFRESH_MS = 15000;

                  const canvas = document.getElementById("chart-<%= item.symbol %>");
                  if(!canvas) return;

                  const ctx = canvas.getContext("2d");
                  const labelsRaw = <%- JSON.stringify(item.graph.labels) %>;
                  const pricesRaw = <%- JSON.stringify(item.graph.prices) %>;

                  const prices = (pricesRaw || []).map(v => Number(v)).filter(v => Number.isFinite(v));
                  const seed = Number("<%= Number(item.quote?.c ?? 0).toFixed(2) %>") || 0;

                  const initialData = prices.length ? prices : [seed, seed, seed];
                  const initialLabels = (labelsRaw && labelsRaw.length) ? labelsRaw : ["1","2","3"];

                  const gradient = ctx.createLinearGradient(0, 0, 0, 60);
                  gradient.addColorStop(0, "rgba(0, 234, 255, 0.35)");
                  gradient.addColorStop(1, "rgba(0, 234, 255, 0.00)");

                  const chart = new Chart(ctx, {
                    type: "line",
                    data: {
                      labels: initialLabels,
                      datasets: [{
                        data: initialData,
                        borderColor: "#00eaff",
                        backgroundColor: gradient,
                        borderWidth: 2,
                        tension: 0.35,
                        pointRadius: 0,
                        fill: true
                      }]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      animation: false,
                      plugins: { legend: { display: false }, tooltip: { enabled: false } },
                      scales: { x: { display: false }, y: { display: false } }
                    }
                  });

                  async function refreshLive(){
                    try{
                      const r = await fetch(`/api/quote/${encodeURIComponent(symbol)}`);
                      if(!r.ok) return;

                      const q = await r.json().catch(()=>null);
                      if(!q || q.error) return;

                      const live = q.quote ? q.quote : q;

                      const livePrice = Number(live.c);
                      const liveChange = Number(live.d);
                      const livePercent = Number(live.dp);

                      if(!Number.isFinite(livePrice)) return;

                      const ds = chart.data.datasets[0].data;
                      ds[ds.length - 1] = livePrice;
                      chart.update();

                      const priceEl = document.getElementById(`price-${symbol}`);
                      if(priceEl) priceEl.innerText = `$${livePrice.toFixed(2)}`;

                      const chgEl = document.getElementById(`chg-${symbol}`);
                      if(chgEl && Number.isFinite(liveChange) && Number.isFinite(livePercent)){
                        const cls = liveChange > 0 ? "pos" : (liveChange < 0 ? "neg" : "");
                        chgEl.classList.remove("pos","neg");
                        if(cls) chgEl.classList.add(cls);

                        const signChg = liveChange > 0 ? "+" : "";
                        const signPct = livePercent > 0 ? "+" : "";
                        chgEl.innerText = `${signChg}${liveChange.toFixed(2)} (${signPct}${livePercent.toFixed(2)}%)`;
                      }
                    }catch(e){}
                  }

                  setInterval(refreshLive, REFRESH_MS);

                  const refreshEl = document.getElementById("refreshMs");
                  if(refreshEl && refreshEl.innerText === "‚Äî") refreshEl.innerText = String(REFRESH_MS);
                })();
              </script>
            <% }) %>
          </tbody>
        </table>

        <div class="table-footer">
          <div style="font-size:12px; color:rgba(255,255,255,.55);">
            Showing page <%= page %> of <%= totalPages %>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <% if (page > 1) { %>
              <a class="btn small" href="/?page=<%= page - 1 %>">‚¨Ö Previous</a>
            <% } %>
            <% if (page < totalPages) { %>
              <a class="btn small" href="/?page=<%= page + 1 %>">Next ‚û°</a>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NEWS SECTION (kept) -->
  <div class="news-wrap">
    <div class="news-panel">
      <div class="news-inner">

        <!-- Latest News -->
        <div style="margin-bottom:22px;">
          <div class="news-title-row">
            <h2>üì∞ Latest News</h2>
            <span>Top stories</span>
          </div>
          <div id="latestNewsList" style="display:flex; flex-direction:column; gap:12px;">
            <p style="color: rgba(255,255,255,.55); text-align:center;">Loading latest news...</p>
          </div>
        </div>

        <div style="border-top:1px solid rgba(255,255,255,.08); margin:20px 0;"></div>

        <!-- Trending News -->
        <div style="margin-bottom:22px;">
          <div class="news-title-row">
            <h2>üî• Trending News</h2>
            <span>Most talked about</span>
          </div>
          <div id="trendingNewsList" style="display:flex; flex-direction:column; gap:12px;">
            <p style="color: rgba(255,255,255,.55); text-align:center;">Loading trending news...</p>
          </div>
        </div>

        <div style="border-top:1px solid rgba(255,255,255,.08); margin:20px 0;"></div>

        <!-- Search News -->
        <div>
          <div class="news-title-row">
            <h2>üîç Search News</h2>
            <span>By ticker or company</span>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px;">
            <input type="text" id="newsSearch"
              placeholder="Search by ticker (AAPL) or company name (Apple)..."
              style="
                flex:1; min-width:260px;
                padding:12px 14px;
                background: rgba(255,255,255,.03);
                border: 1px solid rgba(255,255,255,.10);
                border-radius: 12px;
                color: rgba(255,255,255,.9);
                font-family: 'Inter', Arial, sans-serif;
                font-size: 14px;
                outline:none;
              "
            />
            <button class="btn primary" onclick="searchNews()">üîç Search</button>
          </div>

          <div id="newsHint" style="color: rgba(255,255,255,.55); margin-bottom: 12px; font-size: 13px;">
            üí° Search for ANY stock ticker or company name (AAPL, MSFT, XYZ, etc.)
          </div>

          <div id="newsList" style="display:flex; flex-direction:column; gap:12px;"></div>
        </div>

      </div>
    </div>
  </div>

  <div class="footer">
    Data sources: Finnhub (live quotes), Finnhub candles (if available) / Stooq (historical fallback), TradingView (full charts).<br>
    StockAI is a student prototype for informational/educational purposes only ‚Äî not financial advice, no trade execution.
  </div>

  <script>
    // Quick ticker search (keeps your button behavior)
    (function(){
      const input = document.getElementById("quickSearch");
      const btn = document.getElementById("quickGo");
      if(!input || !btn) return;

      function go(){
        const q = String(input.value||"").trim().toUpperCase();
        if(!q) return;
        location.href = "/chart/" + encodeURIComponent(q);
      }

      btn.addEventListener("click", go);
      input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") go(); });
    })();
  </script>

  
  <script>
    //  Last updated (left panel)
    (function(){
      const el = document.getElementById("lastUpdated");
      if(!el) return;
      const update = () => {
        const now = new Date();
        el.textContent = `Updated ${now.toLocaleTimeString()}`;
      };
      update();
      setInterval(update, 1000);
    })();
  </script>

  <script>
    //  NEW: Market status + clock (US market hours, NY time)
    (function(){
      const dot = document.getElementById("mktDot");
      const txt = document.getElementById("mktStatus");
      const time = document.getElementById("marketTime");
      if(!dot || !txt || !time) return;

      function isUSOpen(){
        const parts = new Intl.DateTimeFormat("en-US",{
          timeZone:"America/New_York",
          weekday:"short",
          hour:"2-digit",
          minute:"2-digit",
          hour12:false
        }).formatToParts(new Date());

        const get = (t)=>parts.find(x=>x.type===t)?.value;
        const day = get("weekday");
        const h = Number(get("hour"));
        const m = Number(get("minute"));
        if(!["Mon","Tue","Wed","Thu","Fri"].includes(day)) return false;

        const mins = h*60+m;
        // 9:30am - 4:00pm ET
        return mins >= (9*60+30) && mins < (16*60);
      }

      function tick(){
        const open = isUSOpen();
        dot.className = "status-dot " + (open ? "open" : "closed");
        txt.textContent = "US Market: " + (open ? "Open" : "Closed");
        time.textContent = new Date().toLocaleTimeString();
      }

      tick();
      setInterval(tick, 1000);
    })();
  </script>

  <script>
    //  TICKER (kept)
    (function(){
      const tickerEl = document.getElementById("ticker");
      if(!tickerEl) return;

      const REFRESH_MS = 20000;

      function renderItem(item){
        if(!item || !item.ok){
          return `
            <div class="ticker-item">
              <span class="ticker-sym">${item?.symbol ?? "‚Äî"}</span>
              <span class="ticker-price">‚Äî</span>
              <span class="ticker-chg">Unavailable</span>
            </div>
          `;
        }

        const price = Number(item.c);
        const chg   = Number(item.d);
        const pct   = Number(item.dp);

        const up = Number.isFinite(chg) && chg > 0;
        const down = Number.isFinite(chg) && chg < 0;
        const cls = up ? "t-up" : (down ? "t-down" : "");

        const signChg = up ? "+" : "";
        const signPct = up ? "+" : "";

        return `
          <div class="ticker-item">
            <span class="ticker-sym">${item.symbol}</span>
            <span class="ticker-price">${Number.isFinite(price) ? price.toFixed(2) : "‚Äî"}</span>
            <span class="ticker-chg ${cls}">
              ${Number.isFinite(chg) ? `${signChg}${chg.toFixed(2)}` : "‚Äî"}
              ${Number.isFinite(pct) ? `(${signPct}${pct.toFixed(2)}%)` : ""}
            </span>
          </div>
        `;
      }

      async function loadTicker(){
        try{
          const r = await fetch(`/api/ticker`);
          if(!r.ok) throw new Error("Ticker API failed");

          const payload = await r.json();
          const rows = Array.isArray(payload?.symbols) ? payload.symbols : [];

          if(rows.length === 0){
            tickerEl.innerHTML = `
              <div class="ticker-item">
                <span class="ticker-sym">Ticker</span>
                <span class="ticker-price">‚Äî</span>
                <span class="ticker-chg">No data</span>
              </div>
            `;
            return;
          }

          const html = rows.map(renderItem).join("");
          tickerEl.innerHTML = html + html;

          const tEl = document.getElementById("tickerRefreshMs");
          if(tEl) tEl.innerText = String(REFRESH_MS);
        } catch(e){
          tickerEl.innerHTML = `
            <div class="ticker-item">
              <span class="ticker-sym">Ticker</span>
              <span class="ticker-price">‚Äî</span>
              <span class="ticker-chg">Error loading</span>
            </div>
          `;
        }
      }

      loadTicker();
      setInterval(loadTicker, REFRESH_MS);
    })();
  </script>

  <script>
    // =========================================================
    // NEWS & SENTIMENT (kept)
    // ‚úÖ FIXED analyzeNewsArticle() to be stable + simple
    // =========================================================
    async function loadLatestNews() {
      const list = document.getElementById('latestNewsList');
      try {
        const tickers = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'TSLA', 'META', 'NFLX', 'JPM', 'V'];
        const allArticles = [];

        for (const ticker of tickers) {
          try {
            const response = await fetch(`/api/news/${ticker}`);
            const articles = await response.json();
            if (articles && articles.length > 0) allArticles.push(...articles);
          } catch (e) {}
        }

        if (allArticles.length === 0) {
          list.innerHTML = '<p style="color: rgba(255,255,255,.55); text-align: center;">No news available at the moment.</p>';
          return;
        }

        list.innerHTML = allArticles.slice(0, 5).map((article, index) => `
          <div class="news-item" id="latest-news-${index}">
            <div class="news-header">
              <h4>${article.title}</h4>
              <span class="news-source">${article.source}</span>
            </div>
            <p>${article.description}</p>
            <div class="news-actions">
              <button class="btn-analyze-news" onclick="analyzeNewsArticle('latest-${index}', '${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">Analyse</button>
              <button class="btn-save-news" id="save-latest-${index}" style="display:none;" onclick="saveNewsAsAnalysis('${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">Save Analysis</button>
            </div>
            <div class="analysis-result" id="analysis-latest-${index}" style="display:none;"></div>
          </div>
        `).join('');
      } catch (error) {
        list.innerHTML = '<p style="color: #e53935; text-align: center;">Error loading latest news.</p>';
      }
    }

    async function loadTrendingNews() {
      const list = document.getElementById('trendingNewsList');
      try {
        const trendingTickers = ['NVDA', 'PLTR', 'DDOG', 'NET', 'COIN', 'MSTR', 'ARM', 'SMCI'];
        const allTrendingArticles = [];

        for (const ticker of trendingTickers) {
          try {
            const response = await fetch(`/api/news/${ticker}`);
            const articles = await response.json();
            if (articles && articles.length > 0) {
              articles.forEach(art => art.ticker = ticker);
              allTrendingArticles.push(...articles);
            }
          } catch (e) {}
        }

        if (allTrendingArticles.length === 0) {
          list.innerHTML = '<p style="color: rgba(255,255,255,.55); text-align: center;">No trending news available at the moment.</p>';
          return;
        }

        const a = allTrendingArticles[0];

        list.innerHTML = `
          <div class="news-item trending-news-item" id="trending-news-0">
            <div style="position:absolute; bottom:12px; right:12px; background:linear-gradient(135deg,#ff6b35,#d63031); color:#fff; padding:6px 10px; border-radius:999px; font-size:11px; font-weight:900;">
              üî• Trending
            </div>
            <div class="news-header">
              <h4>${a.title}</h4>
              <span class="news-source">${a.source}</span>
            </div>
            <p>${a.description}</p>
            <div class="news-actions">
              <button class="btn-analyze-news" onclick="analyzeNewsArticle('trending-0', '${a.title.replace(/'/g, "\\'")}', '${a.description.replace(/'/g, "\\'")}')">Analyse</button>
              <button class="btn-save-news" id="save-trending-0" style="display:none;" onclick="saveNewsAsAnalysis('${a.title.replace(/'/g, "\\'")}', '${a.description.replace(/'/g, "\\'")}')">Save Analysis</button>
            </div>
            <div class="analysis-result" id="analysis-trending-0" style="display:none;"></div>
          </div>
        `;
      } catch (error) {
        list.innerHTML = '<p style="color: #e53935; text-align: center;">Error loading trending news.</p>';
      }
    }

    async function searchNews() {
      const query = document.getElementById('newsSearch').value.trim().toUpperCase();
      if (!query) return alert('Please enter a ticker or company name');

      const newsList = document.getElementById('newsList');
      newsList.innerHTML = '<p style="color: rgba(255,255,255,.55); text-align: center;">Searching news...</p>';

      try {
        const response = await fetch(`/api/news/${query}`);
        const articles = await response.json();

        if (!articles || articles.length === 0) {
          newsList.innerHTML = '<p style="color: rgba(255,255,255,.55); text-align: center;">No news found.</p>';
          return;
        }

        newsList.innerHTML = articles.slice(0, 5).map((article, index) => `
          <div class="news-item" id="search-news-${index}">
            <div class="news-header">
              <h4>${article.title}</h4>
              <span class="news-source">${article.source}</span>
            </div>
            <p>${article.description}</p>
            <div class="news-actions">
              <button class="btn-analyze-news" onclick="analyzeNewsArticle('search-${index}', '${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">Analyse</button>
              <button class="btn-save-news" id="save-search-${index}" style="display:none;" onclick="saveNewsAsAnalysis('${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">Save Analysis</button>
            </div>
            <div class="analysis-result" id="analysis-search-${index}" style="display:none;"></div>
          </div>
        `).join('');
      } catch (error) {
        newsList.innerHTML = '<p style="color: #e53935; text-align: center;">Error loading news. Please try again.</p>';
      }
    }

    window.addEventListener('keypress', function(event) {
      if (event.key === 'Enter' && document.activeElement.id === 'newsSearch') {
        searchNews();
      }
    });

    // ‚úÖ FIXED: stable element targeting (no messy fallbacks)
    async function analyzeNewsArticle(key, title, description) {
      const analysisEl = document.getElementById(`analysis-${key}`);
      if (!analysisEl) return;

      analysisEl.innerHTML = '<p style="color: rgba(255,255,255,.55); text-align:center; margin:0;">Analyzing sentiment...</p>';
      analysisEl.style.display = 'block';

      try {
        const response = await fetch('/api/analyze-sentiment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: title + ' ' + description, title })
        });

        if (!response.ok) throw new Error('API error');

        const result = await response.json();
        const sentiment = result.sentiment || 'NEUTRAL';
        const scores = result.scores || { positive: 0, negative: 0, neutral: 100 };
        const confidence = result.confidence || Math.max(scores.positive||0, scores.neutral||0, scores.negative||0);

        let sentimentColor = 'rgba(255,255,255,.55)';
        let sentimentBg = 'rgba(255,255,255,.06)';
        if (sentiment === 'POSITIVE') { sentimentColor = '#34d399'; sentimentBg = 'rgba(52,211,153,.12)'; }
        if (sentiment === 'NEGATIVE') { sentimentColor = '#f87171'; sentimentBg = 'rgba(248,113,113,.12)'; }

        analysisEl.innerHTML = `
          <div style="background:${sentimentBg}; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.10);">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <strong style="color:${sentimentColor}; font-size:14px;">Sentiment: ${sentiment}</strong>
              <span style="color:rgba(255,255,255,.75); font-weight:900; font-size:12px;">Confidence: ${Math.round(confidence)}%</span>
            </div>
            <div style="margin-top:10px; display:flex; gap:16px; flex-wrap:wrap;">
              <div><span style="color:#34d399; font-weight:900;">Positive</span><div style="color:#34d399; font-size:18px; font-weight:1000;">${Math.round(scores.positive || 0)}%</div></div>
              <div><span style="color:rgba(255,255,255,.65); font-weight:900;">Neutral</span><div style="color:rgba(255,255,255,.65); font-size:18px; font-weight:1000;">${Math.round(scores.neutral || 0)}%</div></div>
              <div><span style="color:#f87171; font-weight:900;">Negative</span><div style="color:#f87171; font-size:18px; font-weight:1000;">${Math.round(scores.negative || 0)}%</div></div>
            </div>
          </div>
        `;

        // show save button for this key
        const saveBtn = document.getElementById(`save-${key}`);
        if (saveBtn) saveBtn.style.display = 'inline-block';

      } catch (error) {
        analysisEl.innerHTML = '<p style="color:#f87171; margin:0;">Error analyzing sentiment.</p>';
      }
    }

    function saveNewsAsAnalysis(title, description) {
      const analyses = JSON.parse(localStorage.getItem('analyses') || '[]');
      analyses.push({
        id: Date.now(),
        title,
        content: description,
        notes: '',
        date: new Date().toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' }),
        isFavorite: false
      });
      localStorage.setItem('analyses', JSON.stringify(analyses));
      alert(`‚úÖ Analysis saved! Check your "Saved Analysis" in the Account page to view all saved articles.`);
    }

    window.addEventListener('DOMContentLoaded', function() {
      loadLatestNews();
      loadTrendingNews();

      // ‚úÖ Add purchase button functionality
      document.querySelectorAll('.purchase-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const symbol = this.dataset.symbol;
          const price = this.dataset.price;
          
          if (!symbol) {
            alert('Stock symbol not found');
            return;
          }

          // Redirect to trade page with symbol parameter
          // The trade page will load this symbol and fetch live price
          window.location.href = `/trade?symbol=${encodeURIComponent(symbol)}`;
        });
      });
    });
  </script>

  <%- include('partials/chatbot') %>
</body>
</html>
