<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head') %>
    <meta name="description" content="Market Sentiment - Live news and trends">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        header { background: rgba(0,0,0,0.8); color: white; padding: 2rem 0; margin-bottom: 2rem; }
        header h1 { margin: 0; font-size: 2.5rem; }
        header p { margin: 0.5rem 0 0; opacity: 0.9; }
        
        .search-container { background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .search-row { display: flex; gap: 1rem; flex-wrap: wrap; }
        .search-row input { flex: 1; min-width: 200px; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; }
        .search-row button { padding: 0.75rem 1.5rem; }
        
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .news-card { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s, box-shadow 0.2s; }
        .news-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        
        .card-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .source-badge { font-size: 0.75rem; background: #667eea; color: white; padding: 0.35rem 0.75rem; border-radius: 4px; font-weight: 600; }
        .time-badge { font-size: 0.85rem; color: #666; }
        
        .article-title { margin: 0.75rem 0; font-size: 1.1rem; font-weight: 600; }
        .article-title a { color: #667eea; text-decoration: none; cursor: pointer; transition: color 0.2s; }
        .article-title a:hover { color: #764ba2; text-decoration: underline; }
        
        .loading { text-align: center; padding: 3rem 2rem; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .error { background: #fee; color: #c33; padding: 1rem; border-radius: 4px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .empty { background: white; text-align: center; padding: 2rem; color: #666; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .results-header { color: white; margin-bottom: 1.5rem; font-size: 1.1rem; }
    </style>
</head>
<body>
    <%- include('./partials/navbar'); %>

    <header>
        <div class="container">
            <h1>Market Sentiment & News</h1>
            <p>Search live market news by ticker or keyword</p>
        </div>
    </header>

    <main class="container">
        <!-- Search Bar -->
        <div class="search-container">
            <h3 style="margin-top: 0;">Search News</h3>
            <div class="search-row">
                <input type="text" id="searchInput" placeholder="Enter stock ticker (AAPL, TSLA) or keyword" maxlength="50">
                <button class="btn btn-primary" onclick="performSearch()" style="flex-shrink: 0;">Search News</button>
            </div>
        </div>

        <!-- Results Container -->
        <div id="searchResults">
            <div class="empty">
                <p>ðŸ‘‡ Enter a stock ticker or keyword to see live market news</p>
                <p style="font-size: 0.9rem; opacity: 0.7;">Example: AAPL, TESLA, AI, Tech</p>
            </div>
        </div>
    </main>

    <footer style="text-align: center; padding: 2rem; color: white;">
        <p>&copy; 2026 Marketmind - Market Sentiment Analysis | News from Finnhub</p>
    </footer>

    <script>
        const FINNHUB_API_KEY = '<%= process.env.FINNHUB_API_KEY %>';
        let allArticles = [];

        // Allow Enter key to search
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim().toUpperCase();
            
            if (!query) {
                alert('Please enter a ticker or keyword');
                return;
            }

            if (!FINNHUB_API_KEY || FINNHUB_API_KEY.includes('undefined')) {
                showError('API key not configured');
                return;
            }

            showLoading();

            try {
                // Fetch news from Finnhub using company-news endpoint
                const response = await fetch(
                    `https://finnhub.io/api/v1/company-news?symbol=${query}&from=2026-01-20&to=2026-01-30&token=${FINNHUB_API_KEY}`
                );

                if (!response.ok) {
                    throw new Error('News not found for this ticker');
                }

                const data = await response.json();

                if (!data || data.length === 0) {
                    showEmpty(`No news found for: ${query}`);
                    return;
                }

                // Process articles
                allArticles = data.slice(0, 12).map(article => ({
                    title: article.headline || 'Untitled',
                    url: article.url || '#',
                    source: article.source || 'News',
                    timeAgo: formatTimeAgo(article.datetime),
                    summary: article.summary || ''
                }));

                renderNews();
                
            } catch (error) {
                console.error('Search error:', error);
                showError(`Unable to fetch news: ${error.message}`);
            }
        }

        function formatTimeAgo(unixTimestamp) {
            const date = new Date(unixTimestamp * 1000);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        function renderNews() {
            if (allArticles.length === 0) {
                showEmpty('No articles to display');
                return;
            }

            let html = `<div class="results-header">Found ${allArticles.length} articles</div><div class="news-grid">`;

            allArticles.forEach(article => {
                html += `
                    <div class="news-card">
                        <div class="card-meta">
                            <span class="source-badge">${article.source}</span>
                            <span class="time-badge">${article.timeAgo}</span>
                        </div>
                        <h3 class="article-title">
                            <a href="${article.url}" target="_blank" rel="noopener noreferrer">${article.title}</a>
                        </h3>
                        <p style="font-size: 0.9rem; color: #666; margin: 0.75rem 0; line-height: 1.5;">
                            ${article.summary.substring(0, 120)}...
                        </p>
                        <a href="${article.url}" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: none; font-weight: 600; font-size: 0.9rem;">
                            Read full article â†’
                        </a>
                    </div>
                `;
            });

            html += '</div>';
            document.getElementById('searchResults').innerHTML = html;
        }

        function showLoading() {
            document.getElementById('searchResults').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Searching news...</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('searchResults').innerHTML = `<div class="error">${message}</div>`;
        }

        function showEmpty(message) {
            document.getElementById('searchResults').innerHTML = `
                <div class="empty">
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
