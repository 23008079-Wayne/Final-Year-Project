<!DOCTYPE html>
<html lang="en">
<head>
  <title>StockAI Terminal â€“ Market</title>
  <%- include('partials/head') %>

  <!-- TradingView chart lib -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

  <style>
    :root{
      --bg:#070707;
      --panel:rgba(18,18,18,.85);
      --panel2:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.10);
      --soft:rgba(255,255,255,.06);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.60);
      --accent:#00eaff;
      --pos:#34d399;
      --neg:#f87171;
      --radius:16px;

      --nav-height: 64px;
      --ticker-height: 44px;
    }

    body{
      margin:0;
      background:
        radial-gradient(1100px 700px at 10% 0%, rgba(0,234,255,.14), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(0,234,255,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:"Inter", Arial, sans-serif;
    }

    /* ================== NAVBAR (match homepage theme) ================== */
    .nav{
      height: var(--nav-height);
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 28px;
      background: rgba(10,10,10,.88);
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      font-weight:1000;
      letter-spacing:0.5px;
      font-size:18px;
      color:var(--accent);
    }
    .nav-links{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .nav-links a{
      color:rgba(255,255,255,.85);
      text-decoration:none;
      font-size:13px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      transition:.15s;
      background: transparent;
      font-weight:900;
    }
    .nav-links a:hover{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      transform: translateY(-1px);
    }
    .cta{
      background: var(--accent);
      color:#000 !important;
      border-color: transparent !important;
      font-weight:1000;
    }

    /* ================== TICKER (match homepage theme) ================== */
    .ticker-wrap{
      position: sticky;
      top: var(--nav-height);
      z-index:15;
      height: var(--ticker-height);
      display:flex;
      align-items:center;
      background: rgba(10,10,10,.88);
      border-bottom:1px solid var(--border);
      overflow:hidden;
      white-space:nowrap;
      backdrop-filter: blur(8px);
    }
    .ticker{
      display:inline-flex;
      align-items:center;
      gap:20px;
      padding:10px 28px;
      will-change: transform;
      animation: ticker-scroll 22s linear infinite;
    }
    .ticker-wrap:hover .ticker{ animation-play-state: paused; }
    @keyframes ticker-scroll{
      from{ transform: translateX(0); }
      to{ transform: translateX(-50%); }
    }
    .ticker-item{
      display:inline-flex;
      align-items:baseline;
      gap:10px;
      padding-right:18px;
      border-right:1px solid var(--soft);
      min-width: 210px;
    }
    .ticker-sym{ font-weight:1000; letter-spacing:.2px; }
    .ticker-price{ font-weight:1000; }
    .ticker-chg{ font-weight:900; font-size:12px; }
    .t-up{ color:var(--pos); }
    .t-down{ color:var(--neg); }

    /* ================== LAYOUT ================== */
    .wrap{
      max-width:1200px;
      margin: 18px auto 28px;
      padding: 0 28px;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:16px;
      align-items:start;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    .panel-header{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .panel-header h2{
      margin:0;
      font-size:12px;
      font-weight:1000;
      letter-spacing:.45px;
      text-transform:uppercase;
      color:rgba(255,255,255,.85);
    }
    .panel-header span{
      font-size:12px;
      color:var(--muted);
    }

    .tag{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:rgba(255,255,255,.65);
      background: rgba(0,0,0,.25);
      white-space:nowrap;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    /* ================== WATCHLIST ================== */
    .list{
      padding:10px;
      display:grid;
      gap:8px;
      max-height: 72vh;
      overflow:auto;
    }

    .item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      text-decoration:none;
      color:rgba(255,255,255,.88);
      transition:.15s;
    }
    .item:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.12);
      transform: translateY(-1px);
    }
    .item.active{
      border-color: rgba(0,234,255,.55);
      box-shadow:0 0 24px rgba(0,234,255,0.12);
      background: rgba(0,234,255,.06);
    }

    .sym{
      font-weight:1000;
      color:var(--accent);
      letter-spacing:.2px;
    }
    .mini{
      font-size:12px;
      color:var(--muted);
    }

    /* ================== CHART AREA ================== */
    .chart-area{ padding:14px; }
    .chart-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .chart-title{
      margin:0;
      font-size:18px;
      font-weight:1000;
      color:rgba(255,255,255,.92);
      letter-spacing:.2px;
    }
    .subtitle{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      max-width:820px;
    }

    .quote{
      text-align:right;
      font-size:13px;
      color:rgba(255,255,255,.78);
      line-height:1.5;
      min-width: 220px;
    }
    .quote strong{ color:#fff; font-weight:1000; }
    .pos{ color:var(--pos); }
    .neg{ color:var(--neg); }

    .tv-wrap{
      height: 72vh;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }

    /* ================== BUTTONS (homepage style) ================== */
    .buy-row{
      display:flex;
      gap:8px;
      margin-top:10px;
      justify-content:flex-end;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      text-decoration:none;
      transition:.15s;
      white-space:nowrap;
    }
    .btn:hover{ transform:translateY(-1px); background:rgba(255,255,255,.06); }
    .btn.primary{
      background: var(--accent);
      color:#000;
      border-color:transparent;
      font-weight:1000;
    }
    
    details summary{
      cursor:pointer;
      list-style:none;
      user-select:none;
      font-weight:900;
      color:rgba(255,255,255,.82);
    }
    details summary::-webkit-details-marker{ display:none; }

    .footer{
      border-top:1px solid var(--border);
      padding:16px 28px;
      color:var(--muted);
      font-size:12px;
      background: rgba(0,0,0,.35);
      margin-top:18px;
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
      .quote{ text-align:left; }
      .tv-wrap{ height: 60vh; }
    }
  </style>
</head>

<body>

  <!-- Navbar -->
  <%- include('partials/navbar') %>

  <!-- Ticker -->
  <div class="ticker-wrap" aria-label="Live market ticker">
    <div id="ticker" class="ticker"></div>
  </div>

  <div class="wrap">

    <!-- LEFT: Watchlist -->
    <div class="panel">
      <div class="panel-header">
        <h2>Market</h2>
        <span>Click to switch chart</span>
      </div>

      <div class="list">
        <% watchlist.forEach(s => { %>
          <a class="item <%= (s === symbol ? 'active' : '') %>" href="/market?symbol=<%= s %>">
            <div>
              <div class="sym"><%= s %></div>
              <div class="mini">Open interactive chart</div>
            </div>
            <div class="mini">â†—</div>
          </a>
        <% }) %>
      </div>
    </div>

    <!-- RIGHT: Interactive chart -->
    <div class="panel">
      <div class="panel-header">
        <h2>Interactive Market Chart</h2>
        <span class="tag" id="quoteStatus">Loading quoteâ€¦</span>
      </div>

      <div class="chart-area">
        <div class="chart-top">
          <div>
            <h1 class="chart-title">ðŸ“ˆ <%= symbol %></h1>
            <div class="subtitle">
              For visualisation and learning only. No trade execution or financial advice.
            </div>
          </div>

          <div class="quote" id="quoteBox">
            <div>Price: <strong id="qPrice">â€”</strong></div>
            <div>Change: <strong id="qChange">â€”</strong></div>
            <div>Source: <strong id="qSource">â€”</strong></div>

            <div class="buy-row">
              <button class="btn primary" id="buyBtn">Purchase</button>
            </div>
          </div>
        </div>

        <div class="tv-wrap" id="tv_chart_container"></div>

      </div>
    </div>

  </div>

  <div class="footer">
    Data sources: TradingView (interactive charts), Finnhub (live quotes) + Yahoo backup + cached fallback.<br>
  </div>

  <script>
    // TradingView interactive chart
    new TradingView.widget({
      autosize: true,
      symbol: "<%= symbol %>",
      interval: "D",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      locale: "en",
      toolbar_bg: "#0b0b0b",
      enable_publishing: false,
      withdateranges: true,
      hide_side_toolbar: false,
      allow_symbol_change: false,
      container_id: "tv_chart_container"
    });
  </script>

  <script>
    // Load live quote using your A+B+fallback endpoint
    (function(){
      const symbol = "<%= symbol %>";
      const statusEl = document.getElementById("quoteStatus");
      const priceEl = document.getElementById("qPrice");
      const changeEl = document.getElementById("qChange");
      const sourceEl = document.getElementById("qSource");

      async function load(){
        try{
          const r = await fetch(`/api/quote/${encodeURIComponent(symbol)}`);
          if(!r.ok) throw new Error("quote failed");
          const q = await r.json();

          // supports both {quote:{...}} and flat {...}
          const live = q.quote ? q.quote : q;

          const c  = Number(live?.c);
          const d  = Number(live?.d);
          const dp = Number(live?.dp);

          priceEl.textContent = Number.isFinite(c) ? `$${c.toFixed(2)}` : "â€”";

          const cls = (Number.isFinite(d) && d > 0) ? "pos" : ((Number.isFinite(d) && d < 0) ? "neg" : "");
          const sign = (Number.isFinite(d) && d > 0) ? "+" : "";
          const signp = (Number.isFinite(dp) && dp > 0) ? "+" : "";

          changeEl.className = cls;
          changeEl.textContent =
            (Number.isFinite(d) ? `${sign}${d.toFixed(2)}` : "â€”") +
            (Number.isFinite(dp) ? ` (${signp}${dp.toFixed(2)}%)` : "");

          sourceEl.textContent = q.source ? `${q.source}${q.stale ? " (stale)" : ""}` : "â€”";
          statusEl.textContent = "Live quote loaded";
        } catch(e){
          statusEl.textContent = "Quote unavailable (showing chart only)";
        }
      }

      load();
      setInterval(load, 15000);
    })();
  </script>
  <script>
    // Same ticker logic as home page
    (function(){
      const tickerEl = document.getElementById("ticker");
      if(!tickerEl) return;

      const REFRESH_MS = 15000;

      function renderItem(item){
        if(!item || !item.ok){
          return `
            <div class="ticker-item">
              <span class="ticker-sym">${item?.symbol ?? "â€”"}</span>
              <span class="ticker-price">â€”</span>
              <span class="ticker-chg">Unavailable</span>
            </div>
          `;
        }

        const price = Number(item.c);
        const chg   = Number(item.d);
        const pct   = Number(item.dp);

        const up = Number.isFinite(chg) && chg > 0;
        const down = Number.isFinite(chg) && chg < 0;
        const cls = up ? "t-up" : (down ? "t-down" : "");

        const signChg = up ? "+" : "";
        const signPct = up ? "+" : "";

        return `
          <div class="ticker-item">
            <span class="ticker-sym">${item.symbol}</span>
            <span class="ticker-price">${Number.isFinite(price) ? price.toFixed(2) : "â€”"}</span>
            <span class="ticker-chg ${cls}">
              ${Number.isFinite(chg) ? `${signChg}${chg.toFixed(2)}` : "â€”"}
              ${Number.isFinite(pct) ? `(${signPct}${pct.toFixed(2)}%)` : ""}
            </span>
          </div>
        `;
      }

      async function loadTicker(){
        try{
          const r = await fetch(`/api/ticker`);
          if(!r.ok) throw new Error("Ticker API failed");

          const payload = await r.json();
          const rows = Array.isArray(payload?.symbols) ? payload.symbols : [];

          if(rows.length === 0){
            tickerEl.innerHTML = `
              <div class="ticker-item">
                <span class="ticker-sym">Ticker</span>
                <span class="ticker-price">â€”</span>
                <span class="ticker-chg">No data</span>
              </div>
            `;
            return;
          }

          const html = rows.map(renderItem).join("");
          tickerEl.innerHTML = html + html;
        }catch(e){
          tickerEl.innerHTML = `
            <div class="ticker-item">
              <span class="ticker-sym">Ticker</span>
              <span class="ticker-price">â€”</span>
              <span class="ticker-chg">Error loading</span>
            </div>
          `;
        }
      }

      loadTicker();
      setInterval(loadTicker, REFRESH_MS);
    })();
  </script>

</body>
</html>
