<!DOCTYPE html>
<html>
<head>
  <title>StockAI Terminal ‚Äì Market</title>

  <!-- TradingView chart lib -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

  <style>
    :root{
      --nav-height: 64px;
      --ticker-height: 44px;
    }

    body{
      margin:0;
      background:#0b0b0b;
      color:#eee;
      font-family:"Inter", Arial, sans-serif;
    }

    /*  Same navbar styling as home.ejs */
    .nav{
      height: var(--nav-height);
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:0 28px;
      background:rgba(15,15,15,0.95);
      border-bottom:1px solid #222;
      position:sticky;
      top:0;
      z-index:20;
      backdrop-filter: blur(6px);
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      font-weight:700; letter-spacing:0.5px;
      font-size:18px; color:#00eaff;
    }
    .nav-links{ display:flex; gap:16px; align-items:center; }
    .nav-links a{
      color:#ddd; text-decoration:none; font-size:14px;
      padding:8px 12px; border-radius:8px;
      border:1px solid transparent; transition:0.2s;
    }
    .nav-links a:hover{ border:1px solid #2a2a2a; background:#121212; }
    .cta{ background:#00eaff; color:#000 !important; font-weight:700; }

    /*  Same ticker bar style as home.ejs */
    .ticker-wrap{
      position: sticky;
      top: var(--nav-height);
      z-index:15;
      height: var(--ticker-height);
      display:flex; align-items:center;
      background:#0f0f0f;
      border-bottom:1px solid #222;
      overflow:hidden; white-space:nowrap;
      box-shadow: 0 10px 18px rgba(0,0,0,0.25);
    }
    .ticker{
      display:inline-flex;
      align-items:center;
      gap:20px;
      padding:10px 28px;
      will-change: transform;
      animation: ticker-scroll 22s linear infinite;
    }
    .ticker-wrap:hover .ticker{ animation-play-state: paused; }
    @keyframes ticker-scroll{
      from{ transform: translateX(0); }
      to{ transform: translateX(-50%); }
    }
    .ticker-item{
      display:inline-flex;
      align-items:baseline;
      gap:10px;
      padding-right:18px;
      border-right:1px solid rgba(255,255,255,0.08);
      min-width: 190px;
    }
    .ticker-sym{ font-weight:800; color:#eaeaea; font-size:14px; }
    .ticker-price{ font-weight:800; color:#fff; font-size:14px; }
    .ticker-chg{ font-weight:700; font-size:12px; }
    .t-up{ color:#4caf50; }
    .t-down{ color:#e53935; }

    /* Layout */
    .wrap{
      max-width:1200px;
      margin: 18px auto 28px;
      padding: 0 28px;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:16px;
    }

    .panel{
      background:#121212;
      border:1px solid #222;
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 0 18px rgba(255,255,255,0.04);
    }

    .panel-header{
      padding:14px 16px;
      border-bottom:1px solid #222;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .panel-header h2{
      margin:0; font-size:14px; letter-spacing:0.3px; color:#eaeaea;
    }
    .panel-header span{ font-size:12px; color:#999; }

    /* Watchlist */
    .list{
      padding:10px;
      display:grid;
      gap:8px;
      max-height: 72vh;
      overflow:auto;
    }
    .item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #222;
      background:#101010;
      text-decoration:none;
      color:#eaeaea;
      transition:0.15s;
    }
    .item:hover{ background:#161616; border-color:#2a2a2a; }
    .item.active{
      border-color:#00eaff;
      box-shadow:0 0 18px rgba(0,234,255,0.12);
    }
    .sym{ font-weight:800; color:#00eaff; }
    .mini{ font-size:12px; color:#aaa; }

    /* Chart */
    .chart-area{ padding:14px; }
    .chart-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    .chart-title{
      margin:0;
      font-size:18px;
      font-weight:800;
      color:#eaeaea;
    }
    .subtitle{
      margin-top:6px;
      color:#bdbdbd;
      font-size:13px;
      line-height:1.4;
      max-width:820px;
    }

    .quote{
      text-align:right;
      font-size:13px;
      color:#cfcfcf;
      line-height:1.4;
    }
    .quote strong{ color:#fff; }
    .pos{ color:#4caf50; }
    .neg{ color:#e53935; }

    .tv-wrap{
      height: 72vh;
      border-radius:14px;
      overflow:hidden;
      border:1px solid #222;
      background:#0f0f0f;
    }

    /* MAS disclosure */
    .mas-box{
      margin-top:12px;
      background:#101010;
      border:1px solid #222;
      border-radius:14px;
      padding:12px 12px;
      color:#bdbdbd;
      font-size:13px;
      line-height:1.5;
    }
    details summary{ cursor:pointer; list-style:none; }
    details summary::-webkit-details-marker{ display:none; }

    /* Purchase button (MAS safe: simulated) */
    .buy-row{
      display:flex;
      gap:8px;
      margin-top:10px;
      justify-content:flex-end;
    }
    .btn{
      display:inline-block;
      text-decoration:none;
      font-size:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #2a2a2a;
      color:#ddd;
      background:#111;
      transition:0.2s;
      cursor:pointer;
    }
    .btn:hover{ background:#151515; }
    .btn.primary{
      background:#00eaff;
      color:#000;
      font-weight:800;
      border:1px solid transparent;
    }

    .footer{
      border-top:1px solid #222;
      padding:16px 28px;
      color:#999;
      font-size:12px;
      background:#0f0f0f;
      margin-top:18px;
    }
  </style>
</head>

<body>

  <!--  Navbar -->
  <div class="nav">
    <div class="brand"> StockAI Terminal</div>
    <div class="nav-links">
      <a href="/" >Home</a>
      <a href="/market" class="cta">Market</a>
      <a href="/portfolio">Portfolio</a>
      <a href="/market#mas">MAS Disclosures</a>
    </div>
  </div>

  <!--  Same ticker bar (uses /api/ticker) -->
  <div class="ticker-wrap" aria-label="Live market ticker">
    <div id="ticker" class="ticker"></div>
  </div>

  <div class="wrap">

    <!-- LEFT: Watchlist -->
    <div class="panel">
      <div class="panel-header">
        <h2>Watchlist</h2>
        <span>Click to switch chart</span>
      </div>

      <div class="list">
        <% watchlist.forEach(s => { %>
          <a class="item <%= (s === symbol ? 'active' : '') %>" href="/market?symbol=<%= s %>">
            <div>
              <div class="sym"><%= s %></div>
              <div class="mini">Open interactive chart</div>
            </div>
            <div class="mini">‚Üó</div>
          </a>
        <% }) %>
      </div>
    </div>

    <!-- RIGHT: Interactive chart -->
    <div class="panel">
      <div class="panel-header">
        <h2>Interactive Market Chart</h2>
        <span id="quoteStatus">Loading quote‚Ä¶</span>
      </div>

      <div class="chart-area">
        <div class="chart-top">
          <div>
            <h1 class="chart-title">üìà <%= symbol %></h1>
            <div class="subtitle">
              For visualisation and learning only. No trade execution or financial advice.
            </div>
          </div>

          <div class="quote" id="quoteBox">
            <div>Price: <strong id="qPrice">‚Äî</strong></div>
            <div>Change: <strong id="qChange">‚Äî</strong></div>
            <div>Source: <strong id="qSource">‚Äî</strong></div>

            <div class="buy-row">
              <button class="btn primary" id="buyBtn">Purchase (Simulated)</button>
            </div>
          </div>
        </div>

        <div class="tv-wrap" id="tv_chart_container"></div>

        <!-- MAS disclosure -->
        <div class="mas-box" id="mas">
          <details>
            <summary>
              View MAS-aligned disclosure: data sources, limitations, and user responsibility (click to expand)
            </summary>
            <div style="margin-top:10px;">
              <strong>Disclaimer:</strong> StockAI is informational/educational only and does not provide financial advice.<br><br>
              <strong>No Trade Execution:</strong> The ‚ÄúPurchase‚Äù button is a simulated demo only. It does not place real orders.<br><br>
              <strong>Data Sources:</strong> TradingView for interactive charts; live quotes via Finnhub with Yahoo Finance backup and cached fallback.<br><br>
              <strong>Limitations:</strong> Data may be delayed or affected by API limits. Past performance does not guarantee future results.<br><br>
              <strong>User Responsibility:</strong> Users remain responsible for decisions and should consult licensed professionals if needed.
            </div>
          </details>
        </div>
      </div>
    </div>

  </div>

  <div class="footer">
    Data sources: TradingView (interactive charts), Finnhub (live quotes) + Yahoo backup + cached fallback.<br>
    StockAI is a student prototype for informational/educational purposes only ‚Äî not financial advice, no trade execution.
  </div>

  <script>
    //  TradingView interactive chart (same as chart.ejs idea)
    new TradingView.widget({
      autosize: true,
      symbol: "<%= symbol %>",
      interval: "D",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      locale: "en",
      toolbar_bg: "#0b0b0b",
      enable_publishing: false,
      withdateranges: true,
      hide_side_toolbar: false,
      allow_symbol_change: false,
      container_id: "tv_chart_container"
    });
  </script>

  <script>
    //  Load live quote using your A+B+fallback endpoint
    (function(){
      const symbol = "<%= symbol %>";
      const statusEl = document.getElementById("quoteStatus");
      const priceEl = document.getElementById("qPrice");
      const changeEl = document.getElementById("qChange");
      const sourceEl = document.getElementById("qSource");

      async function load(){
        try{
          const r = await fetch(`/api/quote/${encodeURIComponent(symbol)}`);
          if(!r.ok) throw new Error("quote failed");
          const q = await r.json();

          const c = Number(q.c);
          const d = Number(q.d);
          const dp = Number(q.dp);

          priceEl.textContent = Number.isFinite(c) ? `$${c.toFixed(2)}` : "‚Äî";

          const cls = (Number.isFinite(d) && d > 0) ? "pos" : ((Number.isFinite(d) && d < 0) ? "neg" : "");
          const sign = (Number.isFinite(d) && d > 0) ? "+" : "";
          const signp = (Number.isFinite(dp) && dp > 0) ? "+" : "";

          changeEl.className = cls;
          changeEl.textContent =
            (Number.isFinite(d) ? `${sign}${d.toFixed(2)}` : "‚Äî") +
            (Number.isFinite(dp) ? ` (${signp}${dp.toFixed(2)}%)` : "");

          sourceEl.textContent = q.source ? `${q.source}${q.stale ? " (stale)" : ""}` : "‚Äî";
          statusEl.textContent = "Live quote loaded";
        } catch(e){
          statusEl.textContent = "Quote unavailable (showing chart only)";
        }
      }

      load();
      setInterval(load, 15000); //  slower polling to reduce rate limits
    })();
  </script>

  <script>
    //  Simulated purchase button (MAS-safe: no trade execution)
    (function(){
      const btn = document.getElementById("buyBtn");
      if(!btn) return;

      btn.addEventListener("click", () => {
        alert("Simulated purchase only \nNo real trade is executed.\n(For student prototype + MAS-aligned demo)");
      });
    })();
  </script>

  <script>
    //  Same ticker logic as your home page (use /api/ticker)
    (function(){
      const tickerEl = document.getElementById("ticker");
      if(!tickerEl) return;

      const REFRESH_MS = 15000; //  slowed down (15s)

      function renderItem(item){
        if(!item || !item.ok){
          return `
            <div class="ticker-item">
              <span class="ticker-sym">${item?.symbol ?? "‚Äî"}</span>
              <span class="ticker-price">‚Äî</span>
              <span class="ticker-chg">Unavailable</span>
            </div>
          `;
        }

        const price = Number(item.c);
        const chg   = Number(item.d);
        const pct   = Number(item.dp);

        const up = Number.isFinite(chg) && chg > 0;
        const down = Number.isFinite(chg) && chg < 0;
        const cls = up ? "t-up" : (down ? "t-down" : "");

        const signChg = up ? "+" : "";
        const signPct = up ? "+" : "";

        return `
          <div class="ticker-item">
            <span class="ticker-sym">${item.symbol}</span>
            <span class="ticker-price">${Number.isFinite(price) ? price.toFixed(2) : "‚Äî"}</span>
            <span class="ticker-chg ${cls}">
              ${Number.isFinite(chg) ? `${signChg}${chg.toFixed(2)}` : "‚Äî"}
              ${Number.isFinite(pct) ? `(${signPct}${pct.toFixed(2)}%)` : ""}
            </span>
          </div>
        `;
      }

      async function loadTicker(){
        try{
          const r = await fetch(`/api/ticker`);
          if(!r.ok) throw new Error("Ticker API failed");

          const payload = await r.json();
          const rows = Array.isArray(payload?.symbols) ? payload.symbols : [];

          if(rows.length === 0){
            tickerEl.innerHTML = `
              <div class="ticker-item">
                <span class="ticker-sym">Ticker</span>
                <span class="ticker-price">‚Äî</span>
                <span class="ticker-chg">No data</span>
              </div>
            `;
            return;
          }

          const html = rows.map(renderItem).join("");
          tickerEl.innerHTML = html + html;
        }catch(e){
          tickerEl.innerHTML = `
            <div class="ticker-item">
              <span class="ticker-sym">Ticker</span>
              <span class="ticker-price">‚Äî</span>
              <span class="ticker-chg">Error loading</span>
            </div>
          `;
        }
      }

      loadTicker();
      setInterval(loadTicker, REFRESH_MS);
    })();
  </script>

</body>
</html>