<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head') %>
    <style>
        :root {
            --primary-bg: #0b0b0b;
            --secondary-bg: #121212;
            --tertiary-bg: #1a1a1a;
            --accent: #00eaff;
            --accent-dark: #00d4e8;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --success: #00ff41;
            --warning: #ffa500;
            --danger: #ff4444;
        }

        body {
            background: var(--primary-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .watchlist-container {
            padding: 40px 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 40px;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 20px;
        }

        .page-header h1 {
            color: var(--accent);
            font-size: 2.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-header p {
            color: var(--text-secondary);
            margin: 10px 0 0 0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--tertiary-bg);
            overflow-x: auto;
            padding-bottom: 0;
        }

        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--accent);
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Watchlist Section */
        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .watchlist-header h2 {
            color: var(--accent);
            font-size: 1.8rem;
            margin: 0;
        }

        .btn-add-stock {
            background: var(--accent);
            color: var(--primary-bg);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-add-stock:hover {
            background: var(--accent-dark);
            transform: translateY(-2px);
        }

        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stock-card {
            background: var(--secondary-bg);
            border: 1px solid var(--tertiary-bg);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stock-card:hover {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(0, 234, 255, 0.2);
            transform: translateY(-5px);
        }

        .stock-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), transparent);
        }

        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stock-symbol {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
        }

        .stock-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .btn-remove {
            background: transparent;
            color: var(--danger);
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .btn-remove:hover {
            transform: scale(1.2);
        }

        .stock-price {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
            margin: 10px 0;
        }

        .stock-change {
            font-size: 0.95rem;
            margin: 10px 0 15px 0;
            display: flex;
            gap: 10px;
        }

        .change-amount {
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--tertiary-bg);
        }

        .change-positive {
            color: var(--success);
        }

        .change-negative {
            color: var(--danger);
        }

        .btn-view-chart {
            width: 100%;
            padding: 8px;
            background: var(--tertiary-bg);
            color: var(--accent);
            border: 1px solid var(--accent);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view-chart:hover {
            background: var(--accent);
            color: var(--primary-bg);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--accent);
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Calendar Section */
        .calendar-container {
            background: var(--secondary-bg);
            border: 1px solid var(--tertiary-bg);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h3 {
            color: var(--accent);
            margin: 0;
        }

        .impact-filter {
            display: flex;
            gap: 10px;
        }

        .impact-btn {
            padding: 6px 12px;
            background: var(--tertiary-bg);
            border: 1px solid var(--tertiary-bg);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .impact-btn.active {
            background: var(--accent);
            color: var(--primary-bg);
            border-color: var(--accent);
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .event-item {
            padding: 15px;
            border-left: 3px solid var(--accent);
            background: var(--tertiary-bg);
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-details h4 {
            margin: 0 0 5px 0;
            color: var(--accent);
        }

        .event-details p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .event-impact {
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .impact-high {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
        }

        .impact-medium {
            background: rgba(255, 165, 0, 0.2);
            color: var(--warning);
        }

        .impact-low {
            background: rgba(0, 255, 65, 0.2);
            color: var(--success);
        }

        /* Market Insights */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .insight-card {
            background: var(--secondary-bg);
            border: 1px solid var(--tertiary-bg);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .insight-card:hover {
            border-color: var(--accent);
        }

        .sentiment-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sentiment-btn {
            padding: 8px 16px;
            background: var(--tertiary-bg);
            border: 1px solid var(--tertiary-bg);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sentiment-btn.active {
            background: var(--accent);
            color: var(--primary-bg);
        }

        .insight-title {
            color: var(--accent);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .insight-text {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* News Section */
        .news-search {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .news-search input {
            flex: 1;
            padding: 10px 15px;
            background: var(--tertiary-bg);
            border: 1px solid var(--tertiary-bg);
            border-radius: 4px;
            color: var(--text-primary);
        }

        .news-search input::placeholder {
            color: var(--text-secondary);
        }

        .news-search button {
            padding: 10px 20px;
            background: var(--accent);
            color: var(--primary-bg);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .news-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .news-item {
            background: var(--tertiary-bg);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            border-left: 3px solid var(--accent);
            position: relative;
        }

        .trending-news-item {
            border-left: 3px solid #ff6b35;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.2);
        }

        .news-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 10px;
        }

        .news-item h4 {
            margin: 0;
            color: var(--accent);
            flex: 1;
        }

        .news-source {
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: nowrap;
            padding: 2px 8px;
            background: rgba(0, 234, 255, 0.1);
            border-radius: 4px;
        }

        .news-item p {
            margin: 0 0 10px 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .news-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .analysis-result {
            margin-top: 15px;
            padding: 12px;
            background: rgba(0, 234, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(0, 234, 255, 0.2);
        }

        .btn-analyze-news {
            display: inline-block;
            padding: 8px 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-analyze-news:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-save-news {
            display: inline-block;
            padding: 8px 15px;
            background: var(--accent);
            color: var(--primary-bg);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-save-news:hover {
            background: var(--accent-dark);
            transform: translateY(-2px);
        }

        .sentiment-analysis {
            background: var(--tertiary-bg);
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: 12px;
            margin-top: 10px;
        }

        .analysis-notes {
            background: rgba(0, 234, 255, 0.05);
            border-left: 3px solid var(--accent);
            padding: 10px;
            margin-top: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-save-news:hover {
            background: var(--accent-dark);
            transform: translateY(-2px);
        }

        /* Saved Analyses */
        .analyses-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .analysis-card {
            background: var(--secondary-bg);
            border: 1px solid var(--tertiary-bg);
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .analysis-card:hover {
            border-color: var(--accent);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .analysis-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .analysis-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .btn-edit-analysis {
            background: var(--accent);
            color: var(--primary-bg);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .btn-edit-analysis:hover {
            background: #00d4ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 234, 255, 0.5);
        }
        .btn-favorite-analysis {
            background: #fbbf24;
            color: #1f2937;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .btn-favorite-analysis:hover {
            background: #fcd34d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
        }

        .btn-delete-analysis {
            background: #ef4444;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .btn-delete-analysis:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--secondary-bg);
            border: 1px solid var(--tertiary-bg);
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--tertiary-bg);
            padding-bottom: 15px;
        }

        .modal-header h2 {
            color: var(--accent);
            margin: 0;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .close-btn:hover {
            color: var(--accent);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 15px;
            background: var(--tertiary-bg);
            border: 1px solid var(--tertiary-bg);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-save {
            background: var(--accent);
            color: var(--primary-bg);
        }

        .btn-save:hover {
            background: var(--accent-dark);
        }

        .btn-cancel {
            background: var(--tertiary-bg);
            color: var(--text-primary);
            border: 1px solid var(--tertiary-bg);
        }

        .btn-cancel:hover {
            border-color: var(--accent);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--tertiary-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-dark);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-header h1 {
                font-size: 1.8rem;
            }

            .stock-grid {
                grid-template-columns: 1fr;
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .watchlist-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="watchlist-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-star"></i> My Watchlist</h1>
            <p>Track and manage your favorite stocks with real-time market data</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(event, 'watchlist')">
                <i class="fas fa-list"></i> Watchlist
            </button>
            <button class="tab-btn" onclick="switchTab(event, 'calendar')">
                <i class="fas fa-calendar"></i> Economic Calendar
            </button>
            <button class="tab-btn" onclick="switchTab(event, 'insights')">
                <i class="fas fa-chart-pie"></i> Market Insights
            </button>
        </div>

        <!-- Watchlist Tab -->
        <div id="watchlist" class="tab-content active">
            <div class="watchlist-header">
                <h2>Your Watched Stocks</h2>
                <button class="btn-add-stock" onclick="openAddStockModal()">
                    <i class="fas fa-plus"></i> Add Stock
                </button>
            </div>
            <div id="stockGrid" class="stock-grid">
                <!-- Stock cards will be dynamically added here -->
            </div>
            <div id="emptyWatchlist" class="empty-state" style="display:none;">
                <i class="fas fa-inbox"></i>
                <p>Your watchlist is empty. Add stocks to get started!</p>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div id="calendar" class="tab-content">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h3><i class="fas fa-calendar-alt"></i> Economic Calendar</h3>
                    <div class="impact-filter">
                        <button class="impact-btn active" onclick="filterByImpact('all')">All</button>
                        <button class="impact-btn" onclick="filterByImpact('high')">High Impact</button>
                        <button class="impact-btn" onclick="filterByImpact('medium')">Medium Impact</button>
                        <button class="impact-btn" onclick="filterByImpact('low')">Low Impact</button>
                    </div>
                </div>
                <div class="events-list" id="eventsList">
                    <!-- Economic events will be added here -->
                </div>
            </div>
        </div>

        <!-- Market Insights Tab -->
        <div id="insights" class="tab-content">
            <div class="sentiment-filter">
                <button class="sentiment-btn active" onclick="filterBySentiment('all')">All</button>
                <button class="sentiment-btn" onclick="filterBySentiment('bullish')">Bullish</button>
                <button class="sentiment-btn" onclick="filterBySentiment('neutral')">Neutral</button>
                <button class="sentiment-btn" onclick="filterBySentiment('bearish')">Bearish</button>
            </div>
            <div class="insights-grid" id="insightsGrid">
                <!-- Market insights will be added here -->
            </div>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div id="addStockModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Stock to Watchlist</h2>
                <button class="close-btn" onclick="closeModal('addStockModal')">&times;</button>
            </div>
            <div class="form-group">
                <label for="stockSymbolInput">Stock Symbol</label>
                <input type="text" id="stockSymbolInput" placeholder="e.g., AAPL" />
            </div>
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="closeModal('addStockModal')">Cancel</button>
                <button class="btn-modal btn-save" onclick="addStockFromModal()">Add Stock</button>
            </div>
        </div>
    </div>

    <!-- Save Analysis Modal -->
    <div id="saveAnalysisModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save Analysis</h2>
                <button class="close-btn" onclick="closeModal('saveAnalysisModal')">&times;</button>
            </div>
            <div class="form-group">
                <label for="analysisTitle">Title</label>
                <input type="text" id="analysisTitle" placeholder="e.g., Tech Stocks Analysis" />
            </div>
            <div class="form-group">
                <label for="analysisContent">Article Summary</label>
                <textarea id="analysisContent" placeholder="Article summary..." readonly></textarea>
            </div>
            <div class="form-group">
                <label for="analysisNotes">Your Notes</label>
                <textarea id="analysisNotes" placeholder="Add your personal notes and insights..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="closeModal('saveAnalysisModal')">Cancel</button>
                <button class="btn-modal btn-save" onclick="saveAnalysis()">Save Analysis</button>
            </div>
        </div>
    </div>

    <!-- Edit Analysis Modal -->
    <div id="editAnalysisModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Analysis</h2>
                <button class="close-btn" onclick="closeModal('editAnalysisModal')">&times;</button>
            </div>
            <div class="form-group">
                <label for="editAnalysisTitle">Title</label>
                <input type="text" id="editAnalysisTitle" placeholder="e.g., Tech Stocks Analysis" />
            </div>
            <div class="form-group">
                <label for="editAnalysisContent">Article Summary</label>
                <textarea id="editAnalysisContent" placeholder="Article summary..." readonly></textarea>
            </div>
            <div class="form-group">
                <label for="editAnalysisNotes">Your Notes</label>
                <textarea id="editAnalysisNotes" placeholder="Add your personal notes and insights..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="closeModal('editAnalysisModal')">Cancel</button>
                <button class="btn-modal btn-save" onclick="updateAnalysis()">Update Analysis</button>
            </div>
        </div>
    </div>

    <script>
        let currentFilter = 'all';
        let currentSentimentFilter = 'all';

        // Mock economic calendar events
        const economicEvents = [
            { date: '2024-01-15', event: 'US CPI Report', impact: 'high', country: 'USA', forecast: '3.4%', previous: '3.1%' },
            { date: '2024-01-16', event: 'Fed Interest Rate Decision', impact: 'high', country: 'USA', forecast: '5.25%', previous: '5.33%' },
            { date: '2024-01-17', event: 'Initial Jobless Claims', impact: 'medium', country: 'USA', forecast: '205K', previous: '202K' },
            { date: '2024-01-18', event: 'US Retail Sales', impact: 'high', country: 'USA', forecast: '2.2%', previous: '0.6%' },
            { date: '2024-01-19', event: 'Michigan Consumer Sentiment', impact: 'medium', country: 'USA', forecast: '66.5', previous: '64.6' },
        ];

        // Mock market insights
        const marketInsights = [
            { title: 'Tech Sector Rally', sentiment: 'bullish', content: 'Major tech stocks showing strong performance with AI boom driving growth.' },
            { title: 'Energy Prices Decline', sentiment: 'bearish', content: 'Oil prices expected to fall due to increased supply and lower demand.' },
            { title: 'Healthcare Consolidation', sentiment: 'neutral', content: 'Several healthcare mergers expected in Q1 2024.' },
            { title: 'Fed Policy Impact', sentiment: 'bullish', content: 'Potential rate cuts could boost equity markets in coming months.' },
            { title: 'Semiconductor Supply', sentiment: 'neutral', content: 'Chip manufacturers facing supply chain normalization.' },
        ];

        // Mock news data for different companies
        const newsDatabase = {
            'AAPL': [
                { title: 'Apple Announces Record iPhone Sales', description: 'Apple reported unprecedented iPhone sales in Q1 2024.', source: 'Financial Times' },
                { title: 'Apple to Invest in AI Research', description: 'Apple allocates $2B towards AI and machine learning development.', source: 'Bloomberg' },
                { title: 'Apple Expands Services Revenue', description: 'Services segment reaches all-time high with strong growth.', source: 'Reuters' },
                { title: 'Apple Launches New M4 Chips', description: 'Next-gen processors promise 40% performance improvement.', source: 'TechCrunch' },
                { title: 'Apple Stock Hits New High', description: 'AAPL stock closes at record level amid positive earnings.', source: 'MarketWatch' },
            ],
            'MSFT': [
                { title: 'Microsoft-OpenAI Partnership Expands', description: 'Microsoft invests additional billions in OpenAI development.', source: 'Reuters' },
                { title: 'Azure Cloud Services Growing', description: 'Azure revenue surges 29% year-over-year.', source: 'ZDNet' },
                { title: 'Microsoft Beats Earnings Estimates', description: 'MSFT stock rises on strong quarterly results.', source: 'CNBC' },
                { title: 'Copilot AI Integration Widespread', description: 'Microsoft Copilot now available in 100+ enterprise apps.', source: 'VentureBeat' },
                { title: 'Microsoft Teams Reaches 300M Users', description: 'Collaboration platform continues rapid growth.', source: 'The Verge' },
            ],
            'TSLA': [
                { title: 'Tesla Q1 Delivery Numbers Beat Expectations', description: 'Tesla delivers 500K vehicles in first quarter.', source: 'CNBC' },
                { title: 'Tesla Releases New Roadster', description: 'Revolutionary electric sports car announced for 2024.', source: 'Electrek' },
                { title: 'Elon Musk Discusses Gigafactory Expansion', description: 'Tesla plans to build 10 new factories worldwide.', source: 'Reuters' },
                { title: 'Tesla Stock Rallies on Sales Data', description: 'TSLA up 15% after strong delivery reports.', source: 'Seeking Alpha' },
                { title: 'Tesla Battery Tech Breakthrough', description: 'New battery design offers 50% more range.', source: 'TechCrunch' },
            ],
            'GOOGL': [
                { title: 'Google Announces Gemini 2.0', description: 'Next-gen AI model shows significant improvements.', source: 'Google Blog' },
                { title: 'Google Cloud Growth Accelerates', description: 'Cloud division revenue up 26% year-over-year.', source: 'Cloud Computing Today' },
                { title: 'YouTube Advertising Revenue Surges', description: 'Video platform generates record ad revenue.', source: 'Variety' },
                { title: 'Google Search Updates with AI', description: 'Search results now powered by advanced AI models.', source: 'Search Engine Land' },
                { title: 'Alphabet Beats Earnings Targets', description: 'GOOGL stock rises on strong financial results.', source: 'Yahoo Finance' },
            ],
            'AMZN': [
                { title: 'AWS Revenue Growth Accelerates', description: 'Cloud services division reports 20% growth.', source: 'AWS News' },
                { title: 'Amazon Prime Membership Hits 200M', description: 'E-commerce and streaming platform reaches milestone.', source: 'The Information' },
                { title: 'Amazon Logistics Network Expands', description: 'Investment in delivery infrastructure continues.', source: 'Supply Chain Dive' },
                { title: 'Amazon Studios Announces Major Productions', description: 'Content budget increased for streaming competitions.', source: 'Deadline' },
                { title: 'AMZN Stock Rally on Earnings Beat', description: 'Amazon reports better-than-expected quarterly results.', source: 'MarketWatch' },
            ],
            'NVDA': [
                { title: 'Nvidia GPU Demand at All-Time High', description: 'AI boom drives unprecedented chip demand.', source: 'Semiconductor Industry' },
                { title: 'Nvidia Launches Blackwell Architecture', description: 'Next-gen GPUs offer massive performance gains.', source: 'NVIDIA Blog' },
                { title: 'Nvidia Q1 Revenue Doubles', description: 'Data center segment shows explosive growth.', source: 'CNBC' },
                { title: 'Nvidia Partners with Major Tech Companies', description: 'NVIDIA collaborations expand across industry.', source: 'VentureBeat' },
                { title: 'NVDA Stock Becomes Trillion-Dollar Company', description: 'Market cap milestone reflects AI enthusiasm.', source: 'Bloomberg' },
            ],
            'META': [
                { title: 'Meta AI Research Breakthroughs', description: 'New AI models show dramatic improvements.', source: 'Meta Research' },
                { title: 'Instagram Reels Engagement Soars', description: 'Video format driving platform growth.', source: 'Social Media Today' },
                { title: 'Meta Investments in AR/VR Paying Off', description: 'Reality Labs showing signs of profitability.', source: 'The Information' },
                { title: 'Meta Stock Recovers Strongly', description: 'META up 50% from lows on AI optimism.', source: 'Seeking Alpha' },
                { title: 'Meta Expands Data Center Capacity', description: 'Infrastructure investments support AI growth.', source: 'Data Center Journal' },
            ],
            'NFLX': [
                { title: 'Netflix Subscriber Base Hits New Record', description: 'Streaming giant adds 10M new subscribers.', source: 'Netflix Investor Relations' },
                { title: 'Netflix Ad-Supported Tier Growing', description: 'Advertising revenue stream exceeds expectations.', source: 'Variety' },
                { title: 'Netflix Password-Sharing Crackdown Effective', description: 'Account sharing policies boost paid users.', source: 'Bloomberg' },
                { title: 'Netflix Announces New Originals', description: '100+ new shows greenlit for 2024.', source: 'Entertainment Weekly' },
                { title: 'NFLX Stock Reaches New Heights', description: 'Streaming leader continues strong rally.', source: 'Yahoo Finance' },
            ],
            'APPLE': [
                { title: 'Apple Announces Record iPhone Sales', description: 'Apple reported unprecedented iPhone sales in Q1 2024.', source: 'Financial Times' },
                { title: 'Apple to Invest in AI Research', description: 'Apple allocates $2B towards AI and machine learning development.', source: 'Bloomberg' },
                { title: 'Apple Expands Services Revenue', description: 'Services segment reaches all-time high with strong growth.', source: 'Reuters' },
                { title: 'Apple Launches New M4 Chips', description: 'Next-gen processors promise 40% performance improvement.', source: 'TechCrunch' },
                { title: 'Apple Stock Hits New High', description: 'AAPL stock closes at record level amid positive earnings.', source: 'MarketWatch' },
            ],
            'MICROSOFT': [
                { title: 'Microsoft-OpenAI Partnership Expands', description: 'Microsoft invests additional billions in OpenAI development.', source: 'Reuters' },
                { title: 'Azure Cloud Services Growing', description: 'Azure revenue surges 29% year-over-year.', source: 'ZDNet' },
                { title: 'Microsoft Beats Earnings Estimates', description: 'MSFT stock rises on strong quarterly results.', source: 'CNBC' },
                { title: 'Copilot AI Integration Widespread', description: 'Microsoft Copilot now available in 100+ enterprise apps.', source: 'VentureBeat' },
                { title: 'Microsoft Teams Reaches 300M Users', description: 'Collaboration platform continues rapid growth.', source: 'The Verge' },
            ],
            'TESLA': [
                { title: 'Tesla Q1 Delivery Numbers Beat Expectations', description: 'Tesla delivers 500K vehicles in first quarter.', source: 'CNBC' },
                { title: 'Tesla Releases New Roadster', description: 'Revolutionary electric sports car announced for 2024.', source: 'Electrek' },
                { title: 'Elon Musk Discusses Gigafactory Expansion', description: 'Tesla plans to build 10 new factories worldwide.', source: 'Reuters' },
                { title: 'Tesla Stock Rallies on Sales Data', description: 'TSLA up 15% after strong delivery reports.', source: 'Seeking Alpha' },
                { title: 'Tesla Battery Tech Breakthrough', description: 'New battery design offers 50% more range.', source: 'TechCrunch' },
            ],
            'GOOGLE': [
                { title: 'Google Announces Gemini 2.0', description: 'Next-gen AI model shows significant improvements.', source: 'Google Blog' },
                { title: 'Google Cloud Growth Accelerates', description: 'Cloud division revenue up 26% year-over-year.', source: 'Cloud Computing Today' },
                { title: 'YouTube Advertising Revenue Surges', description: 'Video platform generates record ad revenue.', source: 'Variety' },
                { title: 'Google Search Updates with AI', description: 'Search results now powered by advanced AI models.', source: 'Search Engine Land' },
                { title: 'Alphabet Beats Earnings Targets', description: 'GOOGL stock rises on strong financial results.', source: 'Yahoo Finance' },
            ],
            'AMAZON': [
                { title: 'AWS Revenue Growth Accelerates', description: 'Cloud services division reports 20% growth.', source: 'AWS News' },
                { title: 'Amazon Prime Membership Hits 200M', description: 'E-commerce and streaming platform reaches milestone.', source: 'The Information' },
                { title: 'Amazon Logistics Network Expands', description: 'Investment in delivery infrastructure continues.', source: 'Supply Chain Dive' },
                { title: 'Amazon Studios Announces Major Productions', description: 'Content budget increased for streaming competitions.', source: 'Deadline' },
                { title: 'AMZN Stock Rally on Earnings Beat', description: 'Amazon reports better-than-expected quarterly results.', source: 'MarketWatch' },
            ],
            'NVIDIA': [
                { title: 'Nvidia GPU Demand at All-Time High', description: 'AI boom drives unprecedented chip demand.', source: 'Semiconductor Industry' },
                { title: 'Nvidia Launches Blackwell Architecture', description: 'Next-gen GPUs offer massive performance gains.', source: 'NVIDIA Blog' },
                { title: 'Nvidia Q1 Revenue Doubles', description: 'Data center segment shows explosive growth.', source: 'CNBC' },
                { title: 'Nvidia Partners with Major Tech Companies', description: 'NVIDIA collaborations expand across industry.', source: 'VentureBeat' },
                { title: 'NVDA Stock Becomes Trillion-Dollar Company', description: 'Market cap milestone reflects AI enthusiasm.', source: 'Bloomberg' },
            ],
            'META': [
                { title: 'Meta AI Research Breakthroughs', description: 'New AI models show dramatic improvements.', source: 'Meta Research' },
                { title: 'Instagram Reels Engagement Soars', description: 'Video format driving platform growth.', source: 'Social Media Today' },
                { title: 'Meta Investments in AR/VR Paying Off', description: 'Reality Labs showing signs of profitability.', source: 'The Information' },
                { title: 'Meta Stock Recovers Strongly', description: 'META up 50% from lows on AI optimism.', source: 'Seeking Alpha' },
                { title: 'Meta Expands Data Center Capacity', description: 'Infrastructure investments support AI growth.', source: 'Data Center Journal' },
            ],
            'NETFLIX': [
                { title: 'Netflix Subscriber Base Hits New Record', description: 'Streaming giant adds 10M new subscribers.', source: 'Netflix Investor Relations' },
                { title: 'Netflix Ad-Supported Tier Growing', description: 'Advertising revenue stream exceeds expectations.', source: 'Variety' },
                { title: 'Netflix Password-Sharing Crackdown Effective', description: 'Account sharing policies boost paid users.', source: 'Bloomberg' },
                { title: 'Netflix Announces New Originals', description: '100+ new shows greenlit for 2024.', source: 'Entertainment Weekly' },
                { title: 'NFLX Stock Reaches New Heights', description: 'Streaming leader continues strong rally.', source: 'Yahoo Finance' },
            ],
            'INTC': [
                { title: 'Intel Announces New Chip Architecture', description: 'Intel unveils next-generation processor design.', source: 'AnandTech' },
                { title: 'Intel Regains Market Share', description: 'INTC processors gain ground in data center market.', source: 'CNBC' },
                { title: 'Intel Foundation Investment Round', description: 'Foundry business attracts major capital.', source: 'Reuters' },
                { title: 'Intel CEO Addresses Challenges', description: 'Leadership discusses competitive landscape.', source: 'Bloomberg' },
                { title: 'INTC Stock Shows Recovery', description: 'Investor sentiment improves on product roadmap.', source: 'MarketWatch' },
            ],
            'AMD': [
                { title: 'AMD Expands AI Chip Portfolio', description: 'New processors target AI and machine learning markets.', source: 'TechCrunch' },
                { title: 'AMD Gains Server Market Share', description: 'EPYC processors popular with cloud providers.', source: 'AnandTech' },
                { title: 'AMD Reports Strong Earnings', description: 'Q1 results exceed analyst expectations.', source: 'Yahoo Finance' },
                { title: 'AMD Technology Day Reveals Roadmap', description: 'Company details future product plans.', source: 'SemiEngineering' },
                { title: 'AMD Stock Momentum Builds', description: 'Market optimism around new product launches.', source: 'Seeking Alpha' },
            ],
            'CRM': [
                { title: 'Salesforce Quarterly Revenue Beats', description: 'Cloud solutions demand drives growth.', source: 'CNBC' },
                { title: 'Salesforce Integrates Einstein AI', description: 'AI features now available across platform.', source: 'TechCrunch' },
                { title: 'Salesforce Announces New Partnerships', description: 'Collaboration agreements expand ecosystem.', source: 'Reuters' },
                { title: 'Salesforce Cloud Growth Accelerates', description: 'Customer adoption of cloud services increasing.', source: 'Cloud Computing Today' },
                { title: 'CRM Stock Reaches New Peak', description: 'Investor confidence in enterprise software.', source: 'MarketWatch' },
            ],
            'JPM': [
                { title: 'JPMorgan Earnings Beat Estimates', description: 'Q1 results show strong investment banking.', source: 'Bloomberg' },
                { title: 'JPMorgan Invests in Blockchain', description: 'Bank explores cryptocurrency and blockchain tech.', source: 'Reuters' },
                { title: 'JPMorgan Expands Wealth Management', description: 'Asset management division shows strong growth.', source: 'CNBC' },
                { title: 'JPMorgan CEO Comments on Economy', description: 'Leadership provides economic outlook.', source: 'Financial Times' },
                { title: 'JPM Stock Rally Continues', description: 'Investors optimistic about bank sector.', source: 'Seeking Alpha' },
            ],
            'BAC': [
                { title: 'Bank of America Quarterly Results', description: 'NET income surges on strong trading.', source: 'CNBC' },
                { title: 'Bank of America Digital Growth', description: 'Mobile banking users reach record high.', source: 'Reuters' },
                { title: 'Bank of America Raises Dividend', description: 'Returns to shareholders increase.', source: 'Yahoo Finance' },
                { title: 'Bank of America Investment Services', description: 'Wealth management revenue accelerates.', source: 'Bloomberg' },
                { title: 'BAC Stock Shows Strength', description: 'Banking sector momentum continues.', source: 'MarketWatch' },
            ],
            'WFC': [
                { title: 'Wells Fargo Posts Strong Earnings', description: 'Q1 net income exceeds expectations.', source: 'Bloomberg' },
                { title: 'Wells Fargo Refinement Plan', description: 'Strategic initiatives drive efficiency.', source: 'Reuters' },
                { title: 'Wells Fargo Commercial Banking Growth', description: 'Lending to businesses increases.', source: 'CNBC' },
                { title: 'Wells Fargo Community Initiatives', description: 'Bank announces charitable contributions.', source: 'Financial Times' },
                { title: 'WFC Stock Gains Ground', description: 'Investor sentiment turns positive.', source: 'Seeking Alpha' },
            ],
            'JNJ': [
                { title: 'Johnson & Johnson Wins FDA Approval', description: 'New drug receives regulatory green light.', source: 'Reuters' },
                { title: 'J&J Pharmaceutical Pipeline Strong', description: 'Multiple drugs in advanced clinical trials.', source: 'CNBC' },
                { title: 'Johnson & Johnson Earnings Beat', description: 'Q1 results show pharma strength.', source: 'Bloomberg' },
                { title: 'J&J Medical Devices Division Grows', description: 'Surgical and diagnostic products performing well.', source: 'Medical Device Today' },
                { title: 'JNJ Stock Reaches New High', description: 'Healthcare sector strength drives gains.', source: 'MarketWatch' },
            ],
            'UNH': [
                { title: 'UnitedHealth Group Revenue Growth', description: 'Healthcare services demand accelerates.', source: 'Reuters' },
                { title: 'UnitedHealth Improves Margins', description: 'Operational efficiency initiatives pay off.', source: 'CNBC' },
                { title: 'UnitedHealth Expands Coverage', description: 'New insurance plans introduced.', source: 'Bloomberg' },
                { title: 'UnitedHealth Technology Innovation', description: 'Telehealth services expand.', source: 'MobiHealthNews' },
                { title: 'UNH Stock Climbs', description: 'Healthcare sector momentum strong.', source: 'Seeking Alpha' },
            ],
            'PFE': [
                { title: 'Pfizer Vaccine Sales Strong', description: 'Respiratory vaccines drive revenue.', source: 'Reuters' },
                { title: 'Pfizer Oncology Pipeline Advances', description: 'Cancer drug candidates show promise.', source: 'CNBC' },
                { title: 'Pfizer Quarterly Earnings Meet Targets', description: 'Consistent performance from major franchises.', source: 'Bloomberg' },
                { title: 'Pfizer CEO Outlines Strategy', description: 'Leadership discusses long-term vision.', source: 'Financial Times' },
                { title: 'PFE Stock Moves Higher', description: 'Pharma sector gains investor interest.', source: 'MarketWatch' },
            ],
            'XOM': [
                { title: 'ExxonMobil Increases Oil Production', description: 'Upstream operations deliver results.', source: 'Reuters' },
                { title: 'ExxonMobil Energy Transition Plans', description: 'Company invests in low-carbon technology.', source: 'Oil & Gas Journal' },
                { title: 'ExxonMobil Earnings Surge', description: 'Q1 profits driven by commodity prices.', source: 'Bloomberg' },
                { title: 'ExxonMobil Shareholder Returns', description: 'Dividends and buybacks continue.', source: 'CNBC' },
                { title: 'XOM Stock Rally Continues', description: 'Energy sector strength benefits majors.', source: 'MarketWatch' },
            ],
            'CVX': [
                { title: 'Chevron Production Hits Target', description: 'Operational excellence drives output.', source: 'Reuters' },
                { title: 'Chevron Cash Flow Strong', description: 'Free cash flow supports returns.', source: 'Bloomberg' },
                { title: 'Chevron Energy Solutions', description: 'Renewables investment accelerates.', source: 'CNBC' },
                { title: 'Chevron Quarterly Results Beat', description: 'Upstream segment shows strength.', source: 'Oil & Gas Journal' },
                { title: 'CVX Stock Trading Higher', description: 'Energy prices support valuations.', source: 'Seeking Alpha' },
            ],
            'F': [
                { title: 'Ford EV Sales Accelerate', description: 'Electric vehicle orders surge.', source: 'Reuters' },
                { title: 'Ford Invests in Battery Plants', description: 'Company expands EV production capacity.', source: 'CNBC' },
                { title: 'Ford Quarterly Earnings Beat', description: 'Profit margins improve on mix.', source: 'Bloomberg' },
                { title: 'Ford CEO Discusses EV Strategy', description: 'Leadership outlines electric future.', source: 'Automotive News' },
                { title: 'F Stock Gains on EV Growth', description: 'Investor enthusiasm for transformation.', source: 'MarketWatch' },
            ],
            'GM': [
                { title: 'General Motors EV Ramp Accelerates', description: 'Ultium battery platform proving successful.', source: 'Reuters' },
                { title: 'GM Partners with Tech Companies', description: 'Collaborations advance autonomous tech.', source: 'CNBC' },
                { title: 'GM Reports Strong Demand', description: 'Order books remain robust.', source: 'Bloomberg' },
                { title: 'GM Battery Technology Improves', description: 'Next-gen cells offer better performance.', source: 'Automotive News' },
                { title: 'GM Stock Climbs Higher', description: 'Auto sector momentum builds.', source: 'Seeking Alpha' },
            ],
            'WMT': [
                { title: 'Walmart Quarterly Sales Beat', description: 'Retail strength across all channels.', source: 'Reuters' },
                { title: 'Walmart E-Commerce Surges', description: 'Online sales accelerate.', source: 'CNBC' },
                { title: 'Walmart Expands Marketplace', description: 'Third-party seller platform growing.', source: 'Bloomberg' },
                { title: 'Walmart Technology Investments', description: 'Supply chain automation pays off.', source: 'Retail Dive' },
                { title: 'WMT Stock Reaches New High', description: 'Defensive retail plays in favor.', source: 'MarketWatch' },
            ],
            'MCD': [
                { title: 'McDonald\'s Same-Store Sales Grow', description: 'Global comparable sales beat expectations.', source: 'Reuters' },
                { title: 'McDonald\'s AI Menu Boards', description: 'Digital ordering drives efficiency.', source: 'CNBC' },
                { title: 'McDonald\'s International Expansion', description: 'New markets opening worldwide.', source: 'Bloomberg' },
                { title: 'McDonald\'s Franchisee Updates', description: 'Franchise system remains strong.', source: 'QSR Magazine' },
                { title: 'MCD Stock Reaches Record', description: 'Consumer staple demand strong.', source: 'Seeking Alpha' },
            ],
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadWatchlistStocks();
            loadEconomicCalendar();
            loadMarketInsights();
            loadLatestNews();
            loadTrendingNews();
            setInterval(refreshPrices, 30000); // Refresh prices every 30 seconds
        });

        // Tab switching
        function switchTab(e, tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            e.target.closest('.tab-btn').classList.add('active');
        }

        // Load watchlist stocks
        async function loadWatchlistStocks() {
            try {
                const response = await fetch('/api/watchlist', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                const stocks = data.items || [];

                const grid = document.getElementById('stockGrid');
                const empty = document.getElementById('emptyWatchlist');

                if (stocks.length === 0) {
                    grid.innerHTML = '';
                    empty.style.display = 'block';
                    return;
                }

                empty.style.display = 'none';
                grid.innerHTML = stocks.map(stock => `
                    <div class="stock-card">
                        <div class="stock-header">
                            <div>
                                <div class="stock-symbol">${stock.symbol}</div>
                                <div class="stock-name">${stock.name || stock.symbol}</div>
                            </div>
                            <button class="btn-remove" onclick="removeStock('${stock.symbol}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="stock-price">$<span id="price-${stock.symbol}">${stock.price || '0.00'}</span></div>
                        <div class="stock-change">
                            <span class="change-amount" id="change-${stock.symbol}">
                                <i class="fas fa-arrow-up change-positive"></i> +0.00%
                            </span>
                        </div>
                        <button class="btn-view-chart" onclick="viewChart('${stock.symbol}')">
                            View Chart <i class="fas fa-chart-line"></i>
                        </button>
                    </div>
                `).join('');

                // Fetch live prices
                for (const stock of stocks) {
                    updateStockPrice(stock.symbol);
                }
            } catch (error) {
                console.error('Error loading watchlist:', error);
            }
        }

        // Update stock price
        async function updateStockPrice(symbol) {
            try {
                const response = await fetch(`/api/quote/${symbol}`);
                const data = await response.json();
                
                const price = data.price || data.c || data.lastPrice || data.currentPrice || 0;
                const change = data.change || 0;
                const changePercent = data.changePercent || 0;

                const priceEl = document.getElementById(`price-${symbol}`);
                const changeEl = document.getElementById(`change-${symbol}`);

                if (priceEl) priceEl.textContent = (price || 0).toFixed(2);
                if (changeEl) {
                    const changeClass = change >= 0 ? 'change-positive' : 'change-negative';
                    const icon = change >= 0 ? 'arrow-up' : 'arrow-down';
                    changeEl.innerHTML = `<i class="fas fa-${icon} ${changeClass}"></i> ${change >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                }
            } catch (error) {
                console.error(`Error fetching price for ${symbol}:`, error);
            }
        }

        // Refresh all prices
        function refreshPrices() {
            const symbols = Array.from(document.querySelectorAll('.stock-card')).map(card => 
                card.querySelector('.stock-symbol').textContent
            );
            symbols.forEach(symbol => updateStockPrice(symbol));
        }

        // Remove stock from watchlist
        async function removeStock(symbol) {
            try {
                await fetch(`/watchlist/${symbol}`, { method: 'DELETE' });
                loadWatchlistStocks();
            } catch (error) {
                console.error('Error removing stock:', error);
            }
        }

        // View chart
        function viewChart(symbol) {
            window.location.href = `/chart/${symbol}`;
        }

        // Add stock modal
        function openAddStockModal() {
            document.getElementById('addStockModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function addStockFromModal() {
            const symbol = document.getElementById('stockSymbolInput').value.toUpperCase();
            if (!symbol) return alert('Please enter a stock symbol');

            try {
                await fetch('/watchlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                closeModal('addStockModal');
                document.getElementById('stockSymbolInput').value = '';
                loadWatchlistStocks();
            } catch (error) {
                console.error('Error adding stock:', error);
            }
        }

        // Load economic calendar
        function loadEconomicCalendar() {
            renderCalendarEvents(economicEvents);
        }

        function filterByImpact(impact) {
            currentFilter = impact;
            document.querySelectorAll('.impact-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const filtered = impact === 'all' ? economicEvents : 
                           economicEvents.filter(e => e.impact === impact);
            renderCalendarEvents(filtered);
        }

        function renderCalendarEvents(events) {
            const eventsList = document.getElementById('eventsList');
            eventsList.innerHTML = events.map(event => `
                <div class="event-item">
                    <div class="event-details">
                        <h4>${event.event}</h4>
                        <p>${event.date} | ${event.country}</p>
                        <p>Forecast: ${event.forecast} | Previous: ${event.previous}</p>
                    </div>
                    <div class="event-impact impact-${event.impact}">${event.impact.toUpperCase()}</div>
                </div>
            `).join('');
        }

        // Load market insights
        function loadMarketInsights() {
            renderInsights(marketInsights);
        }

        function filterBySentiment(sentiment) {
            currentSentimentFilter = sentiment;
            document.querySelectorAll('.sentiment-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const filtered = sentiment === 'all' ? marketInsights : 
                           marketInsights.filter(i => i.sentiment === sentiment);
            renderInsights(filtered);
        }

        function renderInsights(insights) {
            const grid = document.getElementById('insightsGrid');
            grid.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-title">${insight.title}</div>
                    <div style="margin-bottom: 10px;">
                        <span style="display: inline-block; padding: 4px 8px; background: var(--tertiary-bg); border-radius: 4px; font-size: 0.85rem; color: var(--accent);">
                            ${insight.sentiment.toUpperCase()}
                        </span>
                    </div>
                    <div class="insight-text">${insight.content}</div>
                </div>
            `).join('');
        }

        // Load latest news
        async function loadLatestNews() {
            const list = document.getElementById('latestNewsList');
            try {
                // Fetch real news from high-volume stocks for latest market news
                const tickers = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'NVDA', 'TSLA', 'META', 'NFLX', 'JPM', 'V'];
                const allArticles = [];

                for (const ticker of tickers) {
                    try {
                        const response = await fetch(`/api/news/${ticker}`);
                        const articles = await response.json();
                        if (articles && articles.length > 0) {
                            allArticles.push(...articles);
                        }
                    } catch (e) {
                        console.warn(`Error fetching news for ${ticker}`);
                    }
                }

                if (allArticles.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No news available at the moment.</p>';
                    return;
                }

                // Display top 5 most recent articles
                const newsHtml = allArticles
                    .slice(0, 5)
                    .map((article, index) => `
                    <div class="news-item" id="latest-news-${index}">
                        <div class="news-header">
                            <h4>${article.title}</h4>
                            <span class="news-source">${article.source}</span>
                        </div>
                        <p>${article.description}</p>
                        <div class="news-actions">
                            <button class="btn-analyze-news" onclick="analyzeNewsArticle(${index}, '${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">
                                <i class="fas fa-brain"></i> Analyse
                            </button>
                            <button class="btn-save-news" id="save-latest-${index}" style="display: none;" onclick="saveNewsAsAnalysis('${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">
                                <i class="fas fa-bookmark"></i> Save Analysis
                            </button>
                        </div>
                        <div class="analysis-result" id="analysis-latest-${index}" style="display: none;"></div>
                    </div>
                `).join('');

                list.innerHTML = newsHtml;
            } catch (error) {
                console.error('Error loading latest news:', error);
                list.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading latest news.</p>';
            }
        }

        // Load trending news of the day
        async function loadTrendingNews() {
            const list = document.getElementById('trendingNewsList');
            try {
                // Fetch news from trending stocks today
                const trendingTickers = ['NVDA', 'PLTR', 'DDOG', 'NET', 'COIN', 'MSTR', 'ARM', 'SMCI'];
                const allTrendingArticles = [];

                for (const ticker of trendingTickers) {
                    try {
                        const response = await fetch(`/api/news/${ticker}`);
                        const articles = await response.json();
                        if (articles && articles.length > 0) {
                            // Add ticker to article for reference
                            articles.forEach(art => art.ticker = ticker);
                            allTrendingArticles.push(...articles);
                        }
                    } catch (e) {
                        console.warn(`Error fetching trending news for ${ticker}`);
                    }
                }

                if (allTrendingArticles.length === 0) {
                    list.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No trending news available at the moment.</p>';
                    return;
                }

                // Get the most trending article (first from trending stocks)
                const trendingArticle = allTrendingArticles[0];

                // Display single trending article with trending styling
                const trendingArticleHtml = `
                    <div class="news-item trending-news-item" id="trending-news-0">
                        <div style="position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #ff6b35, #d63031); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">
                             Trending Today
                        </div>
                        <div class="news-header">
                            <h4>${trendingArticle.title}</h4>
                            <span class="news-source">${trendingArticle.source}</span>
                        </div>
                        <p>${trendingArticle.description}</p>
                        <div class="news-actions">
                            <button class="btn-analyze-news" onclick="analyzeNewsArticle(0, '${trendingArticle.title.replace(/'/g, "\\'")}', '${trendingArticle.description.replace(/'/g, "\\'")}')">
                                <i class="fas fa-brain"></i> Analyse
                            </button>
                            <button class="btn-save-news" id="save-trending-0" style="display: none;" onclick="saveNewsAsAnalysis('${trendingArticle.title.replace(/'/g, "\\'")}', '${trendingArticle.description.replace(/'/g, "\\'")}')">
                                <i class="fas fa-bookmark"></i> Save Analysis
                            </button>
                        </div>
                        <div class="analysis-result" id="analysis-trending-0" style="display: none;"></div>
                    </div>
                `;

                list.innerHTML = trendingArticleHtml;
            } catch (error) {
                console.error('Error loading trending news:', error);
                list.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading trending news.</p>';
            }
        }

        // Search news
        async function searchNews() {
            const query = document.getElementById('newsSearch').value.trim().toUpperCase();
            if (!query) return alert('Please enter a ticker or company name');

            const newsList = document.getElementById('newsList');
            newsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Searching news...</p>';

            try {
                // Call backend API with the ticker
                const response = await fetch(`/api/news/${query}`);
                const articles = await response.json();
                
                if (!articles || articles.length === 0) {
                    newsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No news found.</p>';
                    return;
                }

                newsList.innerHTML = articles.slice(0, 5).map((article, index) => `
                    <div class="news-item" id="news-${index}">
                        <div class="news-header">
                            <h4>${article.title}</h4>
                            <span class="news-source">${article.source}</span>
                        </div>
                        <p>${article.description}</p>
                        <div class="news-actions">
                            <button class="btn-analyze-news" onclick="analyzeNewsArticle(${index}, '${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">
                                <i class="fas fa-brain"></i> Analyse
                            </button>
                            <button class="btn-save-news" id="save-btn-${index}" style="display: none;" onclick="saveNewsAsAnalysis('${article.title.replace(/'/g, "\\'")}', '${article.description.replace(/'/g, "\\'")}')">
                                <i class="fas fa-bookmark"></i> Save Analysis
                            </button>
                        </div>
                        <div class="analysis-result" id="analysis-${index}" style="display: none;"></div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error fetching news:', error);
                newsList.innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading news. Please try again.</p>';
            }
        }

        // Allow Enter key to search
        window.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && document.activeElement.id === 'newsSearch') {
                searchNews();
            }
        });

        // Save news article as analysis
        // Analyze news article sentiment
        async function analyzeNewsArticle(index, title, description) {
            const analysisDiv = document.getElementById(`analysis-${index}`);
            const analyzeBtn = event.target.closest('.btn-analyze-news');
            
            analysisDiv.innerHTML = '<p style="color: var(--text-secondary); text-align: center; margin-top: 10px;">Analyzing sentiment...</p>';
            
            try {
                const response = await fetch('/api/analyze-sentiment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: description,
                        title: title
                    })
                });
                
                const result = await response.json();
                
                // Color coding based on sentiment
                let sentimentColor = '#00eaff'; // neutral (cyan)
                let sentimentIcon = '';
                
                if (result.sentiment === 'POSITIVE') {
                    sentimentColor = '#00ff41';
                    sentimentIcon = '';
                } else if (result.sentiment === 'NEGATIVE') {
                    sentimentColor = '#ff4466';
                    sentimentIcon = '';
                }
                
                analysisDiv.innerHTML = `
                    <div class="sentiment-analysis" style="margin-top: 15px; padding: 12px; background: rgba(0, 234, 255, 0.1); border-radius: 6px; border: 1px solid ${sentimentColor};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <span style="font-weight: bold; color: ${sentimentColor}; font-size: 1.1em;">${sentimentIcon} ${result.sentiment}</span>
                                <span style="color: var(--text-secondary); margin-left: 10px;">Confidence: ${result.confidence.toFixed(1)}%</span>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; font-size: 0.85rem;">
                            <div style="background: rgba(0, 255, 65, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                <span style="color: #00ff41;">Positive</span><br>
                                <span style="color: var(--text-secondary);">${result.scores.positive.toFixed(1)}%</span>
                            </div>
                            <div style="background: rgba(0, 234, 255, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                <span style="color: var(--accent);">Neutral</span><br>
                                <span style="color: var(--text-secondary);">${result.scores.neutral.toFixed(1)}%</span>
                            </div>
                            <div style="background: rgba(255, 68, 102, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                <span style="color: #ff4466;">Negative</span><br>
                                <span style="color: var(--text-secondary);">${result.scores.negative.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>
                `;
                
                analysisDiv.style.display = 'block';
                document.getElementById(`save-btn-${index}`).style.display = 'inline-block';
                analyzeBtn.disabled = true;
                analyzeBtn.style.opacity = '0.5';
                
            } catch (error) {
                console.error('Error analyzing sentiment:', error);
                analysisDiv.innerHTML = `<p style="color: var(--danger); text-align: center; margin-top: 10px;">Error analyzing sentiment. Please try again.</p>`;
                analysisDiv.style.display = 'block';
            }
        }

        function saveNewsAsAnalysis(title, description) {
            document.getElementById('analysisTitle').value = title;
            document.getElementById('analysisContent').value = description;
            document.getElementById('analysisNotes').value = '';
            document.getElementById('saveAnalysisModal').classList.add('active');
        }

        // Save analysis modal
        function openSaveAnalysisModal() {
            document.getElementById('saveAnalysisModal').classList.add('active');
        }

        function saveAnalysis() {
            const title = document.getElementById('analysisTitle').value;
            const content = document.getElementById('analysisContent').value;
            const notes = document.getElementById('analysisNotes').value;

            if (!title || !content) return alert('Please fill in all fields');

            const analyses = JSON.parse(localStorage.getItem('analyses') || '[]');
            analyses.push({
                id: Date.now(),
                title,
                content,
                notes,
                isFavorite: false,
                date: new Date().toLocaleDateString()
            });
            localStorage.setItem('analyses', JSON.stringify(analyses));

            closeModal('saveAnalysisModal');
            document.getElementById('analysisTitle').value = '';
            document.getElementById('analysisContent').value = '';
            document.getElementById('analysisNotes').value = '';
            loadSavedAnalyses();
        }

        function loadSavedAnalyses() {
            const analyses = JSON.parse(localStorage.getItem('analyses') || '[]');
            const list = document.getElementById('analysesList');

            if (analyses.length === 0) {
                list.innerHTML = '<div class="empty-state"><p>No saved analyses yet. Search for news and save articles to get started!</p></div>';
                return;
            }

            list.innerHTML = analyses.map(analysis => `
                <div class="analysis-card">
                    <div class="analysis-header">
                        <div>
                            <h4 style="margin: 0; color: var(--accent);">${analysis.title}</h4>
                            <span class="analysis-date">${analysis.date}</span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-favorite-analysis" onclick="toggleFavorite(${analysis.id})" title="Favorite">
                                <i class="fas fa-star" style="color: ${analysis.isFavorite ? '#ffd700' : 'var(--text-secondary)'}; opacity: ${analysis.isFavorite ? '1' : '0.6'};"></i>
                            </button>
                            <button class="btn-edit-analysis" onclick="editAnalysis(${analysis.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete-analysis" onclick="deleteAnalysis(${analysis.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="analysis-content">${analysis.content}</div>
                    ${analysis.notes ? `<div class="analysis-notes"><strong>Notes:</strong> ${analysis.notes}</div>` : ''}
                </div>
            `).join('');
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>
