<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head') %>
    <title>Watchlist</title>
    <style>
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 16px; color: #00D9FF; font-weight: 600; transition: all 0.3s ease; }
        .tab-btn:hover { color: #00FF88; text-shadow: 0 0 10px rgba(0, 255, 136, 0.5); }
        .tab-btn.active { border-bottom: 3px solid #00FF88; color: #00FF88; font-weight: bold; text-shadow: 0 0 15px rgba(0, 255, 136, 0.7); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .container { color: #222; }
        h1, h2, h3 { color: #00FF88; font-weight: 700; text-shadow: 0 0 10px rgba(0, 255, 136, 0.3); }
        .stock-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background: #f9f9f9; }
        .stock-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .stock-symbol { font-weight: bold; font-size: 18px; color: #111; }
        .stock-price { font-size: 24px; font-weight: bold; margin: 10px 0; color: #222; }
        .btn-remove { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: 500; }
        .btn-edit { background: #28a745; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: 500; }
        .btn-primary { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: 500; }
        .btn-delete { background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
        .btn-submit { background: #28a745; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: 500; margin-right: 10px; }
        .btn-cancel { background: #6c757d; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: 500; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 400px; width: 90%; }
        .modal-content h3 { margin-top: 0; color: #111; font-weight: 600; }
        .modal-content p { color: #666; font-size: 14px; }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; color: #222; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; color: #222; font-size: 14px; box-sizing: border-box; }
        .event-item { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px; background: #f9f9f9; color: #222; }
        .event-item strong { color: #111; }
        .event-item p { margin: 5px 0; color: #333; }
        .impact { padding: 3px 8px; border-radius: 3px; font-size: 12px; font-weight: bold; }
        .impact-high { background: #dc3545; color: white; }
        .impact-medium { background: #ffc107; color: #111; }
        .impact-low { background: #28a745; color: white; }
        .change-positive { color: #28a745; font-weight: bold; }
        .change-negative { color: #dc3545; font-weight: bold; }
        .alert-rule-item { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; background: #f9f9f9; color: #222; }
        .insight-card { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px; background: #f9f9f9; color: #222; }
        .insight-card strong { color: #111; }
        .insight-card p { margin: 5px 0; color: #333; }
        .insight-bullish { border-left: 4px solid #28a745; }
        .insight-bearish { border-left: 4px solid #dc3545; }
        .insight-neutral { border-left: 4px solid #6c757d; }
        .news-card { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 4px; background: #f9f9f9; color: #222; }
        .news-card h4 { margin: 0 0 10px 0; color: #111; font-weight: 600; }
        .news-card p { margin: 5px 0; color: #333; }
        .news-source { color: #666; }
        .btn-read { background: #007bff; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; display: inline-block; margin-top: 10px; font-weight: 500; }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <div class="container" style="padding: 20px;">
        <h1>Watchlist</h1>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(event, 'tab-watchlist')">Watchlist</button>
            <button class="tab-btn" onclick="switchTab(event, 'tab-calendar')">Economic Calendar</button>
            <button class="tab-btn" onclick="switchTab(event, 'tab-insights')">Market Insights</button>
            <button class="tab-btn" onclick="switchTab(event, 'tab-alerts')">Price Alerts</button>
        </div>

        <!-- WATCHLIST TAB -->
        <div id="tab-watchlist" class="tab-content active">
            <h2>My Stocks</h2>
            <div style="margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                <h3 style="margin-top: 0;">Add Stock to Watchlist</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="stockInput" placeholder="Enter stock symbol (e.g., AAPL)" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; color: #222;" />
                    <button class="btn-primary" onclick="addStockToWatchlist()">Add Stock</button>
                </div>
            </div>
            <div id="stockGrid"></div>
        </div>

        <!-- CALENDAR TAB -->
        <div id="tab-calendar" class="tab-content">
            <h2>Economic Calendar</h2>
            <div style="margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9; display: flex; gap: 15px;">
                <div style="flex: 1;">
                    <label style="font-weight: 600; color: #222; display: block; margin-bottom: 5px;">Impact Level</label>
                    <select id="impactFilter" onchange="filterEconomicEvents()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="">All Impact Levels</option>
                        <option value="high">üî¥ High Impact</option>
                        <option value="medium">üü° Medium Impact</option>
                        <option value="low">üü¢ Low Impact</option>
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="font-weight: 600; color: #222; display: block; margin-bottom: 5px;">Country</label>
                    <select id="countryFilter" onchange="filterEconomicEvents()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="">All Countries</option>
                        <option value="US">United States (US)</option>
                        <option value="JP">Japan (JP)</option>
                        <option value="EU">European Union (EU)</option>
                        <option value="GB">United Kingdom (GB)</option>
                        <option value="CH">Switzerland (CH)</option>
                        <option value="CA">Canada (CA)</option>
                        <option value="AU">Australia (AU)</option>
                    </select>
                </div>
            </div>
            <div id="economicEventsContainer" style="max-height: 600px; overflow-y: auto;"></div>
        </div>

        <!-- MARKET INSIGHTS TAB -->
        <div id="tab-insights" class="tab-content">
            <h2>Market Insights</h2>
            <div style="margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background: #f9f9f9;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="insightsSearchInput" placeholder="Search for stocks (e.g., AAPL, MSFT, TSLA)..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;" />
                    <button class="btn-primary" onclick="searchMarketInsights()" style="min-width: 100px;">üîç Search</button>
                </div>
                <small style="color: #666; display: block; margin-top: 8px;">üí° Tip: Search for stock symbols to see sentiment analysis + latest news articles</small>
            </div>
            <div id="marketInsightsContainer" style="max-height: 800px; overflow-y: auto;"></div>
        </div>

        <!-- ALERTS TAB -->
        <div id="tab-alerts" class="tab-content">
            <h2>Price Alerts</h2>
            <div style="margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                <h3>Create New Alert</h3>
                <div class="form-group">
                    <label>Stock Symbol</label>
                    <input type="text" id="alertSymbol" placeholder="e.g., AAPL" />
                </div>
                <div class="form-group">
                    <label>Alert Type</label>
                    <select id="alertType">
                        <option value="above">Price Above</option>
                        <option value="below">Price Below</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Threshold Value</label>
                    <input type="number" id="alertThreshold" placeholder="e.g., 150.00" step="0.01" />
                </div>
                <button class="btn-primary" onclick="createAlertRule()">Create Alert</button>
            </div>
            <h3>Your Alerts</h3>
            <div id="alertRulesContainer"></div>
        </div>
    </div>

    <!-- UPDATE STOCK MODAL -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <h3>Update Stock</h3>
            <p>Change <strong id="updateSymbolDisplay">AAPL</strong> to a new stock symbol</p>
            <input type="hidden" id="updateOldSymbol" />
            <div class="form-group">
                <label>New Stock Symbol</label>
                <input type="text" id="updateNewSymbol" placeholder="e.g., TSLA" style="text-transform: uppercase;" />
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-cancel" onclick="closeUpdateModal()">Cancel</button>
                <button class="btn-submit" onclick="updateStockInWatchlist()">Update</button>
            </div>
        </div>
    </div>

    <%- include('partials/footer') %>

    <script>
        // ==================================================
        // INITIALIZATION
        // ==================================================
        document.addEventListener('DOMContentLoaded', function() {
            loadWatchlistStocks();
            loadEconomicCalendar();
            loadMarketInsights();
            refreshAlerts();
            setInterval(refreshPrices, 30000);
        });

        // ==================================================
        // TAB SWITCHING
        // ==================================================
        function switchTab(e, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            e.target.classList.add('active');
        }

        // ==================================================
        // WATCHLIST FUNCTIONS
        // ==================================================
        async function loadWatchlistStocks() {
            try {
                const response = await fetch('/api/watchlist');
                const data = await response.json();
                const stocks = data.items || [];
                const grid = document.getElementById('stockGrid');

                if (stocks.length === 0) {
                    grid.innerHTML = '<p>Your watchlist is empty. Add stocks to get started!</p>';
                    return;
                }

                grid.innerHTML = stocks.map(stock => `
                    <div class="stock-card">
                        <div class="stock-header">
                            <div>
                                <div class="stock-symbol">${stock.symbol}</div>
                                <div>${stock.name || stock.symbol}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-edit" onclick="openUpdateModal('${stock.symbol}')" title="Update symbol">Edit</button>
                                <button class="btn-remove" onclick="removeStock('${stock.symbol}')" title="Remove from watchlist">Remove</button>
                            </div>
                        </div>
                        <div class="stock-price" style="display: flex; align-items: baseline; gap: 10px;">
                            <span id="price-${stock.symbol}" style="font-weight: bold; font-size: 20px;">0.00 USD</span>
                            <span id="change-${stock.symbol}" style="font-size: 16px;">
                                <i class="fas fa-arrow-up"></i> <span class="change-positive">+0.00%</span>
                            </span>
                        </div>
                    </div>
                `).join('');

                stocks.forEach(stock => updateStockPrice(stock.symbol));
            } catch (err) {
                console.error('Error loading watchlist:', err);
            }
        }

        async function updateStockPrice(symbol) {
            try {
                const response = await fetch(`/api/quote/${symbol}`);
                const data = await response.json();
                const price = data.price || data.c || 0;
                const change = data.change || data.d || 0;
                const changePercent = data.changePercent || data.dp || 0;
                const currency = data.currency || 'USD';

                const priceEl = document.getElementById(`price-${symbol}`);
                const changeEl = document.getElementById(`change-${symbol}`);

                if (priceEl) priceEl.textContent = `${(price || 0).toFixed(2)} ${currency}`;
                
                if (changeEl) {
                    // Determine color and icon based on change
                    const isPositive = change >= 0;
                    const icon = isPositive ? 'arrow-up' : 'arrow-down';
                    const className = isPositive ? 'change-positive' : 'change-negative';
                    const sign = isPositive ? '+' : '';
                    
                    // Display percentage with proper formatting
                    const percentDisplay = `${sign}${changePercent.toFixed(2)}%`;
                    
                    changeEl.innerHTML = `
                        <i class="fas fa-${icon}"></i> 
                        <span class="${className}" style="font-weight: bold; font-size: 16px;">
                            ${percentDisplay}
                        </span>
                        <span style="margin-left: 8px; color: #666; font-size: 14px;">
                            (${sign}${Math.abs(change).toFixed(2)} ${currency})
                        </span>
                    `;
                }
            } catch (err) {
                console.error(`Error fetching price for ${symbol}:`, err);
            }
        }

        async function refreshPrices() {
            const stocks = Array.from(document.querySelectorAll('.stock-card')).map(card => 
                card.querySelector('.stock-symbol').textContent
            );
            stocks.forEach(symbol => updateStockPrice(symbol));
        }

        async function removeStock(symbol) {
            if (!confirm(`Remove ${symbol}?`)) return;
            try {
                const response = await fetch(`/api/watchlist/${symbol}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Failed to remove stock (${response.status})`);
                }
                await loadWatchlistStocks();
            } catch (err) {
                console.error('Error removing stock:', err);
                alert('Failed to remove stock: ' + err.message);
            }
        }

        async function openUpdateModal(oldSymbol) {
            document.getElementById('updateOldSymbol').value = oldSymbol;
            document.getElementById('updateNewSymbol').value = '';
            document.getElementById('updateSymbolDisplay').textContent = oldSymbol;
            document.getElementById('updateModal').style.display = 'flex';
        }

        function closeUpdateModal() {
            document.getElementById('updateModal').style.display = 'none';
        }

        async function updateStockInWatchlist() {
            const oldSymbol = document.getElementById('updateOldSymbol').value.trim().toUpperCase();
            const newSymbol = document.getElementById('updateNewSymbol').value.trim().toUpperCase();

            if (!newSymbol) {
                alert('Please enter a new stock symbol');
                return;
            }

            if (oldSymbol === newSymbol) {
                alert('Please enter a different symbol');
                return;
            }

            try {
                const response = await fetch(`/api/watchlist/${oldSymbol}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newSymbol })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to update');
                }

                closeUpdateModal();
                await loadWatchlistStocks();
            } catch (err) {
                console.error('Error updating stock:', err);
                alert('Failed to update stock: ' + err.message);
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeUpdateModal();
        });

        window.addEventListener('click', (e) => {
            const modal = document.getElementById('updateModal');
            if (e.target === modal) closeUpdateModal();
        });

        async function addStockToWatchlist() {
            const symbol = document.getElementById('stockInput').value.trim().toUpperCase();
            if (!symbol) {
                alert('Please enter a stock symbol');
                return;
            }

            // Validate stock symbol format (1-5 uppercase letters)
            if (!/^[A-Z]{1,5}$/.test(symbol)) {
                alert('Invalid stock symbol format. Please use 1-5 letters (e.g., AAPL, TSLA)');
                return;
            }

            try {
                // First, validate that the stock exists by fetching its quote
                console.log(`Validating stock symbol: ${symbol}`);
                const quoteResponse = await fetch(`/api/quote/${symbol}`);
                
                console.log(`Quote response status: ${quoteResponse.status}`);
                
                if (!quoteResponse.ok) {
                    if (quoteResponse.status === 404) {
                        alert(`Invalid stock symbol: "${symbol}" not found. Please enter a valid stock symbol (e.g., AAPL, TSLA, MSFT).`);
                    } else if (quoteResponse.status === 400) {
                        alert(`Invalid stock symbol format. Please use valid stock ticker (e.g., AAPL, TSLA).`);
                    } else {
                        const errorData = await quoteResponse.json().catch(() => ({}));
                        alert(`Cannot validate stock "${symbol}": ${errorData.error || 'Unknown error'}`);
                    }
                    return;
                }

                // Verify we got valid price data
                const quoteData = await quoteResponse.json();
                console.log(`Quote data received:`, quoteData);
                
                // Check if price is valid (use price or c as fallback from different API formats)
                const price = quoteData.price || quoteData.c;
                if (!price || price === 0 || !Number.isFinite(price)) {
                    alert(`Unable to fetch price data for "${symbol}". Please try again or check that the symbol is valid.`);
                    return;
                }

                console.log(`‚úì Stock ${symbol} validated. Price: $${price.toFixed(2)} USD`);

                // Now add to watchlist
                const response = await fetch('/api/watchlist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.error?.includes('already in watchlist') || errorData.error?.includes('DUP')) {
                        alert(`${symbol} is already in your watchlist!`);
                    } else {
                        throw new Error(errorData.error || `Failed to add stock (${response.status})`);
                    }
                    return;
                }
                
                const data = await response.json();
                document.getElementById('stockInput').value = '';
                await loadWatchlistStocks();
                alert(`‚úì ${symbol} added to watchlist successfully!`);
            } catch (err) {
                console.error('Error adding stock:', err);
                alert('Failed to add stock: ' + (err.message || 'Unknown error'));
            }
        }

        // ==================================================
        // CALENDAR FUNCTIONS
        // ==================================================
        let allEconomicEvents = [];
        
        async function loadEconomicCalendar() {
            try {
                const response = await fetch('/api/economic-calendar');
                const data = await response.json();
                allEconomicEvents = data.events || [];
                
                filterEconomicEvents();
            } catch (err) {
                console.error('Error loading calendar:', err);
                document.getElementById('economicEventsContainer').innerHTML = '<p>Error loading events</p>';
            }
        }
        
        function filterEconomicEvents() {
            const impactFilter = document.getElementById('impactFilter')?.value || '';
            const countryFilter = document.getElementById('countryFilter')?.value || '';
            const container = document.getElementById('economicEventsContainer');
            
            let filtered = allEconomicEvents;
            
            if (impactFilter) {
                filtered = filtered.filter(event => 
                    (event.impact || 'low').toLowerCase() === impactFilter.toLowerCase()
                );
            }
            
            if (countryFilter) {
                filtered = filtered.filter(event => 
                    (event.country || '').toUpperCase().includes(countryFilter.toUpperCase())
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p>No events match your filters</p>';
                return;
            }
            
            container.innerHTML = filtered.map(event => {
                const impactEmoji = event.impact === 'high' ? 'üî¥' : event.impact === 'medium' ? 'üü°' : 'üü¢';
                return `
                    <div class="event-item" style="border-left: 4px solid ${event.impact === 'high' ? '#dc3545' : event.impact === 'medium' ? '#ffc107' : '#28a745'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #00FF88;">${event.event}</strong>
                            <span class="impact impact-${(event.impact || 'low').toLowerCase()}" style="margin-left: 10px;">
                                ${impactEmoji} ${event.impact || 'Low'}
                            </span>
                        </div>
                        <p style="margin: 8px 0;"><strong style="color: #00D9FF;">üåç ${event.country || 'N/A'}</strong> | <small style="color: #999;">‚è∞ ${new Date(event.eventDate).toLocaleString()}</small></p>
                        <p style="margin: 8px 0; color: #666;"><small>üìä Forecast: <strong>${event.forecast || 'N/A'}</strong> | Previous: <strong>${event.previous || 'N/A'}</strong> | Actual: <strong style="color: ${event.actual ? '#00FF88' : '#999'};">${event.actual || 'Pending'}</strong></small></p>
                    </div>
                `;
            }).join('');
        }


        // ==================================================
        // MARKET INSIGHTS FUNCTIONS (Enhanced with Sentiment + News)
        // ==================================================
        async function loadMarketInsights() {
            try {
                // Always display default stock (AAPL) on initial load
                console.log('üìä Loading Market Insights with default stock AAPL...');
                await displayStockInsight('AAPL');
            } catch (err) {
                console.error('Error loading insights:', err);
                document.getElementById('marketInsightsContainer').innerHTML = '<p style="text-align: center; color: #dc3545;">‚ùå Error loading insights. Please try searching for a stock.</p>';
            }
        }

        async function searchMarketInsights() {
            const symbol = document.getElementById('insightsSearchInput').value.trim().toUpperCase();
            if (!symbol) {
                alert('Please enter a stock symbol');
                return;
            }

            // Validate stock symbol format
            if (!/^[A-Z]{1,5}$/.test(symbol)) {
                alert('Invalid stock symbol format. Please use 1-5 letters (e.g., AAPL, TSLA)');
                return;
            }

            try {
                // First validate stock exists
                const quoteResponse = await fetch(`/api/quote/${symbol}`);
                if (!quoteResponse.ok) {
                    alert(`Invalid stock symbol: "${symbol}" not found. Please enter a valid stock symbol.`);
                    return;
                }

                // Display the stock insight
                await displayStockInsight(symbol);
            } catch (err) {
                console.error('Error searching insights:', err);
                alert('Failed to search: ' + err.message);
            }
        }

        async function displayStockInsight(symbol) {
            const container = document.getElementById('marketInsightsContainer');
            container.innerHTML = `<p style="text-align: center; color: #00D9FF;">üîç Loading sentiment analysis and news for ${symbol}...</p>`;

            try {
                // Fetch sentiment data
                const sentimentResponse = await fetch('/api/analyze-sentiment');
                const sentimentData = await sentimentResponse.json();
                const insights = sentimentData.insights || [];
                const insight = insights.find(i => i.symbol === symbol);

                // Fetch news data with retry logic
                let newsData = { articles: [] };
                let retries = 2;
                while (retries > 0) {
                    try {
                        const newsResponse = await fetch(`/api/news/${symbol}?query=${encodeURIComponent(symbol)}`);
                        newsData = await newsResponse.json();
                        
                        // Check if response is an array (articles)
                        if (Array.isArray(newsData)) {
                            newsData = { articles: newsData };
                        }
                        
                        if (newsData.articles && newsData.articles.length > 0) {
                            break;
                        }
                    } catch (err) {
                        console.log(`News fetch attempt ${3 - retries} failed:`, err.message);
                        retries--;
                        if (retries > 0) {
                            await new Promise(r => setTimeout(r, 500)); // Wait 500ms before retry
                        }
                    }
                }
                
                const articles = Array.isArray(newsData.articles) ? newsData.articles : (newsData.articles ? [newsData.articles] : []);

                // Build combined display
                let html = '';

                // Sentiment Section
                if (insight) {
                    const sentimentColor = insight.sentiment === 'bullish' ? '#28a745' : insight.sentiment === 'bearish' ? '#dc3545' : '#ffc107';
                    const sentimentEmoji = insight.sentiment === 'bullish' ? 'üìà' : insight.sentiment === 'bearish' ? 'üìâ' : '‚û°Ô∏è';
                    
                    html += `
                        <div style="border: 2px solid ${sentimentColor}; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: ${sentimentColor}15;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: ${sentimentColor}; margin: 0; font-size: 24px;">${sentimentEmoji} ${symbol}</h3>
                                <span style="background: ${sentimentColor}; color: white; padding: 8px 12px; border-radius: 20px; font-weight: bold; text-transform: capitalize;">
                                    ${insight.sentiment || 'Neutral'}
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div style="background: white; padding: 12px; border-radius: 6px; border-left: 4px solid ${sentimentColor};">
                                    <p style="margin: 0; color: #666; font-size: 12px; text-transform: uppercase;">Confidence Level</p>
                                    <p style="margin: 5px 0 0 0; color: ${sentimentColor}; font-size: 20px; font-weight: bold;">
                                        ${((insight.confidence || 0) * 100).toFixed(1)}%
                                    </p>
                                </div>
                                <div style="background: white; padding: 12px; border-radius: 6px;">
                                    <p style="margin: 0; color: #666; font-size: 12px; text-transform: uppercase;">Market Analysis</p>
                                    <p style="margin: 5px 0 0 0; color: #333; font-size: 14px;">
                                        ${insight.analysis || 'Pending analysis'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="border: 2px solid #ffc107; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: #ffc10715;">
                            <h3 style="color: #ffc107; margin: 0;">‚û°Ô∏è ${symbol}</h3>
                            <p style="color: #666; margin: 10px 0 0 0;">üìä Sentiment analysis not available. Check latest news instead.</p>
                        </div>
                    `;
                }

                // News Section
                if (articles && articles.length > 0) {
                    html += `<h3 style="color: #00FF88; margin-top: 30px; margin-bottom: 15px;">üì∞ Latest News (${articles.length} articles)</h3>`;
                    
                    html += articles.slice(0, 8).map(article => {
                        const url = article.url || article.link || '#';
                        const isValidUrl = url && (url.startsWith('http://') || url.startsWith('https://'));
                        const source = article.source || article.publisher || 'Financial News';
                        const headline = article.headline || article.title || 'Market Update';
                        const summary = article.summary || article.description || 'Latest financial news';
                        const time = article.datetime ? new Date(article.datetime).toLocaleDateString() : 'Recently';
                        
                        return `
                            <div style="border-left: 4px solid #00D9FF; background: #f9f9f9; padding: 15px; margin-bottom: 12px; border-radius: 4px; transition: all 0.3s ease;" onmouseenter="this.style.background='#f0f9ff'; this.style.boxShadow='0 4px 12px rgba(0,217,255,0.2)';" onmouseleave="this.style.background='#f9f9f9'; this.style.boxShadow='none';">
                                <h4 style="color: #00FF88; margin: 0 0 8px 0; line-height: 1.4; font-size: 15px;">${headline}</h4>
                                <p style="color: #555; margin: 8px 0; line-height: 1.5; font-size: 14px;">${summary.substring(0, 180)}${summary.length > 180 ? '...' : ''}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                    <small style="color: #00D9FF; font-weight: 500;">üì∞ ${source}</small>
                                    <small style="color: #999;">‚è∞ ${time}</small>
                                </div>
                                ${isValidUrl ? `
                                    <a href="${url}" target="_blank" rel="noopener noreferrer" style="background: linear-gradient(135deg, #00D9FF 0%, #00FF88 100%); color: #000; font-weight: 600; margin-top: 10px; display: inline-block; padding: 8px 12px; border-radius: 4px; text-decoration: none; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,255,136,0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">üîó Read Full Article ‚Üí</a>
                                ` : `
                                    <span style="background: #ccc; color: #666; margin-top: 10px; display: inline-block; padding: 8px 12px; border-radius: 4px; cursor: not-allowed;">üîí Link Unavailable</span>
                                `}
                            </div>
                        `;
                    }).join('');
                } else {
                    html += `<div style="background: #f9f9f9; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-top: 20px;">
                        <p style="color: #666; margin: 0;">üì∞ No news articles found for ${symbol} at the moment. Please try another stock or check back later!</p>
                    </div>`;
                }

                container.innerHTML = html;
            } catch (err) {
                console.error('Error displaying insight:', err);
                document.getElementById('marketInsightsContainer').innerHTML = `
                    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 4px;">
                        <p style="margin: 0;">‚ùå Error loading data for ${symbol}. Please try again.</p>
                    </div>
                `;
            }
        }

        // ==================================================
        // ALERTS FUNCTIONS
        // ==================================================
        async function refreshAlerts() {
            try {
                const response = await fetch('/api/alerts');
                const data = await response.json();
                const rules = data.rules || [];
                const container = document.getElementById('alertRulesContainer');

                if (rules.length === 0) {
                    container.innerHTML = '<p>No alert rules created</p>';
                    return;
                }

                container.innerHTML = rules.map(rule => `
                    <div class="alert-rule-item">
                        <div>
                            <strong>${rule.symbol}</strong> - ${rule.alertType === 'above' ? 'Price >' : 'Price <'} $${rule.targetPrice}
                            <span style="margin-left: 10px; padding: 3px 8px; border-radius: 3px; background: ${rule.isActive ? '#28a745' : '#6c757d'}; color: white; font-size: 12px;">
                                ${rule.isActive ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <button class="btn-delete" onclick="deleteAlert(${rule.alertId})">Delete</button>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error refreshing alerts:', err);
            }
        }

        async function createAlertRule() {
            const symbol = document.getElementById('alertSymbol').value.trim().toUpperCase();
            const alertType = document.getElementById('alertType').value;
            const alertThreshold = document.getElementById('alertThreshold').value;

            if (!symbol || !alertType || !alertThreshold) {
                alert('Please fill all fields');
                return;
            }

            try {
                const response = await fetch('/api/alerts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, alertType, targetPrice: parseFloat(alertThreshold) })
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to create alert');
                }
                document.getElementById('alertSymbol').value = '';
                document.getElementById('alertThreshold').value = '';
                await refreshAlerts();
            } catch (err) {
                console.error('Error creating alert:', err);
                alert('Failed to create alert: ' + err.message);
            }
        }

        async function deleteAlert(alertId) {
            if (!confirm('Delete this alert?')) return;
            try {
                const response = await fetch(`/api/alerts/${alertId}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete');
                await refreshAlerts();
            } catch (err) {
                console.error('Error deleting alert:', err);
                alert('Failed to delete alert');
            }
        }
    </script>
</body>
</html>
