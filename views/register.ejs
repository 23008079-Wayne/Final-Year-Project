<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head') %>
  <title>Register - Marketmind</title>
</head>
<body>

  <%- include('partials/navbar') %>

  <div class="container mt-5 mb-5" style="max-width: 600px;">
    <div class="auth-container">
      <h2>Create Your Account</h2>

      <%- include('partials/messages') %>

      <form action="/register" method="POST">
        
        <div class="mb-3">
          <label class="form-label">Full Name</label>
          <input type="text" name="fullName" id="fullNameInput" class="form-control" placeholder="Enter your full name (letters only)" pattern="^[A-Za-z\s]+$" title="Full name should only contain letters and spaces">
        </div>

        <div class="mb-3">
          <label class="form-label">Username</label>
          <input type="text" name="username" class="form-control" required placeholder="Choose a username">
        </div>

        <div class="mb-3">
          <label class="form-label">Email Address</label>
          <input type="text" name="email" id="emailInput" class="form-control" required placeholder="Enter your Gmail address (must be @gmail.com)" title="Email must be a Gmail address (@gmail.com)">
        </div>

        <div class="mb-3">
          <label class="form-label">Password</label>
          <input 
            type="password" 
            name="password" 
            id="password"
            class="form-control" 
            required 
            minlength="8"
            pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
            title="Password must be at least 8 characters, and include uppercase, lowercase, number, and special character."
            placeholder="Create a password">
          <small class="text-muted d-block mt-2">
            Must be at least 8 characters with uppercase, lowercase, number, and special character
          </small>

          <!-- Password strength meter -->
          <div class="mt-3">
            <div class="progress" style="height: 6px; background-color: #e2e8f0;">
              <div 
                id="passwordStrengthBar" 
                class="progress-bar" 
                role="progressbar" 
                style="width: 0%; background-color: #ef4444;"></div>
            </div>
            <small id="passwordStrengthText" class="text-muted d-block mt-1"></small>
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label">Confirm Password</label>
          <input 
            type="password" 
            name="confirmPassword" 
            id="confirmPassword"
            class="form-control" 
            required 
            placeholder="Confirm your password">
          <small id="passwordMatchText" class="text-muted d-block mt-1"></small>
        </div>

        <!-- RISK PROFILING SECTION -->
        <hr class="my-4">
        <h5 class="mb-3">Investment Profile Questionnaire</h5>

        <div class="mb-3">
          <label class="form-label">What is your risk tolerance?</label>
          <select name="riskTolerance" class="form-select" required>
            <option value="">-- Select your risk tolerance --</option>
            <option value="conservative">Conservative - Prefer stable, low-risk investments</option>
            <option value="moderate">Moderate - Willing to take some risk for growth</option>
            <option value="aggressive">Aggressive - Comfortable with high-risk, high-reward investments</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">What is your investment experience?</label>
          <select name="investmentExperience" class="form-select" required>
            <option value="">-- Select your experience level --</option>
            <option value="beginner">Beginner - New to investing</option>
            <option value="intermediate">Intermediate - Some investing experience</option>
            <option value="advanced">Advanced - Extensive investing knowledge</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">What is your age? <span class="text-danger">*</span></label>
          <input type="number" name="age" class="form-control" placeholder="Enter your age" min="18" max="120" required>
          <small class="text-muted d-block mt-1">You must be at least 18 years old to register</small>
        </div>

        <div class="mb-3">
          <label class="form-label">What is your annual income level?</label>
          <select name="annualIncome" class="form-select">
            <option value="">-- Select your income range --</option>
            <option value="below-30k">Below $30,000</option>
            <option value="30k-60k">$30,000 - $60,000</option>
            <option value="60k-100k">$60,000 - $100,000</option>
            <option value="100k-200k">$100,000 - $200,000</option>
            <option value="above-200k">Above $200,000</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">What is your estimated net worth?</label>
          <input type="number" name="netWorth" step="0.01" class="form-control" placeholder="Enter your estimated net worth ($)" min="0">
        </div>

        <div class="mb-3">
          <label class="form-label">What is your primary investment goal?</label>
          <select name="investmentGoal" class="form-select" required>
            <option value="">-- Select your goal --</option>
            <option value="wealth-accumulation">Wealth Accumulation</option>
            <option value="retirement-planning">Retirement Planning</option>
            <option value="income-generation">Income Generation</option>
            <option value="capital-appreciation">Capital Appreciation</option>
            <option value="short-term-gains">Short-term Gains</option>
            <option value="diversification">Diversification</option>
          </select>
        </div>

        <div class="mb-4">
          <label class="form-label">What is your investment time horizon?</label>
          <select name="timeHorizon" class="form-select" required>
            <option value="">-- Select your time horizon --</option>
            <option value="short-term">Short-term (Less than 3 years)</option>
            <option value="medium-term">Medium-term (3-7 years)</option>
            <option value="long-term">Long-term (7+ years)</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary w-100">Create Account</button>
      </form>

      <div class="form-divider">or</div>

      <p class="text-center">
        Already have an account? <a href="/login">Sign in here</a>
      </p>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Password strength + match JS -->
  <script>
    (function () {
      const passwordInput = document.getElementById('password');
      const confirmInput = document.getElementById('confirmPassword');
      const strengthBar = document.getElementById('passwordStrengthBar');
      const strengthText = document.getElementById('passwordStrengthText');
      const matchText = document.getElementById('passwordMatchText');

      if (!passwordInput || !strengthBar) return;

      function evaluateStrength(password) {
        let score = 0;
        if (!password) return 0;

        if (password.length >= 8) score++;
        if (/[a-z]/.test(password)) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/\d/.test(password)) score++;
        if (/[@$!%*?&]/.test(password)) score++;

        return score;
      }

      function updateStrengthMeter() {
        const pwd = passwordInput.value;
        const score = evaluateStrength(pwd);

        let width = 0;
        let label = '';
        let barColor = '#ef4444';

        if (score <= 1) {
          width = 20;
          label = 'Very weak';
          barColor = '#ef4444';
        } else if (score === 2) {
          width = 40;
          label = 'Weak';
          barColor = '#ef4444';
        } else if (score === 3) {
          width = 60;
          label = 'Moderate';
          barColor = '#f59e0b';
        } else if (score === 4) {
          width = 80;
          label = 'Strong';
          barColor = '#10b981';
        } else if (score >= 5) {
          width = 100;
          label = 'Very strong';
          barColor = '#10b981';
        }

        strengthBar.style.width = width + '%';
        strengthBar.style.backgroundColor = barColor;
        strengthText.textContent = pwd ? ('Strength: ' + label) : '';
        strengthText.style.color = barColor;
      }

      function updateMatchText() {
        const pwd = passwordInput.value;
        const confirm = confirmInput.value;

        if (!confirm && !pwd) {
          matchText.textContent = '';
          matchText.className = 'text-muted d-block mt-1';
          return;
        }

        if (pwd && confirm && pwd === confirm) {
          matchText.textContent = '✓ Passwords match';
          matchText.className = 'text-success d-block mt-1';
          matchText.style.color = '#10b981';
        } else if (confirm) {
          matchText.textContent = '✗ Passwords do not match';
          matchText.className = 'text-danger d-block mt-1';
          matchText.style.color = '#ef4444';
        }
      }

      passwordInput.addEventListener('input', function () {
        updateStrengthMeter();
        updateMatchText();
      });

      if (confirmInput) {
        confirmInput.addEventListener('input', updateMatchText);
      }

      // Restrict full name to letters and spaces only
      const fullNameInput = document.getElementById('fullNameInput');
      if (fullNameInput) {
        fullNameInput.addEventListener('input', function (e) {
          // Remove any character that is not a letter or space
          this.value = this.value.replace(/[^A-Za-z\s]/g, '');
        });
      }

      // Restrict email to gmail.com only
      const emailInput = document.getElementById('emailInput');
      if (emailInput) {
        emailInput.addEventListener('input', function (e) {
          let value = this.value.toLowerCase();
          
          // Remove any character that's not valid for email
          value = value.replace(/[^a-z0-9@._+-]/g, '');
          
          // Only allow one @ symbol
          const atCount = (value.match(/@/g) || []).length;
          if (atCount > 1) {
            const parts = value.split('@');
            value = parts[0] + '@' + parts.slice(1).join('');
          }
          
          // If @ exists, ensure domain is gmail.com
          if (value.includes('@')) {
            const [name, domain] = value.split('@');
            if (!domain.startsWith('gmail.com')) {
              if (domain.length > 9) {
                // Keep only gmail.com if user tries to type something else
                this.value = name + '@gmail.com';
              } else {
                // Allow user to type gmail part
                const validDomain = domain.substring(0, 9);
                this.value = name + '@' + validDomain;
              }
            } else {
              this.value = name + '@gmail.com';
            }
          } else {
            this.value = value;
          }
        });
      }

      // Age validation - only allow 18+
      const ageInput = document.querySelector('input[name="age"]');
      const ageErrorText = document.createElement('small');
      ageErrorText.id = 'ageErrorText';
      ageErrorText.className = 'text-danger d-block mt-1';
      ageErrorText.style.display = 'none';
      let lastValidAge = '';
      
      if (ageInput) {
        ageInput.parentNode.appendChild(ageErrorText);

        ageInput.addEventListener('input', function (e) {
          // Only allow numbers
          this.value = this.value.replace(/[^0-9]/g, '');
          
          const age = parseInt(this.value);
          
          if (this.value === '') {
            ageErrorText.textContent = '';
            ageErrorText.style.display = 'none';
            ageInput.style.borderColor = '';
            ageInput.classList.remove('is-invalid');
            lastValidAge = '';
          } else if (age >= 18 && age <= 120) {
            // Age is valid (18-120) - HIDE ERROR AND RED BORDER COMPLETELY
            ageErrorText.textContent = '';
            ageErrorText.style.display = 'none';
            ageInput.style.borderColor = '';
            ageInput.classList.remove('is-invalid');
            lastValidAge = this.value;
          } else if (age < 18) {
            // Show error if below 18
            ageErrorText.textContent = 'You must be at least 18 years old to register';
            ageErrorText.style.display = 'block';
            ageInput.classList.add('is-invalid');
          } else if (age > 120) {
            // Restore last valid value if exceeds 120
            this.value = lastValidAge;
            ageErrorText.textContent = 'Please enter a valid age';
            ageErrorText.style.display = 'block';
            ageInput.classList.add('is-invalid');
          }
        });

        // Validate on form submit
        const form = ageInput.closest('form');
        if (form) {
          form.addEventListener('submit', function (e) {
            const age = parseInt(ageInput.value);
            if (!ageInput.value || isNaN(age) || age < 18 || age > 120) {
              e.preventDefault();
              ageErrorText.textContent = 'You must be at least 18 years old to register';
              ageErrorText.style.display = 'block';
              ageInput.classList.add('is-invalid');
            }
          });
        }
      }
    })();
  </script>
</body>
</html>
