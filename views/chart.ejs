<!DOCTYPE html>
<html lang="en">
<head>
  <title><%= typeof title !== "undefined" ? title : (symbol + " â€“ StockAI Terminal") %></title>
  <%- include("partials/head") %>

  <style>
    :root{
      --nav-height: 64px;
      --ticker-height: 44px;
      --bg:#070707;
      --panel:rgba(18,18,18,.85);
      --border:rgba(255,255,255,.10);
      --soft:rgba(255,255,255,.06);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.60);
      --accent:#00eaff;
      --radius:16px;
      --pos:#34d399;
      --neg:#f87171;
    }

    body{
      margin:0;
      background:
        radial-gradient(1100px 700px at 10% 0%, rgba(0,234,255,.14), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(0,234,255,.08), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:"Inter", Arial, sans-serif;
    }

    /* TICKER (same as home) */
    .ticker-wrap{
      position: sticky;
      top: 0;              /* navbar is inside partial, so ticker sticks below page top */
      z-index: 15;
      height: var(--ticker-height);
      display:flex;
      align-items:center;
      background: rgba(10,10,10,.88);
      border-bottom:1px solid var(--border);
      overflow:hidden;
      white-space:nowrap;
      backdrop-filter: blur(8px);
    }

    .ticker{
      display:inline-flex;
      align-items:center;
      gap:20px;
      padding:10px 28px;
      will-change: transform;
      animation: ticker-scroll 22s linear infinite;
    }

    .ticker-wrap:hover .ticker{ animation-play-state: paused; }

    @keyframes ticker-scroll{
      from{ transform: translateX(0); }
      to{ transform: translateX(-50%); }
    }

    .ticker-item{
      display:inline-flex;
      align-items:baseline;
      gap:10px;
      padding-right:18px;
      border-right:1px solid var(--soft);
      min-width: 210px;
    }

    .ticker-sym{ font-weight:1000; letter-spacing:.2px; }
    .ticker-price{ font-weight:1000; }
    .ticker-chg{ font-weight:900; font-size:12px; }
    .t-up{ color:var(--pos); }
    .t-down{ color:var(--neg); }

    /* PAGE WRAP */
    .container{
      max-width:1200px;
      margin:0 auto;
      padding:18px 28px 24px;
    }

    .panel{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }

    .panel-header{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }

    .panel-header h1{
      margin:0;
      font-size:16px;
      font-weight:1000;
      letter-spacing:.2px;
    }

    .tag{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:rgba(255,255,255,.70);
      background: rgba(0,0,0,.20);
      white-space:nowrap;
    }

    .actions{
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      border-bottom:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.02);
    }

    .muted{
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      text-decoration:none;
      transition:.15s;
      white-space:nowrap;
    }
    .btn:hover{ transform:translateY(-1px); background:rgba(255,255,255,.06); }
    .btn.primary{
      background:var(--accent);
      color:#000;
      border-color:transparent;
    }

    .chart-wrap{
      height: 78vh;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.06);
      background:#0f0f0f;
      margin:14px;
    }

    .footer{
      border-top:1px solid var(--border);
      padding:16px 28px;
      color:var(--muted);
      font-size:12px;
      background: rgba(0,0,0,.35);
      margin-top:18px;
    }

    @media (max-width: 980px){
      .container{ padding:18px 16px 24px; }
      .chart-wrap{ height: 70vh; margin:12px; }
    }
  </style>

  <!-- TradingView -->
  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
</head>

<body>
  <%- include("partials/navbar") %>

  <!-- TICKER -->
  <div class="ticker-wrap" aria-label="Live market ticker">
    <div id="ticker" class="ticker"></div>
  </div>

  <div class="container">
    <div class="panel">
      <div class="panel-header">
        <h1>ðŸ“ˆ <%= symbol %> Chart</h1>
        <span class="tag">View-only</span>
      </div>

      <div class="actions">
        <div class="muted">
          For visualisation and learning only. No trade execution or financial advice.
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn primary" id="buyBtn">Purchase</button>
        </div>
      </div>

      <div class="chart-wrap" id="tv_chart_container"></div>
    </div>

    <div class="footer">
      Data sources: TradingView (interactive charts), Finnhub (live quotes via server API).<br>
      StockAI is a student prototype â€” informational/educational only.
    </div>
  </div>

  <script>
    // TradingView widget
    new TradingView.widget({
      autosize: true,
      symbol: "<%= symbol %>",
      interval: "D",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      locale: "en",
      toolbar_bg: "#070707",
      enable_publishing: false,
      withdateranges: true,
      hide_side_toolbar: false,
      allow_symbol_change: false,
      container_id: "tv_chart_container"
    });
  </script>

  <script>
    // Purchase simulation
    (function(){
      const btn = document.getElementById("buyBtn");
      if(!btn) return;
      btn.addEventListener("click", () => {
        alert("Simulated purchase only.\nNo real trade is executed.");
      });
    })();
  </script>

  <script>
    // TICKER (same endpoint as home)
    (function(){
      const tickerEl = document.getElementById("ticker");
      if(!tickerEl) return;

      const REFRESH_MS = 20000;

      function renderItem(item){
        if(!item || !item.ok){
          return `
            <div class="ticker-item">
              <span class="ticker-sym">${item?.symbol ?? "â€”"}</span>
              <span class="ticker-price">â€”</span>
              <span class="ticker-chg">Unavailable</span>
            </div>
          `;
        }

        const price = Number(item.c);
        const chg   = Number(item.d);
        const pct   = Number(item.dp);

        const up = Number.isFinite(chg) && chg > 0;
        const down = Number.isFinite(chg) && chg < 0;
        const cls = up ? "t-up" : (down ? "t-down" : "");

        const signChg = up ? "+" : "";
        const signPct = up ? "+" : "";

        return `
          <div class="ticker-item">
            <span class="ticker-sym">${item.symbol}</span>
            <span class="ticker-price">${Number.isFinite(price) ? price.toFixed(2) : "â€”"}</span>
            <span class="ticker-chg ${cls}">
              ${Number.isFinite(chg) ? `${signChg}${chg.toFixed(2)}` : "â€”"}
              ${Number.isFinite(pct) ? `(${signPct}${pct.toFixed(2)}%)` : ""}
            </span>
          </div>
        `;
      }

      async function loadTicker(){
        try{
          const r = await fetch(`/api/ticker`);
          if(!r.ok) throw new Error("Ticker API failed");

          const payload = await r.json();
          const rows = Array.isArray(payload?.symbols) ? payload.symbols : [];

          if(rows.length === 0){
            tickerEl.innerHTML = `
              <div class="ticker-item">
                <span class="ticker-sym">Ticker</span>
                <span class="ticker-price">â€”</span>
                <span class="ticker-chg">No data</span>
              </div>
            `;
            return;
          }

          const html = rows.map(renderItem).join("");
          tickerEl.innerHTML = html + html;
        } catch(e){
          tickerEl.innerHTML = `
            <div class="ticker-item">
              <span class="ticker-sym">Ticker</span>
              <span class="ticker-price">â€”</span>
              <span class="ticker-chg">Error loading</span>
            </div>
          `;
        }
      }

      loadTicker();
      setInterval(loadTicker, REFRESH_MS);
    })();
  </script>
</body>
</html>
