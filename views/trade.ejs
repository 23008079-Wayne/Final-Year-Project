<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trade - Marketmind</title>
  <%- include('partials/head') %>

  <style>
    :root {
      --nav-height: 64px;
    }

    body {
      margin: 0;
      background: #0b0b0b;
      color: #eee;
      font-family: "Inter", Arial, sans-serif;
    }

    .hero {
      padding: 32px 28px 16px;
      max-width: 1200px;
      margin: auto;
    }

    .hero h1 {
      margin: 0 0 10px;
      font-size: 32px;
      letter-spacing: 0.2px;
    }

    .hero p {
      margin: 0;
      color: #bdbdbd;
      max-width: 820px;
      line-height: 1.5;
      font-size: 14px;
    }

    .panel {
      background: #121212;
      border: 1px solid #222;
      border-radius: 16px;
      box-shadow: 0 0 18px rgba(255, 255, 255, 0.04);
      overflow: hidden;
      margin: 20px auto;
      max-width: 1200px;
      padding: 24px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid #222;
      padding-bottom: 16px;
    }

    .section-header h2 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.3px;
      color: #eaeaea;
    }

    .btn {
      display: inline-block;
      text-decoration: none;
      font-size: 12px;
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid #2a2a2a;
      color: #ddd;
      background: #111;
      transition: 0.2s;
      font-weight: 600;
      cursor: pointer;
    }

    .btn:hover {
      background: #151515;
      border-color: #00eaff;
    }

    .btn-primary {
      border: 1px solid #00eaff;
      color: #00eaff;
    }

    .btn-primary:hover {
      background: #0f1a1c;
    }

    .trade-form {
      background: #161616;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 16px;
      position: relative;
    }

    .form-group label {
      display: block;
      font-size: 12px;
      color: #bdbdbd;
      margin-bottom: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      background: #0f0f0f;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      color: #eee;
      font-family: "Inter", monospace;
      font-size: 13px;
      transition: 0.2s;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #00eaff;
      box-shadow: 0 0 12px rgba(0, 234, 255, 0.2);
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #0f0f0f;
      border: 1px solid #2a2a2a;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 100;
    }

    .autocomplete-list.active {
      display: block;
    }

    .autocomplete-item {
      padding: 10px 12px;
      border-bottom: 1px solid #1a1a1a;
      cursor: pointer;
      font-size: 13px;
      transition: 0.2s;
    }

    .autocomplete-item:hover {
      background: #1a1a1a;
      color: #00eaff;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .order-type-section {
      background: #0f0f0f;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .order-type-selector {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .order-type-btn {
      padding: 10px 14px;
      border: 1px solid #2a2a2a;
      background: #111;
      border-radius: 8px;
      color: #ddd;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: 0.2s;
    }

    .order-type-btn:hover {
      border-color: #00eaff;
      background: #0f1a1c;
    }

    .order-type-btn.active {
      background: #00eaff;
      color: #000;
      border-color: #00eaff;
    }

    .order-explanation {
      background: #161616;
      padding: 12px 14px;
      border-radius: 8px;
      border-left: 3px solid #00eaff;
      margin-bottom: 15px;
      font-size: 12px;
      color: #ccc;
      display: none;
    }

    .order-explanation.active {
      display: block;
    }

    .warning-badge {
      display: inline-block;
      background: #332200;
      color: #ffb84d;
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .conditional-fields {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #0f0f0f;
      border-radius: 8px;
      border: 1px solid #222;
    }

    .conditional-fields.active {
      display: block;
    }

    .field-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .field-row .form-group {
      flex: 1;
    }

    .field-row .form-group:last-child {
      margin-bottom: 0;
    }

    .form-hint {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      font-style: italic;
    }

    .order-preview {
      background: #1a1a2e;
      border: 1px solid #00eaff;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      display: none;
    }

    .order-preview.active {
      display: block;
    }

    .preview-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #00eaff33;
      font-size: 12px;
      color: #ddd;
    }

    .preview-row:last-child {
      border-bottom: none;
    }

    .preview-label {
      color: #00eaff;
      font-weight: 600;
    }

    .trade-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
    }

    .trade-card {
      background: #161616;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 16px;
      transition: 0.2s;
    }

    .trade-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 24px rgba(0, 234, 255, 0.08);
      border-color: #2a2a2a;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #0f0f0f;
      font-size: 12px;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: #999;
    }

    .info-value {
      color: #ddd;
      font-weight: 600;
      font-family: monospace;
    }

    .footer {
      border-top: 1px solid #222;
      padding: 16px 28px;
      color: #999;
      font-size: 12px;
      background: #0f0f0f;
      text-align: center;
      margin-top: 40px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .info-tooltip {
      display: inline-block;
      width: 16px;
      height: 16px;
      background: #00eaff;
      color: #000;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 11px;
      font-weight: 700;
      cursor: help;
      margin-left: 4px;
    }

    h3 {
      color: #eaeaea;
      font-size: 14px;
      margin: 0 0 12px;
    }
  </style>
</head>

<body>
  <%- include('partials/navbar') %>

  <div class="hero">
    <h1>üí± Advanced Trading</h1>
    <p>Execute sophisticated trades with market, limit, stop-loss, and advanced order types including Iceberg, TWAP, VWAP, and conditional orders.</p>
  </div>

  <main class="panel">
    <div class="section-header">
      <div>
        <h2>Trade Management</h2>
        <span style="font-size: 12px; color: #999;">Live trading interface</span>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 12px; color: #999; margin-bottom: 4px;">Account Balance</div>
        <div style="font-size: 18px; color: #00eaff; font-weight: 600; font-family: monospace;">
          $<span id="tradePageBalance">0.00</span>
        </div>
      </div>
    </div>

    <!-- Stock Search Section -->
    <div class="trade-form">
      <h3>Stock Selection</h3>
      
      <!-- BUY/SELL Selector -->
      <div class="form-group" style="margin-bottom: 20px;">
        <label>Action</label>
        <div style="display: flex; gap: 10px;">
          <button id="buyBtn" class="order-type-btn active" onclick="setTradeAction('buy')" style="flex: 1; padding: 12px;">
            <i class="fas fa-arrow-up"></i> BUY
          </button>
          <button id="sellBtn" class="order-type-btn" onclick="setTradeAction('sell')" style="flex: 1; padding: 12px;">
            <i class="fas fa-arrow-down"></i> SELL
          </button>
        </div>
      </div>

      <!-- Current Holdings (for SELL) -->
      <div id="holdingsInfo" style="display: none; background: #1a1a2e; border: 1px solid #00eaff; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
        <div style="font-size: 12px; color: #00eaff; margin-bottom: 8px;"><strong>Your Holdings:</strong></div>
        <div id="holdingsList" style="font-size: 12px; color: #ddd;"></div>
      </div>
      
      <div class="form-group">
        <label for="symbol">Stock Symbol</label>
        <input type="text" id="symbol" placeholder="Type symbol (e.g., AAPL, NTDOY)" maxlength="5" style="text-transform: uppercase;">
        <div class="autocomplete-list" id="autocompleteList"></div>
        <div class="form-hint" style="margin-top: 4px; color: #666;">Press Enter or wait 500ms to fetch live price</div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="livePrice">Live Price</label>
          <input type="text" id="livePrice" placeholder="$0.00" readonly style="background: #0a0a0a;">
        </div>
        <div class="form-group">
          <label for="quantity">Quantity</label>
          <input type="number" id="quantity" placeholder="Number of shares" min="1" step="1" value="1" oninput="validateQuantity()" onchange="updatePreview()">
        </div>
      </div>
    </div>

    <!-- Order Type Selection -->
    <div class="order-type-section">
      <h3>Order Type Selection</h3>
      
      <div class="order-type-selector">
        <button class="order-type-btn active" onclick="selectOrderType('market')">üìä Market</button>
        <button class="order-type-btn" onclick="selectOrderType('limit')">üìà Limit</button>
        <button class="order-type-btn" onclick="selectOrderType('stoploss')">‚õî Stop-Loss</button>
        <button class="order-type-btn" onclick="selectOrderType('stoplimit')">üõë Stop-Limit</button>
        <button class="order-type-btn" onclick="selectOrderType('trailingstop')">üìâ Trailing Stop</button>
        <button class="order-type-btn" onclick="selectOrderType('trailingstoplimit')">üîÑ Trailing Stop-Limit</button>
      </div>

      <div class="order-type-selector" style="margin-top: 12px; border-top: 1px solid #222; padding-top: 12px;">
        <button class="order-type-btn" onclick="selectOrderType('iceberg')">üèîÔ∏è Iceberg</button>
        <button class="order-type-btn" onclick="selectOrderType('twap')">‚è±Ô∏è TWAP</button>
        <button class="order-type-btn" onclick="selectOrderType('vwap')">üìä VWAP</button>
        <button class="order-type-btn" onclick="selectOrderType('conditional')">‚öôÔ∏è Conditional</button>
        <button class="order-type-btn" onclick="selectOrderType('attached')">üîó Attached</button>
        <button class="order-type-btn" onclick="selectOrderType('oca')">üéØ OCA</button>
      </div>

      <!-- Order Explanations -->
      <div id="market-explanation" class="order-explanation active">
        <strong>Market Order:</strong> Executes immediately at current price. Best for quick purchases. Price guaranteed, execution guaranteed.
      </div>
      <div id="limit-explanation" class="order-explanation">
        <strong>Limit Order:</strong> Executes only if price reaches your limit price or lower. <span class="warning-badge">May not execute</span>
      </div>
      <div id="stoploss-explanation" class="order-explanation">
        <strong>Stop-Loss Order:</strong> Sells if price drops to stop price. Protects against major losses. <span class="warning-badge">May sell at worse price</span>
      </div>
      <div id="stoplimit-explanation" class="order-explanation">
        <strong>Stop-Limit Order:</strong> Combines stop and limit protection. Triggers at stop price, executes within limit range. <span class="warning-badge">May not execute</span>
      </div>
      <div id="trailingstop-explanation" class="order-explanation">
        <strong>Trailing Stop:</strong> Automatically adjusts stop price as price increases. Locks in gains while protecting downside. <span class="warning-badge">Advanced</span>
      </div>
      <div id="trailingstoplimit-explanation" class="order-explanation">
        <strong>Trailing Stop-Limit:</strong> Combines trailing stop with limit protection for maximum control. <span class="warning-badge">Most complex</span>
      </div>
      <div id="iceberg-explanation" class="order-explanation">
        <strong>Iceberg Order:</strong> Large order split into smaller visible portions. Hides total quantity to minimize market impact. <span class="warning-badge">Institutional</span>
      </div>
      <div id="twap-explanation" class="order-explanation">
        <strong>TWAP (Time-Weighted Average Price):</strong> Executes order gradually over time to achieve better average price. <span class="warning-badge">Algorithmic</span>
      </div>
      <div id="vwap-explanation" class="order-explanation">
        <strong>VWAP (Volume-Weighted Average Price):</strong> Executes based on volume to achieve volume-weighted average price. <span class="warning-badge">Algorithmic</span>
      </div>
      <div id="conditional-explanation" class="order-explanation">
        <strong>Conditional Order:</strong> Activates based on specific market conditions (price, volume, etc.). <span class="warning-badge">Rules-based</span>
      </div>
      <div id="attached-explanation" class="order-explanation">
        <strong>Attached Order:</strong> Multiple related orders that depend on each other. If one executes, others activate. <span class="warning-badge">Linked orders</span>
      </div>
      <div id="oca-explanation" class="order-explanation">
        <strong>OCA (One-Cancels-All):</strong> Set of orders where execution of one automatically cancels the others. <span class="warning-badge">Risk management</span>
      </div>

      <!-- Conditional Fields -->
      <div id="limit-fields" class="conditional-fields">
        <div class="form-group">
          <label>Limit Price <span class="info-tooltip">?</span></label>
          <input type="number" id="limitPrice" placeholder="Max price to buy" step="0.01" min="0" oninput="updatePreview()">
          <div class="form-hint">Order executes at this price or lower</div>
        </div>
      </div>

      <div id="stoploss-fields" class="conditional-fields">
        <div class="form-group">
          <label>Stop Price <span class="info-tooltip">?</span></label>
          <input type="number" id="stopPrice" placeholder="Trigger price" step="0.01" min="0" oninput="updatePreview()">
          <div class="form-hint">Triggers when price falls to this level</div>
        </div>
      </div>

      <div id="stoplimit-fields" class="conditional-fields">
        <div class="field-row">
          <div class="form-group">
            <label>Stop Price <span class="info-tooltip">?</span></label>
            <input type="number" id="slStopPrice" placeholder="Trigger price" step="0.01" min="0" oninput="updatePreview()">
          </div>
          <div class="form-group">
            <label>Limit Price <span class="info-tooltip">?</span></label>
            <input type="number" id="slLimitPrice" placeholder="Execution price" step="0.01" min="0" oninput="updatePreview()">
          </div>
        </div>
      </div>

      <div id="trailingstop-fields" class="conditional-fields">
        <div class="field-row">
          <div class="form-group">
            <label>Trailing Amount <span class="info-tooltip">?</span></label>
            <input type="number" id="trailingAmount" placeholder="Distance" step="0.01" min="0" oninput="updatePreview()">
          </div>
          <div class="form-group">
            <label>Unit</label>
            <select id="trailingUnit" oninput="updatePreview()">
              <option value="fixed">Fixed ($)</option>
              <option value="percent">Percentage (%)</option>
            </select>
          </div>
        </div>
      </div>

      <div id="trailingstoplimit-fields" class="conditional-fields">
        <div class="field-row">
          <div class="form-group">
            <label>Trailing Amount</label>
            <input type="number" id="tslAmount" placeholder="Distance" step="0.01" min="0" oninput="updatePreview()">
          </div>
          <div class="form-group">
            <label>Unit</label>
            <select id="tslUnit" oninput="updatePreview()">
              <option value="fixed">Fixed ($)</option>
              <option value="percent">Percentage (%)</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Limit Price Offset</label>
          <input type="number" id="tslOffset" placeholder="Offset" step="0.01" min="0" oninput="updatePreview()">
        </div>
      </div>

      <div id="iceberg-fields" class="conditional-fields">
        <div class="form-group">
          <label>Visible Quantity <span class="info-tooltip">?</span></label>
          <input type="number" id="icebergQty" placeholder="Visible portion" min="1" oninput="updatePreview()">
          <div class="form-hint">Each visible slice before replenishment</div>
        </div>
      </div>

      <div id="twap-fields" class="conditional-fields">
        <div class="field-row">
          <div class="form-group">
            <label>Time Period (minutes)</label>
            <input type="number" id="twapTime" placeholder="60" min="1" oninput="updatePreview()">
          </div>
          <div class="form-group">
            <label>Max Slice Size</label>
            <input type="number" id="twapSlice" placeholder="% of total" step="0.1" min="0.1" max="100" oninput="updatePreview()">
          </div>
        </div>
      </div>

      <div id="vwap-fields" class="conditional-fields">
        <div class="field-row">
          <div class="form-group">
            <label>Max % of Volume</label>
            <input type="number" id="vwapVolume" placeholder="10" step="0.1" min="0.1" max="100" oninput="updatePreview()">
          </div>
        </div>
      </div>

      <div id="conditional-fields" class="conditional-fields">
        <div class="form-group">
          <label>Condition Type</label>
          <select id="conditionType" oninput="updatePreview()">
            <option value="price">Price Condition</option>
            <option value="volume">Volume Condition</option>
            <option value="time">Time Condition</option>
          </select>
        </div>
        <div class="form-group">
          <label>Condition Value</label>
          <input type="text" id="conditionValue" placeholder="e.g., >150 or <100" oninput="updatePreview()">
        </div>
      </div>

      <div id="attached-fields" class="conditional-fields">
        <div class="form-group">
          <label>Attached Order Type</label>
          <select id="attachedType" oninput="updatePreview()">
            <option value="profit">Take Profit</option>
            <option value="loss">Stop Loss</option>
            <option value="both">Both (Bracket)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Target/Stop Price</label>
          <input type="number" id="attachedPrice" placeholder="Trigger price" step="0.01" min="0" oninput="updatePreview()">
        </div>
      </div>

      <div id="oca-fields" class="conditional-fields">
        <div class="form-group">
          <label>Primary Order Type</label>
          <select id="ocaPrimary" oninput="updatePreview()">
            <option value="limit">Limit Buy</option>
            <option value="stop">Stop Sell</option>
          </select>
        </div>
        <div class="form-group">
          <label>Primary Price</label>
          <input type="number" id="ocaPrice" placeholder="Price" step="0.01" min="0" oninput="updatePreview()">
        </div>
      </div>

      <!-- Order Preview -->
      <div id="orderPreview" class="order-preview">
        <h4 style="margin-top: 0; color: #00eaff;">üìã Order Preview</h4>
        <div class="preview-row">
          <span class="preview-label">Type:</span>
          <span id="previewType">Market Order</span>
        </div>
        <div class="preview-row">
          <span class="preview-label">Symbol:</span>
          <span id="previewSymbol">‚Äî</span>
        </div>
        <div class="preview-row">
          <span class="preview-label">Quantity:</span>
          <span id="previewQty">‚Äî</span>
        </div>
        <div class="preview-row">
          <span class="preview-label">Current Price:</span>
          <span id="previewPrice">‚Äî</span>
        </div>
        <div class="preview-row">
          <span class="preview-label">Est. Total:</span>
          <span id="previewTotal">‚Äî</span>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
      <button class="btn btn-primary" onclick="submitTrade()" style="flex: 1;">üì§ Submit Order</button>
      <button class="btn" onclick="clearForm()" style="flex: 1;">Clear</button>
    </div>

    <!-- Active Trades & History -->
    <div style="margin-top: 30px;">
      <div class="section-header">
        <h2>Active Orders</h2>
        <span style="font-size: 12px; color: #999;">Pending</span>
      </div>
      <div class="trade-grid" id="activeTradesContainer">
        <div class="empty-state">
          <p>üöÄ No active orders</p>
          <p style="font-size: 12px; color: #666;">Submit an order to get started</p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>&copy; 2026 Marketmind - Advanced Trading | Educational Purpose Only</p>
  </footer>

  <script>
    let currentOrderType = 'market';
    let tradeAction = 'buy'; // 'buy' or 'sell'
    const stockSymbols = [
      // Tech Giants
      'AAPL', 'MSFT', 'GOOGL', 'GOOG', 'AMZN', 'NVDA', 'META', 'TSLA',
      // FAANG Stocks
      'NFLX', 'PYPL',
      // Cloud & Software
      'CRM', 'ADBE', 'INTU', 'SNPS', 'CDNS', 'WDAY', 'OKTA', 'CRWD',
      // Hardware & Semiconductors
      'AMD', 'INTC', 'QCOM', 'AVGO', 'MU', 'MCHP', 'MPWR', 'LRCX',
      // E-commerce & Payment
      'SHOP', 'SQ', 'COIN', 'HOOD', 'UPST',
      // Social & Media
      'SNAP', 'TWTR', 'ROKU', 'PINS', 'NTNX', 'ZNGA',
      // Telecom & Internet
      'VZ', 'T', 'CMCSA', 'CHTR', 'ATVI', 'EA', 'TTWO', 'RBLX',
      // Financial Tech
      'JPM', 'BAC', 'WFC', 'GS', 'MS', 'SCHW', 'IBKR',
      // Healthcare & Biotech
      'JNJ', 'UNH', 'PFE', 'MRNA', 'BNTX', 'REGN', 'CRSP', 'VEEV',
      // EVs & Auto
      'F', 'GM', 'NIO', 'XPE', 'RIVN', 'LUCID',
      // Entertainment
      'DIS', 'WBD', 'PARA', 'CMCSA',
      // Energy
      'XOM', 'CVX', 'COP',
      // Metals & Mining
      'GLD', 'SLV', 'GOLD', 'AG',
      // Japanese Stocks
      'NTDOY', 'SONY', 'HMC', 'TM',
      // European Stocks
      'ASML', 'SHELL',
      // Trading & Investment
      'PLTR', 'DDOG', 'NET', 'MNDY', 'SNOW', 'DBX', 'BILL',
      // Crypto Related
      'RIOT', 'MARA', 'CLSK', 'HUT', 'MSTR', 'COIN',
      // Misc
      'UBER', 'DASH', 'SPOT', 'ZM', 'TEAM', 'DOC', 'AZO', 'LULU'
    ].sort();

    // Load and display account balance
    async function loadAndDisplayBalance() {
      try {
        const response = await fetch('/api/user-balance');
        const data = await response.json();
        const balance = parseFloat(data.balance) || 0;
        document.getElementById('tradePageBalance').textContent = balance.toLocaleString('en-US', { 
          minimumFractionDigits: 2, 
          maximumFractionDigits: 2 
        });
        console.log('[TRADE] Balance updated: $' + balance.toFixed(2));
      } catch (error) {
        console.error('[TRADE] Error loading balance:', error);
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Load initial balance
      loadAndDisplayBalance();
      
      const symbolInput = document.getElementById('symbol');
      
      // Fetch price when user finishes typing (with debounce)
      let priceTimeout;
      symbolInput.addEventListener('input', function() {
        clearTimeout(priceTimeout);
        handleSymbolInput();
        
        const symbol = this.value.trim().toUpperCase();
        if (symbol.length >= 1) {
          priceTimeout = setTimeout(() => {
            if (symbol.length >= 1) {
              fetchLivePrice(symbol);
            }
          }, 500); // Wait 500ms after user stops typing
        }
      });

      // Allow Enter key to fetch price immediately
      symbolInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          clearTimeout(priceTimeout);
          const symbol = this.value.trim().toUpperCase();
          if (symbol.length >= 1) {
            fetchLivePrice(symbol);
          }
        }
      });
    });

    function handleSymbolInput() {
      const input = document.getElementById('symbol').value.toUpperCase();
      const autocompleteList = document.getElementById('autocompleteList');

      if (input.length === 0) {
        autocompleteList.classList.remove('active');
        return;
      }

      const matches = stockSymbols.filter(sym => sym.startsWith(input)).slice(0, 8);

      if (matches.length > 0) {
        autocompleteList.innerHTML = matches.map(sym => 
          `<div class="autocomplete-item" onclick="selectSymbol('${sym}')">${sym}</div>`
        ).join('');
        autocompleteList.classList.add('active');
      } else {
        autocompleteList.classList.remove('active');
      }
    }

    function selectSymbol(symbol) {
      document.getElementById('symbol').value = symbol;
      document.getElementById('autocompleteList').classList.remove('active');
      fetchLivePrice(symbol);
    }

    async function fetchLivePrice(symbol) {
      const priceInput = document.getElementById('livePrice');
      
      try {
        console.log(`[TRADE] Fetching live price for ${symbol}...`);
        
        const response = await fetch(`/api/quote/${symbol}`);
        console.log(`[TRADE] API response status: ${response.status}`);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error(`[TRADE] API returned HTTP ${response.status}:`, errorData);
          
          if (response.status === 404) {
            priceInput.value = `Invalid Symbol`;
            priceInput.style.color = '#ff9800';
          } else if (response.status === 400) {
            priceInput.value = `Bad Request`;
            priceInput.style.color = '#ff9800';
          } else {
            priceInput.value = `API Error (${response.status})`;
            priceInput.style.color = '#ff6b6b';
          }
          return;
        }

        const data = await response.json();
        console.log('[TRADE] Full API Response:', JSON.stringify(data, null, 2));

        // Try multiple fields that might contain the price
        let price = data.price || data.c || data.lastPrice || data.currentPrice || null;
        
        console.log(`[TRADE] Extracted price value: ${price} (type: ${typeof price})`);
        
        if (typeof price !== 'number') {
          price = parseFloat(price);
        }

        console.log(`[TRADE] Final price value: ${price}, isFinite: ${Number.isFinite(price)}`);

        if (Number.isFinite(price) && price > 0) {
          const formattedPrice = price.toFixed(2);
          priceInput.value = `$${formattedPrice}`;
          priceInput.style.color = '#ddd';
          console.log(`[TRADE] ‚úÖ Price updated: $${formattedPrice}`);
        } else {
          console.warn(`[TRADE] ‚ùå Price is invalid or zero: ${price}`);
          priceInput.value = `$0.00 (No Data)`;
          priceInput.style.color = '#ff9800';
        }
        
        updatePreview();
      } catch (error) {
        console.error('[TRADE] Exception while fetching price:', error.message);
        console.error('[TRADE] Stack:', error.stack);
        priceInput.value = 'Network Error';
        priceInput.style.color = '#ff6b6b';
      }
    }

    function selectOrderType(type) {
      currentOrderType = type;
      
      // Update button styles
      document.querySelectorAll('.order-type-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(type.charAt(0).toUpperCase() + type.slice(1)) || 
            btn.textContent.toLowerCase().includes(type.toLowerCase())) {
          btn.classList.add('active');
        }
      });

      // Hide all explanations and fields
      document.querySelectorAll('.order-explanation').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.conditional-fields').forEach(el => el.classList.remove('active'));

      // Show relevant explanation and fields
      const explanation = document.getElementById(`${type}-explanation`);
      if (explanation) explanation.classList.add('active');

      const fields = document.getElementById(`${type}-fields`);
      if (fields) fields.classList.add('active');

      updatePreview();
    }

    function setTradeAction(action) {
      tradeAction = action;
      
      // Update button styles
      document.getElementById('buyBtn').classList.toggle('active', action === 'buy');
      document.getElementById('sellBtn').classList.toggle('active', action === 'sell');
      
      // Show holdings if selling
      const holdingsInfo = document.getElementById('holdingsInfo');
      if (action === 'sell') {
        holdingsInfo.style.display = 'block';
        loadUserHoldings();
      } else {
        holdingsInfo.style.display = 'none';
      }
      
      updatePreview();
    }

    async function loadUserHoldings() {
      try {
        const response = await fetch('/api/user-holdings');
        const data = await response.json();
        
        const holdingsList = document.getElementById('holdingsList');
        if (data.holdings && data.holdings.length > 0) {
          holdingsList.innerHTML = data.holdings.map(h => 
            `<div style="padding: 4px 0;">‚úì ${h.symbol}: ${h.qty} shares @ avg $${parseFloat(h.avgPrice).toFixed(2)}</div>`
          ).join('');
        } else {
          holdingsList.innerHTML = '<div style="color: #ff6b6b;">No holdings available to sell</div>';
        }
      } catch (error) {
        console.error('Error loading holdings:', error);
        document.getElementById('holdingsList').innerHTML = '<div style="color: #ff6b6b;">Error loading holdings</div>';
      }
    }

    function validateQuantity() {
      const quantityInput = document.getElementById('quantity');
      const currentValue = quantityInput.value;
      
      // If empty, set to 1
      if (currentValue === '' || currentValue === '0') {
        quantityInput.value = '1';
        return;
      }
      
      // Convert to number and check if negative
      const numValue = parseInt(currentValue);
      if (numValue < 1 || isNaN(numValue)) {
        quantityInput.value = '1';
      }
    }

    function updatePreview() {
      const symbol = document.getElementById('symbol').value || '‚Äî';
      const price = parseFloat(document.getElementById('livePrice').value.replace('$', '')) || 0;
      const qty = parseInt(document.getElementById('quantity').value) || 1;
      const total = (price * qty).toFixed(2);

      document.getElementById('previewType').textContent = `${tradeAction.toUpperCase()} - ${currentOrderType.toUpperCase()}`;
      document.getElementById('previewSymbol').textContent = symbol;
      document.getElementById('previewQty').textContent = qty;
      document.getElementById('previewPrice').textContent = `$${price.toFixed(2)}`;
      document.getElementById('previewTotal').textContent = `$${total}`;

      document.getElementById('orderPreview').classList.add('active');
    }

    function submitTrade() {
      const symbol = document.getElementById('symbol').value.trim();
      const qty = document.getElementById('quantity').value;
      const price = document.getElementById('livePrice').value;

      if (!symbol || !qty) {
        alert('Please fill in symbol and quantity');
        return;
      }

      if (price === '$0.00') {
        alert('Please enter a valid stock symbol and wait for price to load');
        return;
      }

      if (tradeAction === 'sell') {
        executeSellTrade(symbol, qty, price);
      } else {
        executeBuyTrade(symbol, qty, price);
      }
    }

    function executeBuyTrade(symbol, qty, price) {
      // Calculate total cost
      const totalCost = parseFloat(price.replace('$', '')) * parseInt(qty);
      
      // Fetch user balance
      fetch('/api/user-balance')
        .then(res => res.json())
        .then(data => {
          const userBalance = parseFloat(data.balance);
          
          if (totalCost > userBalance) {
            alert(`Insufficient funds! You need $${totalCost.toFixed(2)} but only have $${userBalance.toFixed(2)}. Please top up your wallet.`);
            return;
          }

          // Proceed with order if balance is sufficient
          console.log('Buy Order submitted:', {
            type: currentOrderType,
            symbol,
            quantity: qty,
            price: price,
            totalCost: totalCost
          });

          // Deduct balance and save order
          fetch('/api/execute-trade', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              orderType: currentOrderType,
              symbol: symbol,
              quantity: parseInt(qty),
              price: parseFloat(price.replace('$', '')),
              totalCost: totalCost,
              action: 'buy'
            })
          })
          .then(res => {
            if (!res.ok) {
              return res.json().then(data => {
                throw new Error(data.error || 'HTTP error');
              });
            }
            return res.json();
          })
          .then(result => {
            if (result.success) {
              alert(`‚úì BUY order executed!\n${qty} shares of ${symbol} at ${price}\nNew balance: $${parseFloat(result.newBalance).toFixed(2)}`);
              loadAndDisplayBalance();
              clearForm();
            } else {
              alert('Error executing order: ' + result.error);
            }
          })
          .catch(err => {
            console.error('Error:', err);
            alert('Error executing order: ' + err.message);
          });
        })
        .catch(err => {
          console.error('Error fetching balance:', err);
          alert('Error checking account balance');
        });
    }

    function executeSellTrade(symbol, qty, price) {
      // Fetch user holdings to verify they own this stock
      fetch('/api/user-holdings')
        .then(res => res.json())
        .then(data => {
          const holding = data.holdings?.find(h => h.symbol === symbol);
          
          if (!holding) {
            alert(`You don't own any ${symbol} stocks`);
            return;
          }
          
          if (parseFloat(holding.qty) < parseInt(qty)) {
            alert(`You only own ${holding.qty} shares of ${symbol}, but trying to sell ${qty}`);
            return;
          }

          const totalProceeds = parseFloat(price.replace('$', '')) * parseInt(qty);
          
          console.log('Sell Order submitted:', {
            type: currentOrderType,
            symbol,
            quantity: qty,
            price: price,
            totalProceeds: totalProceeds
          });

          // Execute sell trade
          fetch('/api/execute-trade', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              orderType: currentOrderType,
              symbol: symbol,
              quantity: parseInt(qty),
              price: parseFloat(price.replace('$', '')),
              totalCost: totalProceeds,
              action: 'sell'
            })
          })
          .then(res => {
            if (!res.ok) {
              return res.json().then(data => {
                throw new Error(data.error || 'HTTP error');
              });
            }
            return res.json();
          })
          .then(result => {
            if (result.success) {
              alert(`‚úì SELL order executed!\n${qty} shares of ${symbol} at ${price}\nProceeds: $${totalProceeds.toFixed(2)}\nNew balance: $${parseFloat(result.newBalance).toFixed(2)}`);
              loadAndDisplayBalance();
              clearForm();
            } else {
              alert('Error executing order: ' + result.error);
            }
          })
          .catch(err => {
            console.error('Error:', err);
            alert('Error executing order: ' + err.message);
          });
        })
        .catch(err => {
          console.error('Error fetching holdings:', err);
          alert('Error verifying holdings');
        });
    }

    function clearForm() {
      try {
        const symbolEl = document.getElementById('symbol');
        const quantityEl = document.getElementById('quantity');
        const priceEl = document.getElementById('livePrice');
        const limitPriceEl = document.getElementById('limitPrice');
        const stopPriceEl = document.getElementById('stopPrice');
        
        if (symbolEl) symbolEl.value = '';
        if (quantityEl) quantityEl.value = '1';
        if (priceEl) priceEl.value = '$0.00';
        if (limitPriceEl) limitPriceEl.value = '';
        if (stopPriceEl) stopPriceEl.value = '';
        
        const autocompleteList = document.getElementById('autocompleteList');
        if (autocompleteList) autocompleteList.classList.remove('active');
        
        selectOrderType('market');
      } catch (error) {
        console.error('Error clearing form:', error);
      }
    }

    // Close autocomplete when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.form-group')) {
        document.getElementById('autocompleteList').classList.remove('active');
      }
    });
  </script>
</body>
</html>